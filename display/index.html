<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é˜²æ±›é€šå ±ç³»çµ±</title>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getStorage, ref, list, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyA4IZ6yZxlOuIjarWmUtIHGyLk84056K2Q",
  authDomain: "reportsystem-c5fc7.firebaseapp.com",
  projectId: "reportsystem-c5fc7",
  storageBucket: "reportsystem-c5fc7.firebasestorage.app",
  messagingSenderId: "845064058181",
  appId: "1:845064058181:web:31d2f0fa6dfed084befa2c",
  measurementId: "G-EDQM0LWQWH"
};

const app = initializeApp(firebaseConfig);
const storage = getStorage(app);

window.firebaseStorage = { storage, ref, list, listAll, getDownloadURL };
</script>

  <style>
    /* åŸºç¤æ¨£å¼ */
    body { 
        font-family: Arial, sans-serif; 
        margin: 0; 
        padding: 20px; 
        background: #f5f5f5; 
    }
    
    .container { 
        max-width: 800px; 
        margin: 0 auto; 
        background: white; 
        padding: 20px; 
        border-radius: 8px; 
        box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        position: relative;
    }
    
    .header { 
        text-align: center; 
        margin-bottom: 20px; 
        padding-bottom: 15px; 
        border-bottom: 1px solid #ddd; 
    }
    
    .header p {
        font-size: 18px;
        margin: 8px 0;
    }
    
    .back-btn { 
        background: #4285f4; 
        color: white; 
        padding: 10px 15px; 
        border: none; 
        border-radius: 5px; 
        cursor: pointer; 
        margin-bottom: 20px; 
        font-size: 16px;
    }
    
    .report-info p {
        margin: 8px 0;
        font-size: 20px;
    }
    
    /* ç…§ç‰‡ç¶²æ ¼ */
    .photo-gallery { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        margin-bottom: 25px; 
    }

    .photo-item { 
        border-radius: 8px; 
        overflow: hidden; 
        box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
        cursor: pointer; 
        aspect-ratio: 1;
        background-color: #f5f5f5;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .photo-item img { 
        width: 100%; 
        height: 100%; 
        object-fit: cover; 
        display: block;
        transition: transform 0.3s ease;
    }

    .photo-item:hover img {
        transform: scale(1.05);
    }
    
    .audio-player h3 {
  margin-top: 0 !important;   /* ç§»é™¤å¤šé¤˜å¤–è· */
  padding-top: 0 !important;
  font-size: 24px;
}
    
    .transcription-section { 
    background: #f9f9f9;
    padding: 16px 20px;
    border-radius: 8px;
    border: 1px solid #ddd;
    margin-top: 25px;
}
    
    .transcription-text { 
    background: white; 
    padding: 16px; 
    border-radius: 8px; 
    border: 1px solid #eee; 
    margin-top: 10px; 
    white-space: pre-wrap; 
    font-size: 20px;      /* æ”¾å¤§å­—é«” */
    line-height: 1.4;     /* ç¨å¾®ç·Šå¯† */
    max-height: 320px; 
    overflow-y: auto; 
}

    /* ç·¨è¼¯å€åŸŸæ¨£å¼ */
    .transcription-text[contenteditable="true"] {
        border: 2px solid #4285f4;
        background: #f8fbff;
        min-height: 120px;
        padding: 15px;
        border-radius: 8px;
        outline: none;
    }

    .transcription-text[contenteditable="true"]:focus {
        border-color: #0b5ed7;
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }

    /* === ç·¨è¼¯æ¡†ç‹€æ…‹ === */
.transcription-text {
  min-height: 100px;
  transition: background 0.25s ease, border-color 0.25s ease, box-shadow 0.25s ease;
}

/* ç·¨è¼¯ä¸­é«˜äº® */
.transcription-text.editing {
  border: 2px solid #0b5ed7 !important;
  background: #f8fbff !important;
  box-shadow: 0 0 0 2px rgba(11,94,215,0.15);
}

/* === æŒ‰éˆ•å€ === */
#edit-actions {
  display: flex;
  justify-content: center;
  gap: 14px;
  margin-top: 18px;
  transition: opacity 0.25s ease;
}

/* === é»æ“Šèˆ‡ hover è¦–è¦º === */
button:active,
.save-btn:active,
.reset-btn:active,
.nav-btn:active,
.zoom-btn:active,
.btn-primary:active,
.btn-secondary:active,
.back-btn:active {
  filter: brightness(1.2);
  transform: scale(0.98);
}

button:hover,
.save-btn:hover,
.reset-btn:hover,
.nav-btn:hover,
.zoom-btn:hover,
.btn-primary:hover,
.btn-secondary:hover,
.back-btn:hover {
  filter: brightness(1.1);
}

/* === å…¨åŸŸäº’å‹•å›é¥‹èˆ‡ focus ç‹€æ…‹ === */
html, body, button, a, img, div {
  -webkit-tap-highlight-color: rgba(200, 200, 200, 0.3); /* æ‰‹æ©Ÿç°äº®å›é¥‹ */
}

button, a, input, textarea {
  outline: none !important; /* ç§»é™¤è—æ¡†åªé™äº’å‹•å…ƒä»¶ */
  box-shadow: none !important;
}

button:focus,
a:focus,
input:focus,
textarea:focus {
  outline: none !important;
  box-shadow: none !important;
}

    .save-btn, .reset-btn {
  border: none;
  border-radius: 6px;
  cursor: pointer;
  padding: 12px 26px;
  font-size: 20px;
  font-weight: normal;
  transition: background 0.25s ease, transform 0.1s ease;
  color: #fff;
}

/* åˆå§‹ç‹€æ…‹ï¼šæ·±è‰² */
.save-btn {
  background: #0b5ed7; /* æ·±è— */
}

.reset-btn {
  background: #60748f; /* æ·±ç°è— */
}

/* é»æ“Šå¾Œï¼šè®Šäº® */
.save-btn.active {
  background: #4d8dff; /* æ·ºè— */
}

.reset-btn.active {
  background: #9aafc6; /* æ·ºç°è— */
}

/* æ»‘éæ™‚ç¨å¾®æäº® */
.save-btn:hover,
.reset-btn:hover {
  filter: brightness(1.1);
}
    
    .download-link { 
        display: inline-block; 
        margin-top: 10px; 
        color: #4285f4; 
        text-decoration: none; 
        font-weight: bold; 
    }
    
    .download-link:hover { 
        text-decoration: underline; 
    }
    
    .error { 
        text-align: center; 
        color: gray; 
        font-size: 18px; 
        padding: 40px; 
    }
    
    /* æ¨¡æ…‹æ¡†æ¨£å¼ - æ”¹é€²ç‰ˆæœ¬ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        overflow: hidden;
        touch-action: none;
    }

    /* ç¢ºä¿åœ–ç‰‡å®¹å™¨å›ºå®š */
    .modal-content-container {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        cursor: default;
        overflow: hidden;
    }

    .modal-content {
        display: block;
        max-width: 90vw;
        max-height: 80vh;
        object-fit: contain;
        transition: none;
        cursor: default;
        transform-origin: center center;
        will-change: transform;
        user-select: none;
        -webkit-user-drag: none;
    }

    .modal-content.zoomed {
        cursor: grab;
        max-width: none;
        max-height: none;
    }

    .modal-content.zoomed:active {
        cursor: grabbing;
    }

    /* é›»è…¦ç‰ˆèƒŒæ™¯é»æ“Šå€åŸŸ */
    @media (min-width: 769px) {
        .modal-content-container::before,
        .modal-content-container::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 30%;
            background: transparent;
            z-index: 1;
            cursor: pointer;
        }
        
        .modal-content-container::before {
            left: 0;
        }
        
        .modal-content-container::after {
            right: 0;
        }
    }
    
    .close {
        position: absolute;
        top: 25px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001;
        background: rgba(0,0,0,0.5);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s ease;
    }

    .close:hover {
        background: rgba(0,0,0,0.7);
    }
    
    .navigation {
        position: absolute;
        top: 50%;
        width: 100%;
        display: flex;
        justify-content: space-between;
        transform: translateY(-50%);
        pointer-events: none;
        z-index: 3;
    }
    
    .nav-btn {
        background: rgba(0,0,0,0.5);
        color: white;
        border: none;
        padding: 20px 15px;
        font-size: 24px;
        cursor: pointer;
        pointer-events: auto;
        margin: 0 10px;
        border-radius: 5px;
        transition: all 0.3s ease;
        z-index: 4;
    }
    
    .nav-btn.disabled {
        opacity: 0.3;
        cursor: not-allowed;
        pointer-events: none;
    }

    .nav-btn:not(.disabled):hover {
        background: rgba(0,0,0,0.7);
        transform: scale(1.1);
    }
    
    /* è¼‰å…¥ä¸­æ¨£å¼ */
    .loading-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px;
        color: #666;
        grid-column: 1 / -1;
    }
    
    .loading-spinner {
        width: 32px;
        height: 32px;
        border: 3px solid #ccc;
        border-top: 3px solid #0b5ed7;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    
    @keyframes spin { 
        from { transform: rotate(0deg); } 
        to { transform: rotate(360deg); } 
    }
    
    /* é€²åº¦æ¢æ¨£å¼ */
    .progress-bar {
        flex: 1;
        height: 12px;
        background: #eee;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        position: relative;
        max-width: 400px;
    }
    
    .progress-bar:hover {
        background: #e0e0e0;
    }
    
    .progress-fill {
        width: 0%;
        height: 100%;
        background: #0b5ed7;
        transition: width 0.1s ease;
    }
    
    /* é é¢é—œé–‰æŒ‰éˆ• */
    .page-close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        color: #666;
        font-size: 36px;
        font-weight: bold;
        cursor: pointer;
        z-index: 10;
        background: none;
        border: none;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .page-close-btn:hover {
        color: #333;
    }
    
    /* ç…§ç‰‡è¼‰å…¥å„ªåŒ– */
    .photo-item.loading img {
        opacity: 0;
    }
    
    .photo-item.loaded img {
        opacity: 1;
    }

    /* æ‰‹æ©Ÿç‰ˆæ¨£å¼ */
    @media (max-width: 768px) {
        body {
            padding: 10px;
            background: white;
        }
        
        .container {
            padding: 15px;
            border-radius: 0;
            box-shadow: none;
        }
        
        .header h1 {
            font-size: 24px;
        }
        
        .header p {
            font-size: 16px;
        }
        
        .report-info p {
            font-size: 20px;
        }
        
        .back-btn {
            font-size: 18px;
            padding: 12px 20px;
            margin-bottom: 15px;
        }
        
        .modal-content {
            max-width: 95vw;
            max-height: 80vh;
        }
        
        .nav-btn {
            padding: 15px 10px;
            font-size: 20px;
            margin: 0 5px;
        }
        
        .close {
            top: 15px;
            right: 20px;
            width: 40px;
            height: 40px;
            font-size: 30px;
        }
        
        .page-close-btn {
            top: 15px;
            right: 15px;
            font-size: 32px;
        }
        
        /* æ‰‹æ©Ÿç‰ˆç§»é™¤èƒŒæ™¯é»æ“Šå€åŸŸ */
        .modal-content-container::before,
        .modal-content-container::after {
            display: none;
        }
    }

    /* ç¸®æ”¾æ§åˆ¶æŒ‰éˆ• */
    .zoom-controls {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        z-index: 1001;
        background: rgba(0,0,0,0.7);
        padding: 10px 15px;
        border-radius: 25px;
        align-items: center;
    }

    /* åªèª¿æ•´æ‰‹æ©Ÿç«¯ */
    @media (max-width: 768px) {
        .nav-btn {
            padding: 20px 15px;
            font-size: 24px;
            margin: 0 10px;
            border-radius: 5px;
        }
        
        .zoom-controls {
            gap: 16px;
            padding: 14px 20px;
            bottom: 25px;
        }
        
        .zoom-btn {
            width: 44px;
            height: 44px;
            font-size: 20px;
        }
        
        /* å›å¾©åŸç‹€æŒ‰éˆ• */
        .zoom-btn.reset {
            height: 44px;
            padding: 0 16px;
            font-size: 20px !important;
            white-space: nowrap;
            font-weight: normal;
        }
        
        /* æ–‡å­—æŒ‡ç¤ºå™¨ */
        .zoom-indicator {
            min-width: 100px;
            font-size: 20px !important;
            font-weight: normal;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 44px;
            background: transparent;
            color: white;
            border: none;
            box-shadow: none;
            cursor: default;
            pointer-events: none;
        }
        
        /* æ‰‹æ©Ÿç«¯éš±è—åŠ æ¸›æŒ‰éˆ• */
        .zoom-btn:first-child,
        .zoom-btn:last-child {
            display: none;
        }
    }

    .zoom-btn {
        background: rgba(255,255,255,0.2);
        color: white;
        border: none;
        width: 44px;
        height: 44px;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-weight: bold;
    }

    .zoom-btn.reset {
        width: auto;
        padding: 0 15px;
        border-radius: 22px;
        font-size: 14px;
        font-weight: normal;
        display: none;
    }

    .zoom-btn:hover {
        background: rgba(255,255,255,0.4);
        transform: scale(1.1);
    }

    .zoom-indicator {
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 60px;
        font-size: 14px;
        font-weight: normal;
    }

    .footer-actions {
  display: flex;
  gap: 12px;
  margin-top: 40px;
  padding: 12px 16px;
  border-top: 1px solid #e5e5e5;
}

.footer-actions .btn-secondary,
.footer-actions .btn-primary {
  flex: 1;
  height: 48px;
  border-radius: 10px;
  font-size: 20px;
  border: none;
  cursor: pointer;
  background: #e0e0e0;
  color: #333;
}

/* æ‰‹æ©Ÿå„ªåŒ– */
@media (max-width: 768px) {
  .footer-actions {
    margin-top: 24px;
    padding: 12px;
  }

  .footer-actions .btn-secondary,
  .footer-actions .btn-primary {
    height: 52px;
    font-size: 20px;
  }
}

h2 {
  font-size: 24px;
  margin: 0 0 12px 0;
  color: #333;
}

#audio-section,
#photo-section,
#transcription-section {
  background: #f9f9f9;
  padding: 16px 20px;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-top: 25px;
}

#audio-section {
  margin-top: 25px;        /* å›å¾©ç°æ¡†èˆ‡å…¶ä»–æ¡†è·é›¢ */
  padding: 8px 20px 16px;  /* ä¸Šæ–¹å…§è·ç¸®å°ï¼Œå…¶é¤˜ç¶­æŒåŸæ¨£ */
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 8px;
}

@media (min-width: 769px) {
  .footer-actions { display: none !important; }
}

/* === ä¿®å¾©æ‰‹æ©Ÿç…§ç‰‡åªèƒ½çœ‹å‰ä¸‰å¼µå•é¡Œ === */
.photo-item {
  position: relative;
  z-index: 1;
}

#image-modal {
  z-index: 9999 !important;
  overflow: hidden !important;
  touch-action: pan-y pinch-zoom; /* âœ… æ”¹æˆå…è¨±å‚ç›´èˆ‡ç¸®æ”¾ */
}

/* å¼·åˆ¶åœ–ç‰‡æ¯æ¬¡é–‹æ–°åœ–æ™‚åˆ·æ–°ç¹ªè£½å±¤ï¼Œé˜²æ­¢è¢«å‰ä¸€å¼µè¦†è“‹ */
#image-modal img {
  will-change: transform;
  backface-visibility: hidden;
  transform: translateZ(0);
}

.red-btn {
  flex: 1;
  height: 48px;
  border-radius: 10px;
  font-size: 20px;
  background: #d9534f;   /* ç´…è‰² */
  color: #fff;
  border: none;
  cursor: pointer;
}

.red-btn:hover {
  background: #c9302c;
  filter: brightness(1.05);
}
</style>
</head>

<body>
  <div class="container">
    <div class="header">
        <h1>é€šå ±è©³ç´°ç´€éŒ„</h1>
        <p id="report-date">å›å ±æ™‚é–“ï¼šè¼‰å…¥ä¸­...</p>
    </div>

    <div class="report-info">
        <p id="report-type">é€šå ±é¡å‹ï¼šè¼‰å…¥ä¸­...</p>
        <p id="report-status">ç‹€æ…‹ï¼šè¼‰å…¥ä¸­...</p>
        <p id="abnormal-type" style="display:none;">ç•°å¸¸åˆ†é¡ï¼šè¼‰å…¥ä¸­...</p>
        <p id="remarks">èªªæ˜ï¼šè¼‰å…¥ä¸­...</p>
        <p id="transcription-summary" style="display:none;">èªéŸ³è½‰æ–‡å­—ï¼šè¼‰å…¥ä¸­...</p>
        <p id="reporter">å›å ±è€…ï¼šè¼‰å…¥ä¸­...</p>
        <p id="companions">åŒè¡Œè€…ï¼šè¼‰å…¥ä¸­...</p>
        <p id="team">æ‰€å±¬å¤§éšŠï¼šè¼‰å…¥ä¸­...</p>
    </div>

    <div id="photo-section">
      <h2>ç…§ç‰‡</h2>
      <div id="photo-gallery" class="photo-gallery">
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <span class="loading-text">ç…§ç‰‡è¼‰å…¥ä¸­...</span>
        </div>
      </div>
    </div>

    <div id="audio-section" style="display:block;">  <!-- å¼·åˆ¶é¡¯ç¤º -->
  <div class="audio-player">

    <!-- â­ æ–°å¢ï¼šè¼‰å…¥ä¸­å€å¡Š -->
    <div id="audio-loading" style="text-align:center;padding:20px;font-size:18px;color:#666;">
      <h3>èªéŸ³</h3>
      <div class="loading-spinner" style="
        width:28px;height:28px;border:3px solid #ccc;
        border-top:3px solid #0b5ed7;border-radius:50%;
        margin:0 auto 8px;animation:spin 1s linear infinite;">
      </div>
      èªéŸ³è¼‰å…¥ä¸­â€¦
    </div>

    <!-- â­ åŸæ’­æ”¾å™¨ï¼ˆé è¨­å…ˆéš±è—ï¼‰ -->
    <div id="audio-player-container" style="display:none;">
      <h3>èªéŸ³</h3>
      <div style="display:flex;align-items:center;gap:14px;margin:20px 0;max-width:500px;">
        <button id="playBtn" style="
          width:56px;height:56px;border-radius:50%;
          border:none;background:#0b5ed7;color:#fff;
          cursor:pointer;display:flex;align-items:center;justify-content:center;">
          <div id="playIcon" style="
            width:0;height:0;border-top:9px solid transparent;
            border-bottom:9px solid transparent;border-left:16px solid #fff;margin-left:3px;">
          </div>
        </button>
        <span id="timeLabel" style="font-size:19px;color:#333;min-width:45px;">0:00</span>
        <div style="flex:1;height:12px;background:#eee;border-radius:8px;overflow:hidden;cursor:pointer;" id="progressBar">
          <div id="waveFill" style="width:0%;height:100%;background:#0b5ed7;"></div>
        </div>
      </div>
    </div>

    <!-- â­ æ–°å¢ï¼šç„¡èªéŸ³æ™‚é¡¯ç¤º -->
    <div id="audio-empty" style="display:none;text-align:center;padding:20px;font-size:18px;color:#666;">
      æ­¤å›å ±æ²’æœ‰èªéŸ³
    </div>

  </div>
</div>

    <div id="transcription-section" class="transcription-section" style="display:none;">
  <h2>èªéŸ³è½‰æ–‡å­—</h2>
  <div id="transcription-text" class="transcription-text" contenteditable="false"></div>
  <div id="edit-actions" style="margin-top: 15px; display: flex; gap: 10px;">
    <button id="edit-btn" class="save-btn">ä¿®æ”¹</button>
  </div>
</div>

    <!-- ä¿®æ”¹ç¸®æ”¾æ§åˆ¶æŒ‰éˆ• -->
  <div id="image-modal" class="modal">
    <span class="close" onclick="closeModal()">&times;</span>
    <div class="modal-content-container" id="modalContainer">
        <img class="modal-content" id="modal-image">
    </div>
    <div class="navigation">
        <button class="nav-btn" onclick="navigatePhoto(-1)">&#10094;</button>
        <button class="nav-btn" onclick="navigatePhoto(1)">&#10095;</button>
    </div>
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
        <button class="zoom-btn reset" onclick="resetZoom()">å›å¾©åŸç‹€</button>
        <div class="zoom-indicator">100%</div>
        <button class="zoom-btn" onclick="zoomIn()">+</button>
    </div>
  </div>

  <div class="footer-actions" id="footer-back">
  <button class="btn-secondary gray-btn" onclick="handleGoBack()">ç¹¼çºŒå›å ±</button>
  <button class="btn-secondary gray-btn" onclick="closeWindowSafe()">å›ä¸»é¸å–®</button>
</div>
  </div>

   <script>
    let baseScale = 1; // ç”¨ä¾†è¨˜éŒ„åœ–ç‰‡å‰›è¼‰å…¥æ™‚ fit çš„æ¯”ä¾‹
let visualScale = 1; // é¡¯ç¤ºç”¨æ¯”ä¾‹
    let currentIndex = 0, currentPhotoUrls = [], currentReportId = '', pageSource = '';
    let isZoomed = false;
    let currentScale = 1;
    let currentTranslateX = 0, currentTranslateY = 0;
    let isDragging = false;
    let dragStartX = 0, dragStartY = 0;
    let isKeyboardCooldown = false;
    const keyboardCooldownTime = 300;
    // åœ¨é ‚éƒ¨è®Šæ•¸å®£å‘Šå€åŸŸæ·»åŠ 
const zoomLevels = [1.0, 1.1, 1.25, 1.5, 1.75, 2.0, 2.5];
let currentZoomIndex = 0;
// åœ¨é ‚éƒ¨è®Šæ•¸å®£å‘Šå€åŸŸæ·»åŠ 
let hasUserZoomed = false;

     // ==========================================================
// ğŸš¨ è«‹ç¢ºèªï¼šé€™å€‹æ–°çš„ JS å€å¡Šæ˜¯åœ¨æ‚¨çš„ /detail/index.html é é¢ä¸­ ğŸš¨
// ==========================================================

document.addEventListener('DOMContentLoaded', function() {
    // é é¢è¼‰å…¥æ™‚ï¼ŒåŸ·è¡Œè³‡æ–™è¼‰å…¥èˆ‡é¡¯ç¤º
    loadDetailFromCacheOrServer();
});

function loadDetailFromCacheOrServer() {
    const reportId = getReportIdFromUrl(window.location.href);
    if (!reportId) {
        return showError('URL ä¸­ç¼ºå°‘å ±å‘Š ID åƒæ•¸ã€‚');
    }
    
    const cacheKey = 'reportListCache';
    const cachedReportsJson = sessionStorage.getItem(cacheKey);

    if (cachedReportsJson) {
        try {
            const cachedReports = JSON.parse(cachedReportsJson);
            const detailData = cachedReports[reportId];
            
            // æª¢æŸ¥å¿«å–æ•¸æ“šæ˜¯å¦å­˜åœ¨ï¼Œä¸”æ˜¯å¦åŒ…å«è¶³å¤ çš„è³‡æ–™
            if (detailData && detailData['ç‹€æ…‹'] !== undefined) { 
                console.log(`âœ… [Detail Page] å¿«å–å‘½ä¸­ï¼Œä½¿ç”¨ Session Storage æ•¸æ“šã€‚`);
                
                // â˜…â˜…â˜… æ ¸å¿ƒæ­¥é©Ÿï¼šå°‡å¿«å–æ•¸æ“šå‚³çµ¦æ‚¨ç¾æœ‰çš„æ¸²æŸ“å‡½å¼ â˜…â˜…â˜…
                handleResponse(detailData);
                
                // æ³¨æ„ï¼šå¦‚æœå¿«å–æ•¸æ“šä¸­ä¸åŒ…å«éŸ³é »é€£çµã€åœ–ç‰‡é€£çµç­‰ï¼Œ
                // é€™äº›å…ƒç´ åœ¨ handleResponse é‹è¡Œå¾Œå°‡æœƒé¡¯ç¤ºç‚ºç©º/éš±è—ã€‚
                // ç”±æ–¼æˆ‘å€‘ä¸å†æœ‰ Fallbackï¼Œæ‚¨éœ€è¦ç¢ºä¿åˆ—è¡¨å¿«å–æ•¸æ“šæ˜¯è¶³å¤ çš„ã€‚
                return; 
            }
        } catch (e) {
            console.error("è§£æ Session Storage æ•¸æ“šå¤±æ•—:", e);
        }
    }

    // â˜…â˜…â˜… Fallback é‚è¼¯ï¼šåŸ·è¡ŒåŸæœ‰çš„ GAS è«‹æ±‚ â˜…â˜…â˜…
    // åªæœ‰åœ¨å¿«å–å¤±æ•—æ™‚ï¼Œæ‰èµ°åŸæœ‰çš„ç¶²è·¯è«‹æ±‚è·¯å¾‘ (é€™æ˜¯ç‚ºäº†è¼‰å…¥å®Œæ•´çš„åª’é«”/ç·¨è¼¯åŠŸèƒ½)
    console.log(`âŒ [Detail Page] å¿«å–å¤±æ•—æˆ–ä¸å­˜åœ¨ï¼ŒåŸ·è¡ŒåŸæœ‰çš„ GAS è«‹æ±‚ã€‚`);
    
    // å‡è¨­æ‚¨åŸæœ‰çš„ GAS è«‹æ±‚é‚è¼¯æ˜¯é€™æ¨£åŸ·è¡Œçš„ï¼š
    const currentUrl = window.location.href; // åŸå§‹ URL ä¸­åŒ…å«äº†å‘ GAS è«‹æ±‚æ‰€éœ€çš„åƒæ•¸
    // æ‚¨éœ€è¦åœ¨é€™è£¡é‡å»ºæˆ–å‘¼å«æ‚¨åŸæœ‰çš„ JSONP è«‹æ±‚å‡½å¼ï¼Œä¾‹å¦‚ï¼š
    // requestGASData(currentUrl); 
    
    // å¦‚æœæ‚¨åŸæœ‰çš„ç¨‹å¼ç¢¼æ˜¯é€é URL åƒæ•¸è‡ªå‹•ç™¼èµ·è«‹æ±‚ï¼Œè«‹ä¿ç•™è©²éƒ¨åˆ†ã€‚
    // å¦‚æœæ‚¨éœ€è¦ä¸€å€‹å‡½å¼ä¾†ç™¼èµ·è«‹æ±‚ï¼Œå‰‡éœ€è¦åœ¨é€™è£¡å‘¼å«å®ƒã€‚
    // (ç”±æ–¼æˆ‘å€‘ä¸å†æœ‰ä¸»é é¢çš„å¿«å–é®ç½©ï¼Œé€™è£¡çš„ GAS è«‹æ±‚æ˜¯å¿…è¦çš„ Fallback)
}

// è¼”åŠ©å‡½å¼ï¼šå¾ URL ä¸­æå– ID
function getReportIdFromUrl(url) {
    try {
        const urlObj = new URL(url);
        return urlObj.searchParams.get('id'); 
    } catch (e) {
        return null; 
    }
}

    document.addEventListener('DOMContentLoaded', () => {
      const temp = localStorage.getItem('tempReportData');
      if (temp) {
        try {
          const data = JSON.parse(temp);
          console.log('âš¡ æ˜¾ç¤ºæš‚å­˜èµ„æ–™:', data);
          handleResponse(data);
        } catch (e) {
          console.warn('æš‚å­˜èµ„æ–™è§£æå¤±è´¥:', e);
        }
        localStorage.removeItem('tempReportData');
      }

      const urlParams = new URLSearchParams(window.location.search);
      const reportId = urlParams.get('id');
      pageSource = urlParams.get('source');
      if (reportId) {
        currentReportId = reportId;
        loadReportData(reportId);
      } else showError('ç„¡æ³•è¼‰å…¥ç…§ç‰‡');
    });

    async function loadReportData(reportId) {
  try {
    document.getElementById('report-date').innerHTML = `å›å ±æ™‚é–“ï¼š${formatDateFromId(reportId)}`;

    await loadReportInfoFromSheet(reportId);
    await loadPhotosFromFirebase(reportId);

    const hasAudio = await loadAudioFromFirebase(reportId);

    // èªéŸ³é¡¯ç¤º
    const audioSection = document.getElementById('audio-section');
    audioSection.style.display = hasAudio ? 'block' : 'none';

    // äºŒæ¬¡ç¢ºèªèªéŸ³èˆ‡æ–‡å­—åŒæ­¥é¡¯ç¤ºï¼ˆå¤šè¼ªé‡è©¦é¿å… race conditionï¼‰
let checkCount = 0;
const checkInterval = setInterval(() => {
  const text = document.getElementById('transcription-text')?.textContent.trim();
  const transcriptionSection = document.getElementById('transcription-section');
  if (text && text !== '' && hasAudio) {
    transcriptionSection.style.display = 'block';
    clearInterval(checkInterval);
  }
  if (++checkCount > 10) clearInterval(checkInterval); // æœ€å¤šæª¢æŸ¥10æ¬¡ï¼ˆç´„2ç§’ï¼‰
}, 200);

  } catch (e) {
    console.error(e);
    showError('è¼‰å…¥æ•¸æ“šå¤±æ•—');
  }
}

    function handleResponse(data) {
      console.log('ğŸ“¥ JSONP å–å¾—:', data);
      if (!data || data.error) return showError('æŸ¥ç„¡æ­¤å ±å‘Šè³‡æ–™');

      const elements = ['report-type', 'report-status', 'abnormal-type', 'remarks', 
                       'transcription-summary', 'reporter', 'companions', 'team'];
      elements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.color = '';
      });

      document.getElementById('report-type').innerHTML = `é€šå ±é¡å‹ï¼š${data['é€šå ±é¡å‹'] || 'ç„¡'}`;
      document.getElementById('report-status').innerHTML = `ç‹€æ…‹ï¼š${data['ç‹€æ…‹'] || 'ç„¡'}`;

      if (data['ç‹€æ…‹'] === 'ç•°å¸¸') {
        document.getElementById('abnormal-type').style.display = 'block';
        document.getElementById('abnormal-type').innerHTML = `ç•°å¸¸åˆ†é¡ï¼š${data['ç•°å¸¸åˆ†é¡'] || 'ç„¡'}`;
        document.getElementById('transcription-summary').style.display = 'block';
        document.getElementById('transcription-summary').innerHTML = `èªéŸ³è½‰æ–‡å­—ï¼š${data['èªéŸ³è½‰æ–‡å­—'] || 'ç„¡'}`;
      } else {
        document.getElementById('abnormal-type').style.display = 'none';
        document.getElementById('transcription-summary').style.display = 'none';
      }

      document.getElementById('remarks').innerHTML = `èªªæ˜ï¼š${data['èªªæ˜'] || 'ç„¡'}`;
      document.getElementById('reporter').innerHTML = `å›å ±è€…ï¼š${data['å›å ±è€…'] || 'ç„¡'}`;
      document.getElementById('companions').innerHTML = `åŒè¡Œè€…ï¼š${data['åŒè¡Œè€…'] || 'ç„¡'}`;
      document.getElementById('team').innerHTML = `æ‰€å±¬å¤§éšŠï¼š${data['æ‰€å±¬å¤§éšŠ'] || 'ç„¡'}`;

      // é¡¯ç¤ºèªéŸ³è½‰æ–‡å­—å…§å®¹ï¼ˆä¾†è‡ª Sheetï¼‰
const transcriptionSection = document.getElementById('transcription-section');
const transcriptionText = document.getElementById('transcription-text');
const transcriptionValue = data['èªéŸ³è½‰æ–‡å­—'] || '';

transcriptionText.textContent = data['èªéŸ³è½‰æ–‡å­—'] || '';
transcriptionText.setAttribute('contenteditable', 'false'); // â† æ”¹é€™è¡Œ
setupTranscriptionEditing(currentReportId);
    }

    async function loadReportInfoFromSheet(reportId) {
      const url = `https://script.google.com/macros/s/AKfycbw_zWtC5douqiQkviNskaaRihnk3d63kJf8eAzvphNxw4rpN43hbbnz5weST-p4UrO0Xw/exec?id=${reportId}&callback=handleResponse`;
      const script = document.createElement('script');
      script.src = url;
      document.body.appendChild(script);
    }

    function formatDateFromId(reportId) {
      const t = parseInt(reportId.replace('report_', ''));
      return isNaN(t) ? 'æœªçŸ¥æ™‚é–“' : new Date(t).toLocaleString('zh-TW');
    }

    async function loadPhotosFromFirebase(reportId) {
      try {
        const { ref, list, getDownloadURL } = window.firebaseStorage;
        const storageRef = ref(window.firebaseStorage.storage, `reports/${reportId}/`);
        let pageToken = null;
        let allUrls = [];

        do {
          const result = await list(storageRef, { maxResults: 50, pageToken });

          const validItems = result.items
            .filter(item => /\.(jpg|jpeg|png|gif|webp|heic)$/i.test(item.name))
            .sort((a, b) => {
              const numA = parseInt(a.name.match(/photo_(\d+)/)?.[1] || '0');
              const numB = parseInt(b.name.match(/photo_(\d+)/)?.[1] || '0');
              return numA - numB;
            });

          for (const f of validItems) {
            try {
              const url = await getDownloadURL(f);
              if (url && url.startsWith('https')) {
                allUrls.push(url);
              }
            } catch (err) {
              console.warn('è·³éå£æª”ï¼š', f.name, err.message);
            }
          }

          pageToken = result.nextPageToken;
        } while (pageToken);

        displayPhotos(allUrls);
        
      } catch (e) {
        console.error("âŒ è¼‰å…¥ç…§ç‰‡éŒ¯èª¤:", e);
        document.getElementById('photo-gallery').innerHTML =
          '<p style="color:#666;text-align:center;font-size:18px;">è¼‰å…¥ç…§ç‰‡å¤±æ•—</p>';
      }
    }

    function displayPhotos(urls) {
      const g = document.getElementById('photo-gallery');
      g.innerHTML = '';
      
      if (!urls || urls.length === 0) {
        g.innerHTML = '<p style="text-align:center;color:#666;font-size:18px;">æ­¤å›å ±æ²’æœ‰ç…§ç‰‡</p>';
        return;
      }
      
      urls.forEach((u, i) => {
        const d = document.createElement('div');
        d.className = 'photo-item loading';
        
        const img = new Image();
        img.style.cssText = 'width:100%;height:100%;object-fit:cover;background:#f5f5f5;transition:opacity 0.3s ease;';
        
        img.onload = function() {
          d.classList.remove('loading');
          d.classList.add('loaded');
        };
        
        img.onerror = function() {
          console.error('åœ–ç‰‡è¼‰å…¥å¤±æ•—:', u);
          d.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">âŒ è¼‰å…¥å¤±æ•—</div>';
          d.style.cursor = 'default';
        };
        
        img.src = u;
        img.alt = `ç…§ç‰‡ ${i + 1}`;
        
        d.appendChild(img);
        d.onclick = () => openModal(i, urls);
        g.appendChild(d);
      });
    }

    async function loadAudioFromFirebase(reportId) {
  const loadingBox = document.getElementById('audio-loading');
  const emptyBox = document.getElementById('audio-empty');
  const playerBox = document.getElementById('audio-player-container');

  // åˆå§‹åŒ–ç‹€æ…‹
  loadingBox.style.display = 'block';
  emptyBox.style.display = 'none';
  playerBox.style.display = 'none';

  const { ref, getDownloadURL } = window.firebaseStorage;
  const exts = ['.m4a', '.mp3', '.webm', '.wav'];

  for (const ext of exts) {
    try {
      const r = ref(window.firebaseStorage.storage, `reports/${reportId}/recording${ext}`);
      const url = await getDownloadURL(r);

      // æ‰¾åˆ°èªéŸ³ â†’ é¡¯ç¤ºæ’­æ”¾å™¨
      loadingBox.style.display = 'none';
      playerBox.style.display = 'block';

      console.log('ğŸ§ èªéŸ³æª”è¼‰å…¥æˆåŠŸ:', url);
      initCustomPlayer(url);
      return true;
    } catch (err) {
      // æ²’æœ‰é€™å€‹æ ¼å¼ â†’ è·³ä¸‹ä¸€å€‹
    }
  }

  // å››å€‹æ ¼å¼éƒ½æ²’æª”æ¡ˆ â†’ é¡¯ç¤ºã€Œç„¡èªéŸ³ã€
  loadingBox.style.display = 'none';
  emptyBox.style.display = 'block';
  return false;
}

    function showError(msg) {
      document.getElementById('photo-gallery').innerHTML = `<div class="error">${msg}</div>`;
    }

    function openModal(i, urls) {
    window.parent.postMessage({ action: "PHOTO_OPEN" }, "*");
    document.body.style.overflow = 'hidden';
    currentIndex = i;
    currentPhotoUrls = urls;
    const m = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-image');
    const modalContainer = document.getElementById('modalContainer');

    // é‡ç½®ç‹€æ…‹
    resetZoomImmediate();
    hasUserZoomed = false;
    
    modalImg.src = urls[i];

    modalImg.onload = () => {
        modalImg.style.transform = 'translate(0, 0) scale(1)';
        modalImg.style.maxWidth = '90vw';
        modalImg.style.maxHeight = '80vh';
        modalImg.style.objectFit = 'contain';

        currentZoomIndex = 0;
        visualScale = zoomLevels[0];
        currentScale = visualScale;
        currentTranslateX = 0;
        currentTranslateY = 0;
        isZoomed = false;

        updateZoomIndicator();
        updateZoomButtons();
        updateResetButtonVisibility(); // åˆå§‹åŒ–æŒ‰éˆ•é¡¯ç¤ºç‹€æ…‹
    };

    m.style.display = 'block';
    updateModalNavButtons();

    // å•Ÿç”¨æ»¾è¼ªç¸®æ”¾
    modalImg.removeEventListener('wheel', handleWheelZoom);
    modalImg.addEventListener('wheel', handleWheelZoom);

    // é›»è…¦ç‰ˆï¼šåªæœ‰å·¦å³30%å€åŸŸå¯ä»¥é»æ“Šåˆ‡æ›
if (window.innerWidth > 768) {
    modalContainer.onclick = function(e) {
        if (isZoomed) return;
        
        const rect = this.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const width = rect.width;
        
        if (clickX < width * 0.3) {
            navigatePhoto(-1);
        } else if (clickX > width * 0.7) {
            navigatePhoto(1);
        }
    };
}

    // æ‰‹æ©Ÿç¸®æ”¾æ”¯æŒ
    setupTouchZoom(modalImg);

    // æ‰‹æ©Ÿæ»‘å‹•åˆ‡æ›
    setupSwipeNavigation(modalContainer);

    // å•Ÿç”¨æ‹–æ›³åŠŸèƒ½
    enableDragForZoomedImage(modalImg);
}

    function resetZoom() {
    const modalImg = document.getElementById('modal-image');
    isZoomed = false;
    currentZoomIndex = 0;
    visualScale = zoomLevels[0];
    currentScale = visualScale;
    currentTranslateX = 0;
    currentTranslateY = 0;
    hasUserZoomed = false; // é‡ç½®æ¨™è¨˜
    
    modalImg.style.transition = 'transform 0.2s ease-out';
    modalImg.style.transform = 'translate(0, 0) scale(1)';
    modalImg.classList.remove('zoomed');
    
    updateZoomIndicator();
    updateZoomButtons();
    updateResetButtonVisibility(); // éš±è—å›å¾©åŸç‹€æŒ‰éˆ•
}

    // ä¿®æ”¹ handleZoom å‡½æ•¸ï¼Œåµæ¸¬ç”¨æˆ¶ç¸®æ”¾è¡Œç‚º
function handleZoom(direction, clientX, clientY) {
    const modalImg = document.getElementById('modal-image');
    const container = document.getElementById('modalContainer');
    const oldVisual = visualScale;

    let newIndex = currentZoomIndex + direction;
    newIndex = Math.max(0, Math.min(zoomLevels.length - 1, newIndex));
    
    if (newIndex === currentZoomIndex) return;
    
    currentZoomIndex = newIndex;
    visualScale = zoomLevels[currentZoomIndex];
    currentScale = visualScale;
    isZoomed = visualScale > 1.0;
    
    // æ¨™è¨˜ç”¨æˆ¶æœ‰é€²è¡Œç¸®æ”¾æ“ä½œï¼ˆé™¤äº†å›åˆ°100%ï¼‰
    if (visualScale > 1.0) {
        hasUserZoomed = true;
    }
    
    // é¡¯ç¤º/éš±è—å›å¾©åŸç‹€æŒ‰éˆ•
    updateResetButtonVisibility();
    
    if (isZoomed) {
        modalImg.classList.add('zoomed');
    } else {
        modalImg.classList.remove('zoomed');
        currentTranslateX = 0;
        currentTranslateY = 0;
    }

    // ç¸®æ”¾è¨ˆç®—...
    const rect = container.getBoundingClientRect();
    const imgRect = modalImg.getBoundingClientRect();
    const cx = clientX ?? rect.left + rect.width / 2;
    const cy = clientY ?? rect.top + rect.height / 2;
    const offsetX = cx - (imgRect.left + imgRect.width / 2);
    const offsetY = cy - (imgRect.top + imgRect.height / 2);

    currentTranslateX -= offsetX * (visualScale / oldVisual - 1);
    currentTranslateY -= offsetY * (visualScale / oldVisual - 1);

    constrainTranslation();
    applyTransform();
    updateZoomIndicator();
    updateZoomButtons();
}

function updateResetButtonVisibility() {
    const resetBtn = document.querySelector('.zoom-btn.reset');
    if (resetBtn) {
        // æ‰‹æ©Ÿç«¯ç¸½æ˜¯é¡¯ç¤ºå›å¾©åŸç‹€æŒ‰éˆ•ï¼Œæˆ–è€…åªåœ¨éœ€è¦æ™‚é¡¯ç¤º
        if (window.innerWidth <= 768) {
            // æ‰‹æ©Ÿç«¯ï¼šåªè¦æœ‰ç¸®æ”¾æˆ–æ‹–æ›³å°±é¡¯ç¤º
            if (hasUserZoomed || isZoomed || currentTranslateX !== 0 || currentTranslateY !== 0) {
                resetBtn.style.display = 'flex';
            } else {
                resetBtn.style.display = 'none';
            }
        } else {
            // é›»è…¦ç«¯ï¼šæ™ºæ…§é¡¯ç¤º
            if (hasUserZoomed || isZoomed || currentTranslateX !== 0 || currentTranslateY !== 0) {
                resetBtn.style.display = 'flex';
            } else {
                resetBtn.style.display = 'none';
            }
        }
    }
}

    function constrainTranslation() {
        const modalImg = document.getElementById('modal-image');
        const container = document.getElementById('modalContainer');
        
        const containerRect = container.getBoundingClientRect();
        const imgRect = modalImg.getBoundingClientRect();
        
        // è¨ˆç®—åœ–ç‰‡åœ¨ç•¶å‰ç¸®æ”¾ä¸‹çš„å¯¦éš›é¡¯ç¤ºå°ºå¯¸
        const displayWidth = imgRect.width * currentScale;
        const displayHeight = imgRect.height * currentScale;
        
        // è¨ˆç®—æœ€å¤§å…è¨±çš„æ‹–æ›³ç¯„åœ
        const maxTranslateX = Math.max(0, (displayWidth - containerRect.width) / 2);
        const maxTranslateY = Math.max(0, (displayHeight - containerRect.height) / 2);
        
        // åš´æ ¼é™åˆ¶ç¯„åœ
        if (displayWidth > containerRect.width) {
            currentTranslateX = Math.max(-maxTranslateX, Math.min(maxTranslateX, currentTranslateX));
        } else {
            currentTranslateX = 0;
        }
        
        if (displayHeight > containerRect.height) {
            currentTranslateY = Math.max(-maxTranslateY, Math.min(maxTranslateY, currentTranslateY));
        } else {
            currentTranslateY = 0;
        }
    }

    function resetZoomImmediate() {
    const modalImg = document.getElementById('modal-image');
    isZoomed = false;
    visualScale = 1;
    currentScale = baseScale; // ä¿æŒæœ€åˆçš„æ¯”ä¾‹
    currentTranslateX = 0;
    currentTranslateY = 0;
    modalImg.style.transition = 'none'; // å–æ¶ˆå‹•ç•«
    modalImg.style.transform = 'translate(0, 0) scale(1)';
    modalImg.classList.remove('zoomed');
}

    // ä¿®æ”¹ zoomIn å’Œ zoomOut å‡½æ•¸
function zoomIn() {
    const modalImg = document.getElementById('modal-image');
    const container = document.getElementById('modalContainer');
    const rect = container.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    handleZoom(1, centerX, centerY);
}

function zoomOut() {
    const modalImg = document.getElementById('modal-image');
    const container = document.getElementById('modalContainer');
    const rect = container.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    handleZoom(-1, centerX, centerY);
}

    // ä¿®æ”¹ handleWheelZoom å‡½æ•¸ï¼Œè®“æ»¾è¼ªä¹Ÿä½¿ç”¨å›ºå®šç´šåˆ¥
function handleWheelZoom(e) {
    if (e.ctrlKey) {
        e.preventDefault();
        const direction = e.deltaY < 0 ? 1 : -1;
        handleZoom(direction, e.clientX, e.clientY);
    }
}

    // æ­£ç¢ºçš„ transform å¥—ç”¨
function applyTransform() {
  const modalImg = document.getElementById('modal-image');
  modalImg.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale})`;
}

    // æ–°å¢æ›´æ–°æŒ‰éˆ•ç‹€æ…‹çš„å‡½æ•¸
function updateZoomButtons() {
    const zoomInBtn = document.querySelector('.zoom-btn:last-child');
    const zoomOutBtn = document.querySelector('.zoom-btn:first-child');
    
    // ç¦ç”¨/å•Ÿç”¨ç¸®å°æŒ‰éˆ•
    if (currentZoomIndex === 0) {
        zoomOutBtn.disabled = true;
        zoomOutBtn.style.opacity = '0.3';
        zoomOutBtn.style.cursor = 'not-allowed';
    } else {
        zoomOutBtn.disabled = false;
        zoomOutBtn.style.opacity = '1';
        zoomOutBtn.style.cursor = 'pointer';
    }
    
    // ç¦ç”¨/å•Ÿç”¨æ”¾å¤§æŒ‰éˆ•
    if (currentZoomIndex === zoomLevels.length - 1) {
        zoomInBtn.disabled = true;
        zoomInBtn.style.opacity = '0.3';
        zoomInBtn.style.cursor = 'not-allowed';
    } else {
        zoomInBtn.disabled = false;
        zoomInBtn.style.opacity = '1';
        zoomInBtn.style.cursor = 'pointer';
    }
}

function updateZoomIndicator() {
    const indicator = document.querySelector('.zoom-indicator');
    const resetBtn = document.querySelector('.zoom-btn.reset');
    
    if (indicator && resetBtn) {
        const scaleText = Math.round(visualScale * 100) + '%';
        
        if (window.innerWidth <= 768) {
            // æ‰‹æ©Ÿç«¯é‚è¼¯
            if (visualScale === 1 && !hasUserZoomed) {
                // åˆå§‹ç‹€æ…‹ï¼šé¡¯ç¤º"ç…§ç‰‡å¯ç¸®æ”¾"
                indicator.textContent = "ç…§ç‰‡å¯ç¸®æ”¾";
                resetBtn.textContent = "å›å¾©åŸç‹€";
            } else {
                // ç¸®æ”¾ç‹€æ…‹æˆ–ç”¨æˆ¶æ“ä½œå¾Œï¼šé¡¯ç¤ºç™¾åˆ†æ¯”
                indicator.textContent = scaleText;
                resetBtn.textContent = "å›å¾©åŸç‹€";
            }
        } else {
            // é›»è…¦ç«¯ï¼šåªé¡¯ç¤ºç™¾åˆ†æ¯”
            indicator.textContent = scaleText;
            resetBtn.textContent = "å›å¾©åŸç‹€";
        }
    }
}

    // æ”¹å–„æ‰‹æ©Ÿé›™æŒ‡ç¸®æ”¾æ”¯æ´
function setupTouchZoom(modalImg) {
    let initialDistance = 0;
    let initialScale = 1;
    let initialX = 0, initialY = 0;
    let isPinching = false;

    modalImg.addEventListener('touchstart', e => {
        if (e.touches.length === 2) {
            e.preventDefault();
            isPinching = true;
            const [t1, t2] = e.touches;
            initialDistance = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
            initialScale = currentScale;
            initialX = (t1.clientX + t2.clientX) / 2;
            initialY = (t1.clientY + t2.clientY) / 2;
        }
    }, { passive: false });

    modalImg.addEventListener('touchmove', e => {
        if (e.touches.length === 2 && initialDistance > 0) {
            e.preventDefault();
            isPinching = true;
            const [t1, t2] = e.touches;
            const dist = Math.hypot(t2.clientX - t1.clientX, t2.clientY - t1.clientY);
            const factor = dist / initialDistance;
            
            // ä½¿ç”¨å›ºå®šç´šåˆ¥ç¸®æ”¾è€Œä¸æ˜¯é€£çºŒç¸®æ”¾
            const targetScale = initialScale * factor;
            const closestZoomLevel = findClosestZoomLevel(targetScale);
            
            if (closestZoomLevel !== visualScale) {
                const direction = closestZoomLevel > visualScale ? 1 : -1;
                handleZoom(direction, initialX, initialY);
            }
        }
    }, { passive: true });

    modalImg.addEventListener('touchend', (e) => {
        if (isPinching) {
            isPinching = false;
            // çŸ­æš«ç¦ç”¨æ»‘å‹•åˆ‡æ›ï¼Œé¿å…èª¤è§¸
            setTimeout(() => {
                isPinching = false;
            }, 300);
        }
        initialDistance = 0;
    });
}

// è¼”åŠ©å‡½æ•¸ï¼šæ‰¾åˆ°æœ€æ¥è¿‘çš„å›ºå®šç¸®æ”¾ç´šåˆ¥
function findClosestZoomLevel(targetScale) {
    let closestLevel = zoomLevels[0];
    let minDiff = Math.abs(targetScale - closestLevel);
    
    for (let i = 1; i < zoomLevels.length; i++) {
        const diff = Math.abs(targetScale - zoomLevels[i]);
        if (diff < minDiff) {
            minDiff = diff;
            closestLevel = zoomLevels[i];
        }
    }
    return closestLevel;
}

// ç”¨æ–¼ pinch çš„ç¸®æ”¾æ›´æ–°
function handlePinchZoom(newScale, cx, cy) {
  const modalImg = document.getElementById('modal-image');
  const container = document.getElementById('modalContainer');
  const oldVisual = visualScale;

  visualScale = Math.max(1, Math.min(2.0, newScale));
  currentScale = baseScale * visualScale;
  isZoomed = visualScale > 1.0;

  const rect = container.getBoundingClientRect();
  const imgRect = modalImg.getBoundingClientRect();
  const offsetX = cx - (imgRect.left + imgRect.width / 2);
  const offsetY = cy - (imgRect.top + imgRect.height / 2);

  currentTranslateX -= offsetX * (visualScale / oldVisual - 1);
  currentTranslateY -= offsetY * (visualScale / oldVisual - 1);

  constrainTranslation();
  applyTransform();
  updateZoomIndicator();
}

    function setupSwipeNavigation(container) {
  // ğŸ”¹ Android ä¿®æ­£ï¼šé˜²æ­¢å¤šæ¬¡ç¶å®š
  if (container.dataset.swipeBound === "true") return;
  container.dataset.swipeBound = "true";

  let startX = 0;
  let startY = 0;
  let isSwiping = false;

  container.addEventListener('touchstart', (e) => {
    if (isZoomed || e.touches.length !== 1) return;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    isSwiping = true;
  }, { passive: true });

  container.addEventListener('touchmove', (e) => {
    if (!isSwiping || isZoomed || e.touches.length !== 1) return;
    const currentX = e.touches[0].clientX;
    const diffX = currentX - startX;
    if (Math.abs(diffX) > 10) e.preventDefault();
  }, { passive: false });

  container.addEventListener('touchend', (e) => {
    if (!isSwiping || isZoomed) return;
    const endX = e.changedTouches[0].clientX;
    const endY = e.changedTouches[0].clientY;
    const diffX = endX - startX;
    const diffY = endY - startY;
    isSwiping = false;

    const minSwipeDistance = 40;
    const maxVerticalDistance = 60;

    if (Math.abs(diffX) > minSwipeDistance && Math.abs(diffY) < maxVerticalDistance) {
      if (diffX > 0 && currentIndex > 0) navigatePhoto(-1);
      else if (diffX < 0 && currentIndex < currentPhotoUrls.length - 1) navigatePhoto(1);
    }
  });
}

    function navigatePhoto(direction) {
        if (direction === -1 && currentIndex <= 0) return;
        if (direction === 1 && currentIndex >= currentPhotoUrls.length - 1) return;
        
        // åˆ‡æ›ç…§ç‰‡æ™‚è‡ªå‹•é‡ç½®ç¸®æ”¾
        resetZoom();
        
        currentIndex += direction;
        const modalImg = document.getElementById('modal-image');
        modalImg.src = currentPhotoUrls[currentIndex];
        
        updateModalNavButtons();
    }

    function updateModalNavButtons() {
        const leftBtn = document.querySelector('.nav-btn:nth-child(1)');
        const rightBtn = document.querySelector('.nav-btn:nth-child(2)');
        
        const isFirst = currentIndex === 0;
        const isLast = currentIndex === currentPhotoUrls.length - 1;
        
        if (isFirst) {
            leftBtn.style.opacity = "0.3";
            leftBtn.style.cursor = "not-allowed";
            leftBtn.style.pointerEvents = "none";
        } else {
            leftBtn.style.opacity = "1";
            leftBtn.style.cursor = "pointer";
            leftBtn.style.pointerEvents = "auto";
        }
        
        if (isLast) {
            rightBtn.style.opacity = "0.3";
            rightBtn.style.cursor = "not-allowed";
            rightBtn.style.pointerEvents = "none";
        } else {
            rightBtn.style.opacity = "1";
            rightBtn.style.cursor = "pointer";
            rightBtn.style.pointerEvents = "auto";
        }
    }

    function closeModal() {
        window.parent.postMessage({ action: "PHOTO_CLOSE" }, "*");
        document.body.style.overflow = '';
        document.getElementById('image-modal').style.display = 'none';
        resetZoom();
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelector('.nav-btn:nth-child(1)').onclick = function() { navigatePhoto(-1); };
        document.querySelector('.nav-btn:nth-child(2)').onclick = function() { navigatePhoto(1); };
    });

    document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('image-modal');
        if (modal.style.display === 'block' && !isKeyboardCooldown) {
            if (e.key === 'ArrowLeft') {
                navigatePhoto(-1);
                setKeyboardCooldown();
            } else if (e.key === 'ArrowRight') {
                navigatePhoto(1);
                setKeyboardCooldown();
            } else if (e.key === 'Escape') {
                closeModal();
            }
        }
    });

    function setKeyboardCooldown() {
        isKeyboardCooldown = true;
        setTimeout(() => {
            isKeyboardCooldown = false;
        }, keyboardCooldownTime);
    }

    function enableDragForZoomedImage(img) {
        const container = document.getElementById('modalContainer');
        
        img.addEventListener('mousedown', (e) => {
            if (!isZoomed) return;
            isDragging = true;
            dragStartX = e.clientX - currentTranslateX;
            dragStartY = e.clientY - currentTranslateY;
            img.style.cursor = 'grabbing';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging || !isZoomed) return;
            
            currentTranslateX = e.clientX - dragStartX;
            currentTranslateY = e.clientY - dragStartY;
            
            constrainTranslation();
            applyTransform();
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            if (isZoomed) {
                img.style.cursor = 'grab';
            }
        });

        // æ‰‹æ©Ÿè§¸æ§æ‹–å‹•
        let touchStart = null;
        img.addEventListener('touchstart', (e) => {
            if (isZoomed && e.touches.length === 1) {
                touchStart = { 
                    x: e.touches[0].clientX, 
                    y: e.touches[0].clientY,
                    translateX: currentTranslateX,
                    translateY: currentTranslateY
                };
                e.preventDefault();
            }
        });

        img.addEventListener('touchmove', (e) => {
            if (isZoomed && e.touches.length === 1 && touchStart) {
                const dx = e.touches[0].clientX - touchStart.x;
                const dy = e.touches[0].clientY - touchStart.y;
                
                currentTranslateX = touchStart.translateX + dx;
                currentTranslateY = touchStart.translateY + dy;
                
                constrainTranslation();
                applyTransform();
                e.preventDefault();
            }
        });

        img.addEventListener('touchend', () => {
            touchStart = null;
        });
    }

    let playbackAudio, rafId;

    async function initCustomPlayer(url) {
  // ------------------------------------
    // ğŸ”” ç‹€æ…‹èˆ‡ DOM å…ƒç´ åˆå§‹åŒ–
    // ------------------------------------
    const btn = document.getElementById('playBtn');
    const label = document.getElementById('timeLabel');
    const bar = document.getElementById('waveFill');
    const progressBar = document.getElementById('progressBar');
    
    // æ’­æ”¾å™¨ç‹€æ…‹è®Šæ•¸
    let playing = false;
    let isDragging = false;
    let rafId = null;
    let metadataReady = false;
    // const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent); // æ­¤è®Šæ•¸ä¼¼ä¹æœªè¢«ä½¿ç”¨ï¼Œå¯çœç•¥æˆ–ç§»è‡³å…¨åŸŸ

    // ------------------------------------
    // ğŸµ Audio å…ƒç´ åˆå§‹åŒ–èˆ‡é è¼‰
    // ------------------------------------
    playbackAudio = new Audio(url);
    playbackAudio.preload = 'auto'; 
    playbackAudio.load();
    
    // é è¨­ç¦ç”¨æ’­æ”¾æŒ‰éˆ•ï¼Œç›´åˆ°å…ƒæ•¸æ“šè¼‰å…¥å®Œæˆ
    btn.disabled = true;
    btn.style.opacity = '0.5';

    // ------------------------------------
    // âœ… Metadata è¼‰å…¥èˆ‡æ’­æ”¾å™¨å•Ÿç”¨é‚è¼¯
    // ------------------------------------
    function enablePlayer() {
        if (metadataReady) return; // é¿å…é‡è¤‡åŸ·è¡Œ
        
        metadataReady = true;
        console.log('âœ… Metadata ready. Duration:', playbackAudio.duration);
        
        // å•Ÿç”¨æ’­æ”¾æŒ‰éˆ•
        btn.disabled = false;
        btn.style.opacity = '1';
        
        // åˆå§‹åŒ–æ™‚é–“æ¨™ç±¤é¡¯ç¤º 0:00 / ç¸½æ™‚é•·
        updateTimeLabel(0); 
    }

    // 1. é€éäº‹ä»¶ç›£è½ï¼šç•¶ç€è¦½å™¨è¼‰å…¥éŸ³è¨Šå…ƒæ•¸æ“šæ™‚è§¸ç™¼
    playbackAudio.addEventListener('loadedmetadata', enablePlayer);
    
    // 2. å‚™ç”¨æª¢æŸ¥ï¼šå¦‚æœéŸ³è¨Šå·²åœ¨å¿«å–ä¸­ï¼Œloadedmetadata å¯èƒ½ä¸æœƒè§¸ç™¼ï¼Œæª¢æŸ¥ readyState
    if (playbackAudio.readyState >= 1) {
        enablePlayer();
    }
    
    // ------------------------------------
    // â–¶ï¸ æ’­æ”¾æ§åˆ¶é‚è¼¯
    // ------------------------------------
    btn.onclick = async () => {
        if (!metadataReady) return; // å…ƒæ•¸æ“šæœªè¼‰å…¥ï¼Œå¿½ç•¥é»æ“Š

        if (!playing) {
            // ç¢ºä¿è§£é™¤éœéŸ³ï¼Œå¦‚æœå…ˆå‰æœ‰éœéŸ³è™•ç†çš„è©± (é›–ç„¶é€™è£¡å·²ç§»é™¤é æ’­éœéŸ³)
            // playbackAudio.muted = false; 
            await playbackAudio.play();
            setPauseIcon();
            playing = true;
            updateProgress(); // é–‹å§‹æ›´æ–°é€²åº¦
        } else {
            playbackAudio.pause();
            setPlayIcon();
            playing = false;
            cancelAnimationFrame(rafId);
        }
    };

    playbackAudio.onended = () => {
        setPlayIcon();
        playing = false;
        cancelAnimationFrame(rafId);
        bar.style.width = '100%';
        updateTimeLabel(0); // æ’­æ”¾çµæŸå¾Œé‡è¨­æ™‚é–“é¡¯ç¤º
    };

  /* === æ›´æ–°é€²åº¦æ¢ === */
  function updateProgress() {
    if (!playing && !isDragging) return;
    const dur = getDuration();
    const cur = playbackAudio.currentTime || 0;
    if (dur > 0) {
      const pct = Math.min(100, (cur / dur) * 100);
      bar.style.width = pct + '%';
      updateTimeLabel(cur);
    }
    if (playing) rafId = requestAnimationFrame(updateProgress);
  }

  function getDuration() {
    return (playbackAudio.seekable && playbackAudio.seekable.length)
      ? playbackAudio.seekable.end(0)
      : playbackAudio.duration || 0;
  }

/* === ä¿®æ”¹ï¼šå¢åŠ ç¸½æ™‚é•·é¡¯ç¤ºï¼Œä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹ === */
function updateTimeLabel(currentTime) {
  const duration = getDuration();
  const label = document.getElementById('timeLabel');
  
  const min = Math.floor(currentTime / 60);
  const sec = Math.floor(currentTime % 60).toString().padStart(2, '0');
  
  if (duration > 0) {
      const d_min = Math.floor(duration / 60);
      const d_sec = Math.floor(duration % 60).toString().padStart(2, '0');
      // é¡¯ç¤ºç•¶å‰æ™‚é–“ / ç¸½æ™‚é•·
      label.textContent = `${min}:${sec} / ${d_min}:${d_sec}`; 
  } else {
      // è¼‰å…¥ä¸­æ™‚çš„æç¤º
      label.textContent = `è¼‰å…¥ä¸­... ${min}:${sec}`; 
  }
}

  function setPauseIcon() {
    btn.innerHTML = `<div style="
      width:14px;height:16px;background:#fff;
      clip-path: polygon(
        0 0,0 100%,35% 100%,35% 0,65% 0,65% 100%,100% 100%,100% 0
      );
    "></div>`;
  }

  function setPlayIcon() {
    btn.innerHTML = `<div style="
      width:0;height:0;border-top:9px solid transparent;
      border-bottom:9px solid transparent;border-left:16px solid #fff;margin-left:3px;
    "></div>`;
  }

  /* === é€²åº¦æ¢æ‹–æ›³åŠŸèƒ½ === */
  // è¨ˆç®—é»æ“Šä½ç½®å°æ‡‰çš„æ™‚é–“
  function getTimeFromPosition(clientX) {
    const progressRect = progressBar.getBoundingClientRect();
    const percent = (clientX - progressRect.left) / progressRect.width;
    const duration = getDuration();
    return Math.max(0, Math.min(duration, percent * duration));
  }

  // æ›´æ–°éŸ³è¨Šæ™‚é–“å’Œé€²åº¦æ¢
  function setAudioTime(time) {
    playbackAudio.currentTime = time;
    const duration = getDuration();
    const pct = (time / duration) * 100;
    bar.style.width = pct + '%';
    updateTimeLabel(time);
  }

  // æ»‘é¼ æŒ‰ä¸‹é–‹å§‹æ‹–æ›³
  progressBar.addEventListener('mousedown', (e) => {
    if (!metadataReady) return; // å…ƒæ•¸æ“šæœªè¼‰å…¥æ™‚ç¦ç”¨æ‹–æ›³
  isDragging = true;
  const time = getTimeFromPosition(e.clientX);
  setAudioTime(time);

    // æ·»åŠ å…¨å±€äº‹ä»¶ç›£è½
    const handleMouseMove = (moveEvent) => {
      if (isDragging) {
        const newTime = getTimeFromPosition(moveEvent.clientX);
        setAudioTime(newTime);
      }
    };

    const handleMouseUp = () => {
      isDragging = false;
      document.removeEventListener('mousemove', handleMouseMove);
      document.removeEventListener('mouseup', handleMouseUp);

      // å¦‚æœåŸæœ¬åœ¨æ’­æ”¾ç‹€æ…‹ï¼Œç¹¼çºŒæ’­æ”¾
      if (playing) {
        updateProgress();
      }
    };

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
  });

  // é»æ“Šé€²åº¦æ¢è·³è½‰
    progressBar.addEventListener('click', (e) => {
        if (!metadataReady) return;
        const time = getTimeFromPosition(e.clientX);
        setAudioTime(time);

        // å¦‚æœåŸæœ¬åœ¨æ’­æ”¾ç‹€æ…‹ï¼Œç¢ºä¿é€²åº¦æ¢ç¹¼çºŒæ›´æ–°
        if (playing) {
            updateProgress();
        }
    });

  // æ»‘é¼ æŒ‰ä¸‹é–‹å§‹æ‹–æ›³
    progressBar.addEventListener('mousedown', (e) => {
        if (!metadataReady) return; 
        isDragging = true;
        
        // å¦‚æœåœ¨æ’­æ”¾ä¸­ï¼Œæš«åœè‡ªå‹•æ›´æ–°
        if (playing) {
            cancelAnimationFrame(rafId);
        }
        
        const time = getTimeFromPosition(e.clientX);
        setAudioTime(time);

        // æ·»åŠ å…¨å±€äº‹ä»¶ç›£è½ (handleMouseMove, handleMouseUp ä¿æŒä¸è®Š)
        const handleMouseMove = (moveEvent) => {
            if (isDragging) {
                const newTime = getTimeFromPosition(moveEvent.clientX);
                setAudioTime(newTime);
            }
        };

        const handleMouseUp = () => {
            isDragging = false;
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);

            // å¦‚æœåŸæœ¬åœ¨æ’­æ”¾ç‹€æ…‹ï¼Œç¹¼çºŒæ’­æ”¾
            if (playing) {
                updateProgress();
            }
        };

        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    });
}

    function handleBack() {
      if (document.referrer && document.referrer.includes(location.hostname)) {
        history.back();
      } else {
        window.close();
        setTimeout(() => {
          location.href = 'https://report-tan-tau.vercel.app/';
        }, 100);
      }
    }

    function setupTranscriptionEditing(reportId) {
  const transcriptionElement = document.getElementById('transcription-text');
  const actionArea = document.getElementById('edit-actions');
  let originalText = transcriptionElement.textContent.trim();

  const editBtn = document.getElementById('edit-btn');
  editBtn.onclick = () => {
    // é€²å…¥ç·¨è¼¯
    transcriptionElement.setAttribute('contenteditable', 'true');
    transcriptionElement.classList.add('editing');
    transcriptionElement.focus();

    // æ‰‹æ©Ÿè‡ªå‹•å½ˆå‡ºéµç›¤
    setTimeout(() => transcriptionElement.focus(), 100);

    // æ›æˆå–æ¶ˆ/å„²å­˜æŒ‰éˆ•ï¼Œç«‹å³åˆ‡æ›
    actionArea.innerHTML = `
      <button id="cancel-btn" class="reset-btn">å–æ¶ˆ</button>
      <button id="save-btn" class="save-btn">å„²å­˜</button>
    `;

    const cancelBtn = document.getElementById('cancel-btn');
    const saveBtn = document.getElementById('save-btn');

    cancelBtn.onclick = () => {
      transcriptionElement.textContent = originalText;
      transcriptionElement.setAttribute('contenteditable', 'false');
      transcriptionElement.classList.remove('editing');
      transcriptionElement.blur();
      // ç«‹å³å›å¾©ä¿®æ”¹æŒ‰éˆ•
      actionArea.innerHTML = `<button id="edit-btn" class="save-btn">ä¿®æ”¹</button>`;
      setupTranscriptionEditing(reportId);
    };

    saveBtn.onclick = async () => {
      const newText = transcriptionElement.textContent.trim();
      if (newText === originalText) {
        showMessage("å…§å®¹æœªè®Šæ›´");
        return;
      }

      showMicLoading(300);
      try {
        await saveTranscriptionToServer(reportId, newText);
        hideMicLoading();
        originalText = newText;
        showMessage("å„²å­˜æˆåŠŸï¼");

        const summary = document.getElementById('transcription-summary');
        if (summary) {
          summary.textContent = `èªéŸ³è½‰æ–‡å­—ï¼š${newText || 'ç„¡'}`;
          summary.style.display = 'block';
        }
      } catch {
        hideMicLoading();
        alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      }

      transcriptionElement.setAttribute('contenteditable', 'false');
      transcriptionElement.classList.remove('editing');
      transcriptionElement.blur();
      // ç«‹å³å›å¾©ä¿®æ”¹æŒ‰éˆ•
      actionArea.innerHTML = `<button id="edit-btn" class="save-btn">ä¿®æ”¹</button>`;
      setupTranscriptionEditing(reportId);
    };
  };
}

async function saveTranscriptionToServer(reportId, newText) {
  try {
    const url = `https://script.google.com/macros/s/AKfycbw_zWtC5douqiQkviNskaaRihnk3d63kJf8eAzvphNxw4rpN43hbbnz5weST-p4UrO0Xw/exec`;
    const params = new URLSearchParams({
  action: 'updateTranscription',
  id: reportId,
  transcription: newText
});

    const response = await fetch(`${url}?${params.toString()}`, { method: 'GET' });
    const result = await response.text();
    console.log('âœ… å·²å¯«å› Google Sheetsï¼š', result);
  } catch (err) {
    console.error('âŒ å¯«å› Google Sheets å¤±æ•—ï¼š', err);
    alert('å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
}

function showMessage(text, onConfirm) {
  document.getElementById("customModal")?.remove();
  const overlay = document.createElement("div");
  overlay.id = "customModal";
  Object.assign(overlay.style, {
    position: "fixed",
    inset: "0",
    background: "rgba(0,0,0,0.6)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: "9999",
  });
  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "#fff",
    color: "#000",
    borderRadius: "12px",
    padding: "30px 40px",
    fontSize: "22px",
    textAlign: "center",
    maxWidth: "80%",
    boxShadow: "0 4px 20px rgba(0,0,0,0.3)",
  });
  box.innerHTML = text;

  const btn = document.createElement("button");
  btn.textContent = "ç¢ºå®š";
  Object.assign(btn.style, {
    marginTop: "24px",
    fontSize: "20px",
    padding: "10px 28px",
    borderRadius: "8px",
    border: "none",
    background: "#0b5ed7",
    color: "#fff",
  });

  // â† åªæ”¹é€™æ®µï¼šå…ˆç§»é™¤è¦–çª—ï¼Œé€£çºŒå…©æ¬¡ rAF ç¢ºä¿å®Œæˆé‡ç¹ªï¼Œå†åŸ·è¡Œ onConfirmï¼ˆé–‹ç›¸ç°¿ï¼‰
  btn.onclick = () => {
    overlay.remove();
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        if (typeof onConfirm === "function") onConfirm();
      });
    });
  };

  box.appendChild(document.createElement("br"));
  box.appendChild(btn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

let micLoadingTimer = null;

function showMicLoading(delay = 100) {
  showScreenLock();

  micLoadingTimer = setTimeout(() => {
    let box = document.getElementById('micLoading');
    if (!box) {
      box = document.createElement('div');
      box.id = 'micLoading';
      Object.assign(box.style, {
        position: 'fixed',
        left: '50%',
        top: '50%',
        transform: 'translate(-50%, -50%)',
        background: 'rgba(255,255,255,0.96)',
        borderRadius: '12px',
        padding: '18px 26px',
        boxShadow: '0 2px 12px rgba(0,0,0,0.25)',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        gap: '10px',
        zIndex: '9999',
        fontSize: '21px',
        color: '#333'
      });
      box.innerHTML = `
        <div class="spinner" style="
          width:22px;height:22px;
          border:3px solid #ccc;
          border-top:3px solid #0b5ed7;
          border-radius:50%;
          animation:spin 1s linear infinite;"></div>
        <span>è™•ç†ä¸­...</span>
      `;
      const style = document.createElement('style');
      style.textContent = `@keyframes spin { from{transform:rotate(0deg);} to{transform:rotate(360deg);} }`;
      document.head.appendChild(style);
      document.body.appendChild(box);
    } else box.style.display = 'flex';
  }, delay);
}

function hideMicLoading() {
  clearTimeout(micLoadingTimer);
  const box = document.getElementById('micLoading');
  if (box) box.style.display = 'none';
  hideScreenLock();
}

function showScreenLock() {
  let overlay = document.getElementById('screenLock');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'screenLock';
    Object.assign(overlay.style, {
      position: 'fixed',
      inset: '0',
      background: 'rgba(0,0,0,0.3)',
      zIndex: '9998'
    });
    document.body.appendChild(overlay);
  } else overlay.style.display = 'block';
}

function hideScreenLock() {
  const overlay = document.getElementById('screenLock');
  if (overlay) overlay.style.display = 'none';
}

function closeWindowSafe() {
  window.location.href = "https://flood-system.vercel.app/home";  // æ›¿æ›æˆä½ çš„ä¸»é¸å–®é 
}

function handleGoBack() {
  const urlParams = new URLSearchParams(location.search);
  const source = urlParams.get('source');

  if (source === 'report') {
    history.back();
    return;
  }

  if (source === 'list') {
    history.back();
    return;
  }

  history.back();
}

(function() {
  const urlParams = new URLSearchParams(location.search);
  const source = urlParams.get('source');
  const footer = document.getElementById('footer-back');

  const inIframe = window.self !== window.top;

  // å¦‚æœæ˜¯ DisplayList ç”¨ iframe embed â†’ ä¸€å¾‹éš±è—
  if (inIframe) {
    footer.style.display = 'none';
    return;
  }

  // ä¾†è‡ª reports â†’ é¡¯ç¤º
  if (source === 'report') {
    footer.style.display = 'flex';
    return;
  }

  // ä¾†è‡ª display listï¼ˆé iframe çš„æƒ…æ³ï¼‰â†’ éš±è—
  if (source === 'list') {
    footer.style.display = 'none';
    return;
  }

  // å…¶ä»–æƒ…æ³é è¨­ï¼šé¡¯ç¤º
  footer.style.display = 'flex';
})();
  </script>
</body>
</html>
