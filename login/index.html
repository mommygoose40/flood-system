<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>防汛通報系統</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f5f8ff;
    margin: 0;
    padding: 0;
    height: 100vh;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* 遮罩永遠在最上層 */
  #loadingMask {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 99999999;
    font-size: 26px;
    color: white;
  }

  .spinner {
    width: 42px;
    height: 42px;
    border: 4px solid #eee;
    border-top: 4px solid #0b5ed7;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 14px;
  }

  @keyframes spin {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
  }

  /* log 完全放在遮罩之內 */
  #maskLog {
    margin-top: 20px;
    background: rgba(255,255,255,0.1);
    padding: 15px;
    border-radius: 8px;
    max-width: 90%;
    font-size: 14px;
    white-space: pre-wrap;
    display: none;
  }
</style>
</head>

<body>

<!-- 遮罩：永遠最上層 -->
<div id="loadingMask">
  <div class="spinner"></div>
  <div id="loadingText">驗證身份中...</div>

  <!-- debug log 放這裡，不會影響 body 排版 -->
  <div id="maskLog"></div>
</div>

<script>
const LIFF_ID = "2007934728-q468EB12";
const GAS_URL = "https://script.google.com/macros/s/AKfycbwFeKTS39HUOqNhqpgLaG7vjeJLHxv9a-KBEmWKl6zZybdCBWlSJqJWZ_qXwLxQ3sue/exec?action=login";

/* ===== 遮罩內顯示 log（不會閃） ===== */
function showLog(msg){
  const log = document.getElementById("maskLog");
  log.textContent = msg;
  log.style.display = "block";   // 永遠在遮罩內，不影響 layout
}

/* ===== 主流程 ===== */
async function main(){
  await liff.init({ liffId: LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
    return;
  }

  const mask = document.getElementById("loadingMask");
  mask.style.display = "flex";

  try {
    const profile = await liff.getProfile();
    const lineUserId = profile.userId;
    const lineName = profile.displayName;

    const url = `${GAS_URL}&lineUserId=${encodeURIComponent(lineUserId)}&nickname=${encodeURIComponent(lineName)}`;
    const resp = await fetch(url);
    const data = await resp.json();

    showLog("GAS 回傳資料：\n" + JSON.stringify(data, null, 2));

    const vid  = data.data?.["志工ID"];
    const name = data.data?.["姓名"];
    const team = data.data?.["大隊"];
    const role = data.data?.["權限"];

    if (data.registered) {
      localStorage.setItem("vid", vid || "");
      localStorage.setItem("name", name || "");
      localStorage.setItem("team", team || "");
      localStorage.setItem("role", role || "");
      window.location.href = "https://flood-system.vercel.app/home";
      return;
    }

    window.location.href = "https://flood-system.vercel.app/home?unreg=1";

  } catch(error) {
    showLog("錯誤：\n" + error.message);
  }
}

main();

/* ===== 隱藏遮罩 ===== */
function hideLoading() {
  document.getElementById("loadingMask").style.display = "none";
}

/* ===== 自訂提示窗（引用你的註冊頁邏輯） ===== */
function showWarningAlert(title, message = '') {
  createCustomAlert(title, message, false);
}

function createCustomAlert(title, message = '', isSuccess = false) {

  document.getElementById('customAlert')?.remove();
  document.body.style.overflow = 'hidden';

  const overlay = document.createElement('div');
  overlay.id = 'customAlert';
  Object.assign(overlay.style, {
    position: 'fixed',
    inset: '0',
    background: 'rgba(0,0,0,0.6)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: '10000'
  });

  const hasMessage = message.trim().length > 0;

  const iconHTML = isSuccess
    ? `<span style="font-size:26px;">✔️</span>`
    : `<span style="font-size:32px;">⚠️</span>`;

  const styleConfig = hasMessage
    ? { padding: '34px 48px 36px', fontSize: '20px', maxWidth: '78%', lineHeight: '1.8' }
    : { padding: '30px 40px', fontSize: '22px', maxWidth: '80%', lineHeight: '1.5' };

  const box = document.createElement('div');
  Object.assign(box.style, {
    background: '#fff',
    color: '#000',
    borderRadius: '12px',
    textAlign: 'center',
    boxShadow: '0 4px 20px rgba(0,0,0,0.3)',
    ...styleConfig
  });

  box.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
      ${iconHTML}
      <span style="font-weight:bold;font-size:24px;">${title}</span>
    </div>
    ${hasMessage ? `<div style="font-size:21px;color:#333;margin-top:10px;">${message}</div>` : ''}
  `;

  const btn = document.createElement('button');
  btn.textContent = '確定';
  Object.assign(btn.style, {
    marginTop: '24px',
    fontSize: '20px',
    padding: '10px 28px',
    borderRadius: '8px',
    border: 'none',
    background: '#0b5ed7',
    color: '#fff',
    cursor: 'pointer'
  });

  btn.onclick = () => {
    overlay.remove();
    document.body.style.overflow = '';
  };

  box.appendChild(btn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}
</script>

</body>
</html>
