<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>防汛通報系統</title>

  <!-- 只保留「一個」 LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
  const sdk = document.querySelector('script[src*="liff"]');

  sdk.onload = () => {
    document.getElementById("debug").textContent += "\nSDK 載入成功";
  };

  sdk.onerror = () => {
    document.getElementById("debug").textContent += "\nSDK 載入失敗！！！";
  };
</script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f8ff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* 遮罩永遠最高層 */
    #loadingMask {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 99999999;
      font-size: 26px;
      color: white;
    }

    .spinner {
      width: 42px;
      height: 42px;
      border: 4px solid #eee;
      border-top: 4px solid #0b5ed7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 14px;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }
  </style>
</head>

<body>

<!--
<div id="debug" style="position:fixed;top:10px;left:10px;background:#000;color:#fff;padding:5px;z-index:99999999;white-space:pre-line;font-size:12px;">
  JS 未開始
</div>
-->
  
<!-- 遮罩：永遠蓋住全部 -->
<div id="loadingMask">
  <div class="spinner"></div>
  <div id="loadingText">驗證身份中...</div>
</div>

<script>
const LIFF_ID = "2007934728-q468EB12";
const GAS_URL = "https://script.google.com/macros/s/AKfycbypFnD67Ed5mN6pau0wfEJ4RMu-vGoJa8RZhh0ASru_DSrOxFH4wjdzF0RMK-U3lbtG/exec?action=login";

function logDebug(msg) {
  const el = document.getElementById("debug");
  if (!el) return;
  el.textContent += "\n" + msg;
  console.log(msg);
}

async function main() {
  logDebug("JS 已開始執行");
  logDebug("目前網址: " + window.location.href);

  try {
    liff.logout();  // ← 強制清除登入狀態（測試用）
    logDebug("開始 liff.init");
    await liff.init({ liffId: LIFF_ID });
    logDebug("liff.init 完成");

    const loggedIn = liff.isLoggedIn();
    logDebug("isLoggedIn = " + loggedIn);

    // 第一次進來且尚未登入 → 正式登入並 redirect 回來
    if (!loggedIn) {
      logDebug("尚未登入，準備跳轉到 LINE 登入畫面");
      return liff.login({
        redirectUri: "https://flood-system.vercel.app/login/index.html"
      });
    }

    // === 只有登入成功後才會執行以下 ===
    document.getElementById("loadingMask").style.display = "flex";
    logDebug("已登入，開始取得個人資料");

    const profile = await liff.getProfile();
    const lineUserId = profile.userId;
    const lineName = profile.displayName;

    logDebug("取得 profile 成功: " + lineUserId + " / " + lineName);

    const url = `${GAS_URL}&lineUserId=${encodeURIComponent(lineUserId)}&nickname=${encodeURIComponent(lineName)}`;
    logDebug("呼叫 GAS: " + url);

    const resp = await fetch(url);
    const data = await resp.json();

    logDebug("GAS 回傳: " + JSON.stringify(data));

    const vid  = data.data?.["志工ID"];
    const name = data.data?.["姓名"];
    const team = data.data?.["大隊"];
    const nickname = data.data?.["LINE暱稱"];
    const role = data.data?.["權限"];

    if (data.registered) {
      localStorage.setItem("vid", vid || "");
      localStorage.setItem("name", name || "");
      localStorage.setItem("team", team || "");
      localStorage.setItem("nickname", nickname || "");
      localStorage.setItem("role", role || "");

      logDebug("已註冊，導向 /home");
      window.location.href = "https://flood-system.vercel.app/home";
      return;
    }

    logDebug("未註冊，導向 /home?unreg=1");
    window.location.href = "https://flood-system.vercel.app/home?unreg=1";

  } catch (err) {
    logDebug("發生錯誤: " + (err && err.message ? err.message : String(err)));
    console.error(err);
    // 真的要顯示 alert 再打開這行
    // alert("身分驗證失敗，請重新嘗試");
  }
}

window.addEventListener("load", () => {
  logDebug("window.onload 觸發，準備執行 main()");
  if (typeof liff === "undefined") {
    logDebug("liff 物件不存在，LIFF SDK 可能沒載入成功");
    return;
  }
  main();
});

/* ===== 隱藏遮罩 ===== */
function hideLoading() {
  document.getElementById("loadingMask").style.display = "none";
}

/* ===== 自訂提示窗（引用你的註冊頁邏輯） ===== */
function showWarningAlert(title, message = '') {
  createCustomAlert(title, message, false);
}

function createCustomAlert(title, message = '', isSuccess = false) {
  document.getElementById('customAlert')?.remove();
  document.body.style.overflow = 'hidden';

  const overlay = document.createElement('div');
  overlay.id = 'customAlert';
  Object.assign(overlay.style, {
    position: 'fixed',
    inset: '0',
    background: 'rgba(0,0,0,0.6)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: '10000'
  });

  const hasMessage = message.trim().length > 0;

  const iconHTML = isSuccess
    ? `<span style="font-size:26px;">✔️</span>`
    : `<span style="font-size:32px;">⚠️</span>`;

  const styleConfig = hasMessage
    ? { padding: '34px 48px 36px', fontSize: '20px', maxWidth: '78%', lineHeight: '1.8' }
    : { padding: '30px 40px', fontSize: '22px', maxWidth: '80%', lineHeight: '1.5' };

  const box = document.createElement('div');
  Object.assign(box.style, {
    background: '#fff',
    color: '#000',
    borderRadius: '12px',
    textAlign: 'center',
    boxShadow: '0 4px 20px rgba(0,0,0,0.3)',
    ...styleConfig
  });

  box.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;gap:10px;">
      ${iconHTML}
      <span style="font-weight:bold;font-size:24px;">${title}</span>
    </div>
    ${hasMessage ? `<div style="font-size:21px;color:#333;margin-top:10px;">${message}</div>` : ''}
  `;

  const btn = document.createElement('button');
  btn.textContent = '確定';
  Object.assign(btn.style, {
    marginTop: '24px',
    fontSize: '20px',
    padding: '10px 28px',
    borderRadius: '8px',
    border: 'none',
    background: '#0b5ed7',
    color: '#fff',
    cursor: 'pointer'
  });

  btn.onclick = () => {
    overlay.remove();
    document.body.style.overflow = '';
  };

  box.appendChild(btn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}
</script>

</body>
</html>
