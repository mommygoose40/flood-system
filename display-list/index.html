<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>é˜²æ±›é€šå ±ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f8ff;
      padding: 16px;
    }

    h2 {
      text-align: center;
      margin-bottom: 24px;
    }

    .year-block, .month-block, .day-block {
      border: 1px solid #d0d7e2;
      border-radius: 8px;
      background: white;
      margin-bottom: 4px;
      overflow: hidden;
    }

    .header {
      padding: 12px 16px;
      background: #e8eef8;
      cursor: pointer;
      font-size: 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toggle-icon svg {
  width: 26px;
  height: 26px;
  color: #333;
}

/* å±•é–‹å¾Œ header çš„ä¸‹æ–¹è¦ç•™è·é›¢ */
.header + .content {
  margin-top: 4px;
}

    .content {
      display: none;
      padding: 0 16px 12px;
    }

    .record {
  display: flex;
  align-items: center;
  font-size: 18px;
  padding: 10px 0;
  border-bottom: 1px solid #eee;
  gap: 6px;
  cursor: pointer;
}

    .record:last-child {
      border-bottom: none;
    }

    /* è®“æ‰€æœ‰å€å¡Šä¹‹é–“ä¿æŒè·é›¢ */
.year-block, .month-block, .day-block {
  margin-bottom: 14px;
}

/* è®“å±•é–‹çš„å…§å®¹ä¸æœƒç·Šè²¼ header */
.content {
  margin-top: 6px;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: #E53935;
}

/* === ä¿®æ­£å±•é–‹å¾Œçš„å€å¡Šé–“è· === */
/* å±•é–‹å¾Œçš„å¤–æ¡†ä¿ç•™è¼ƒå¤§ç©ºéš™ */
.block-open {
  margin-bottom: 12px !important;
}

/* è®“å±•é–‹å¾Œçš„ content æœ‰å…§è·ï¼Œé¿å…é»ä½ */
.year-block > .content,
.month-block > .content,
.day-block > .content {
  padding-top: 10px;
}

/* æ—¥æœŸå±•é–‹å¾Œçš„ç´€éŒ„å­—é«”åŠ å¤§ */
.day-block .record {
  font-size: 20px;   /* ä½ å¯æ”¹æˆ 20 / 24 */
}

/* æœ¬æœˆç„¡å·¡è¦–ç´€éŒ„ å­—é«”èˆ‡ä¸€èˆ¬ç´€éŒ„ä¸€è‡´ */
.month-block .record {
  font-size: 20px;
}

#loadingMask {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  font-size: 28px;
  color: white;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #eee;
  border-top: 4px solid #0b5ed7;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 14px;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

.loadingText {
  display: none;
}

#listContainer {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

#switchArea {
  display: flex;
  justify-content: space-between;  /* å·¦å³æ’åˆ— */
  text-align: center;
  margin-top:10px;
  margin-bottom:18px;
}

#adminFilterArea select {
  font-size: 20px;
  padding: 6px;
}
#adminFilterArea label {
  font-size: 20px;
}

#adminFilterArea div {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: nowrap;   /* â­ ä¸å…è¨±æ›è¡Œ */
  white-space: nowrap;   /* ğŸ”¥ å®Œæ•´ç¦æ­¢æ›è¡Œ */
}

#adminSearchBtn, #viewFullRecords {
  padding: 8px 14px; /* æ›´å° */
  font-size: 20px;   /* æ›´å° */
  border: none;
  color: white;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  flex: none !important;   /* ä¸è¦è¢«æ’å¤§ */
  width: auto !important;  /* è‡ªå‹•ç¸® */
  display: inline-block;   /* ä¸è¦ä½”æ»¿ */
}

#adminSearchBtn {
  background: #0b5ed7;
  width: 110px !important; /* â˜… å°ä¸€é» */
  margin: 0 auto !important;
  display: block !important;
}

#adminSearchBtn:hover {
  background: #0a58ca;
  transform: translateY(-1px);
}

#viewFullRecords {
  background: #28a745;
}

#viewFullRecords:hover {
  background: #218838;
  transform: translateY(-1px);
}

/* å½ä¸‹æ‹‰æŒ‰éˆ• */
.fakeSelectBtn {
  font-size: 20px;
  padding: 4px 12px;
  border: 1px solid #888;
  border-radius: 4px;
  background: #fff;
  color: #333;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: space-between;
  min-width: 110px;
  box-sizing: border-box;
}

/* å½ä¸‹æ‹‰é¸å–®å…§æ–‡å­—æ”¹æˆåŒè‰² */
.fakeSelectBtn span {
  font-weight: normal !important;
}

/* å›ºå®šç®­é ­ï¼Œä¸éš¨å­—é«”æ¯”ä¾‹è®Šå½¢ */
.fakeSelectBtn .arrow {
  display: inline-block;
  width: 18px;
  height: 18px;
  font-size: 18px;
  line-height: 18px;
  text-align: center;
  margin-left: 6px;
  flex-shrink: 0; /* â­ ä¸è¦è¢«æ“ å£“è®Šå½¢ */
}

/* é»‘è‰²é®ç½© */
#fullDropdownMask {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  z-index: 99999;
  display: none;
  justify-content: center;
  align-items: center;
  padding: 30px;         /* å››å‘¨ç•™ç™½ */
}

/* å½ˆå‡ºå¡ç‰‡ï¼ˆå‡ç´šç‰ˆï¼šæ›´é«˜ã€æ›´å¤§ï¼‰ */
#fullDropdownPanel {
  width: 92%;            /* å¡ç‰‡æ›´å¯¬ï¼Œä½†ä¸æ»¿ç‰ˆ */
  max-width: 520px;      /* å¤§è¢å¹•ä¸Šä»ç„¶ä¸æœƒå¤ªå¤§ */
  max-height: 95%;       /* ğŸ”¥ å¡ç‰‡å¯è®Šæ›´å¤§ï¼ˆåŸæœ¬ 60% â†’ 75%ï¼‰ */
  background: #fff;
  border-radius: 20px;
  padding: 14px 0;
  overflow-y: auto;
  box-shadow: 0 6px 26px rgba(0,0,0,0.3);
}

/* æ¨™é¡Œï¼ˆå¾®ç¸®ï¼‰ */
.panel-title {
  font-size: 20px;       /* åŸæœ¬ 22 â†’ ç¾åœ¨ 20 */
  font-weight: bold;
  padding: 0 20px 14px;
  margin-bottom: 6px;
  border-bottom: 1px solid #eee;
}

/* é¸é …ï¼ˆå¾®ç¸®ï¼‰ */
.panel-options .option {
  padding: 14px 20px;    /* åŸæœ¬ 18px â†’ 14px */
  font-size: 20px;       /* åŸæœ¬ 22px â†’ 20px */
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #f2f2f2;
  cursor: pointer;
  color: #222;
}

/* é»æ“Šå›é¥‹ */
.panel-options .option:active {
  background: #f7f7f7;
}

/* å–®é¸åœ“åœˆï¼ˆå¾®ç¸®ï¼‰ */
.radio-circle {
  width: 22px;           /* åŸ 24 â†’ 22 */
  height: 22px;
  border-radius: 50%;
  border: 2px solid #777;
  display: flex;
  justify-content: center;
  align-items: center;
}

.radio-circle.selected {
  border-color: #0b5ed7;
}

.radio-circle.selected::after {
  content: "";
  width: 10px;           /* åŸ 12 â†’ 10 */
  height: 10px;
  background: #0b5ed7;
  border-radius: 50%;
}

.searchBtn {
  padding: 10px 18px;
  font-size: 20px;
  background: #0b5ed7;
  color: white;
  border: none;
  border-radius: 8px;
  display: inline-block;     /* ğŸ”¥ è®“æŒ‰éˆ•å¯¬åº¦å›åˆ°æ­£å¸¸ */
  width: auto;               /* ğŸ”¥ å–æ¶ˆ flex çš„å½±éŸ¿ */
  margin: 0 auto;            /* ğŸ”¥ æ°´å¹³ç½®ä¸­ */
}

/* å®Œå…¨å»é™¤æ‰‹æ©Ÿè§¸æ§é«˜äº® */
.fakeSelectBtn,
.panel-options .option {
  -webkit-tap-highlight-color: transparent !important;
}

/* ç¦ç”¨æŒ‰ä¸‹æ™‚è®Šè‰² */
.panel-options .option:active {
  background: white !important;
}

/* è¢«é¸å–çš„é¸é …é«˜äº® */
.option.selected {
  background: #eef5ff !important;
}

.option.selected::after {
  content: "";
  width: 10px;
  height: 10px;
  background: #0b5ed7;
  border-radius: 50%;
  display: inline-block;
}

#globalFooter {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 70px;
  background: #f8f8f8;
  display: flex;
  gap: 12px;
  justify-content: center;
  align-items: center;
  padding: 0 16px;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.12);
  z-index: 9999;
}

.gray-btn, .red-btn {
  flex: 1;
  height: 48px;
  font-size: 20px;
  border-radius: 10px;
  border: none;
}

.gray-btn {
  background: #e0e0e0;
  color: #333;
}

.red-btn {
  background: #d9534f;
  color: #fff;
}

/* é›»è…¦ç‰ˆéš±è— Footer */
@media (min-width: 769px) {
  #globalFooter {
    display: none !important;
  }
}

#pageWrapper {
  padding-bottom: 90px; /* é ç•™ footer ç©ºé–“ */
}

#detailView {
  padding-bottom: 0 !important;
  height: calc(100vh - 70px);
  overflow-y: auto;
}

#globalFooter {
  box-sizing: border-box;
}

html, body {
  height: 100%;
  overflow: hidden;   /* é—œé–‰å…¨é æ»¾å‹• */
}

#listView {
  height: calc(100vh - 70px); /* æ‰£æ‰ footer é«˜åº¦ */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch; /* è®“æ‰‹æ©Ÿæ»‘å‹•é † */
}
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>

  <div id="pageWrapper">

<div id="listView" style="display:block;">

<!--
    <div id="debug" style="white-space: pre-line; font-size:14px; color:#c00; margin-bottom:16px;"></div>
-->

<div id="loadingMask">
  <div class="spinner"></div>

  <div id="text-loading" class="loadingText">è¼‰å…¥ä¸­â€¦</div>
  <div id="text-update" class="loadingText">è³‡æ–™æ›´æ–°ä¸­ï¼Œè«‹è€å¿ƒç­‰å€™â€¦</div>
  <div id="text-init" class="loadingText">è³‡æ–™åˆå§‹åŒ–ä¸­ï¼Œè«‹è€å¿ƒç­‰å€™â€¦</div>

  <!-- éŒ¯èª¤è¨Šæ¯é ç•™ï¼ˆå¯é¸ï¼‰ -->
  <div id="text-error" class="loadingText">ç„¡æ³•é€£ç·šåˆ°è³‡æ–™ä¾†æº</div>
  <div id="text-error-format" class="loadingText">è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡</div>
  <div id="text-error-notfound" class="loadingText">æ‰¾ä¸åˆ°æ‚¨çš„å¿—å·¥è³‡æ–™</div>
</div>

<h2 id="pageTitle" style="display:none;">å›å ±ç´€éŒ„</h2>

<div id="switchArea" style="
  display:none;
  text-align:center;
  margin-top:10px;
  margin-bottom:18px;
">
  <button id="btnTeam" style="
  padding:6px 16px;
  font-size:22px;
  border:2px solid #0b5ed7;
  background:#0b5ed7;
  color:white;
  border-radius:6px;
  margin-right:6px;
">å¤§éšŠç´€éŒ„</button>

<button id="btnSelf" style="
  padding:6px 16px;
  font-size:22px;
  border:2px solid #0b5ed7;
  background:white;
  color:#0b5ed7;
  border-radius:6px;
">æˆ‘çš„ç´€éŒ„</button>
</div>

<div id="adminFilterArea" style="display:none; padding:12px;">

  <!-- å¤§éšŠ -->
  <div style="margin-bottom:12px;">
    <label>å¤§éšŠï¼š</label>

    <!-- åŸç”Ÿ selectï¼šä¿ç•™çµ¦ JS ç”¨ï¼ˆhidden ä¸æœƒè¢«çœ‹åˆ°ï¼‰ -->
    <select id="adminTeamSelect" style="display:none;">
      <option value="å…¨éƒ¨">å…¨éƒ¨</option>
      <option value="1">ç¬¬1å¤§éšŠ</option>
      <option value="2">ç¬¬2å¤§éšŠ</option>
      <option value="3">ç¬¬3å¤§éšŠ</option>
      <option value="4">ç¬¬4å¤§éšŠ</option>
      <option value="5">ç¬¬5å¤§éšŠ</option>
      <option value="6">ç¬¬6å¤§éšŠ</option>
      <option value="7">ç¬¬7å¤§éšŠ</option>
      <option value="8">ç¬¬8å¤§éšŠ</option>
      <option value="9">ç¬¬9å¤§éšŠ</option>
      <option value="10">ç¬¬10å¤§éšŠ</option>
    </select>

    <!-- å½ä¸‹æ‹‰ UI -->
    <button class="fakeSelectBtn" onclick="openDropdown('team')">
  <span id="teamText">å…¨éƒ¨</span>
  <span class="arrow">â–¾</span>
</button>
  </div>

  <!-- ç¯„åœ -->
  <div style="margin-bottom:12px;">
    <label>ç¯„åœï¼š</label>

    <select id="adminDayRange" style="display:none;">
      <option value="3" selected>æœ€è¿‘ 3 å¤©</option>
      <option value="7">æœ€è¿‘ 7 å¤©</option>
      <option value="14">æœ€è¿‘ 14 å¤©</option>
    </select>

    <button class="fakeSelectBtn" onclick="openDropdown('range')">
  <span id="rangeText">æœ€è¿‘ 3 å¤©</span>
  <span class="arrow">â–¾</span>
</button>
  </div>

  <!-- æ™‚é–“ -->
  <div style="margin-bottom:12px;">
    <label>æ™‚é–“ï¼š</label>

    <select id="timeStart" style="display:none;">
      <option value="00:00">00:00</option>
      <option value="01:00">01:00</option>
      <option value="02:00">02:00</option>
      <option value="03:00">03:00</option>
      <option value="04:00">04:00</option>
      <option value="05:00">05:00</option>
      <option value="06:00">06:00</option>
      <option value="07:00">07:00</option>
      <option value="08:00">08:00</option>
      <option value="09:00">09:00</option>
      <option value="10:00">10:00</option>
      <option value="11:00">11:00</option>
      <option value="12:00">12:00</option>
      <option value="13:00">13:00</option>
      <option value="14:00">14:00</option>
      <option value="15:00">15:00</option>
      <option value="16:00">16:00</option>
      <option value="17:00">17:00</option>
      <option value="18:00">18:00</option>
      <option value="19:00">19:00</option>
      <option value="20:00">20:00</option>
      <option value="21:00">21:00</option>
      <option value="22:00">22:00</option>
      <option value="23:00">23:00</option>
    </select>

    <select id="timeEnd" style="display:none;">
      <option value="00:59">00:59</option>
      <option value="01:59">01:59</option>
      <option value="02:59">02:59</option>
      <option value="03:59">03:59</option>
      <option value="04:59">04:59</option>
      <option value="05:59">05:59</option>
      <option value="06:59">06:59</option>
      <option value="07:59">07:59</option>
      <option value="08:59">08:59</option>
      <option value="09:59">09:59</option>
      <option value="10:59">10:59</option>
      <option value="11:59">11:59</option>
      <option value="12:59">12:59</option>
      <option value="13:59">13:59</option>
      <option value="14:59">14:59</option>
      <option value="15:59">15:59</option>
      <option value="16:59">16:59</option>
      <option value="17:59">17:59</option>
      <option value="18:59">18:59</option>
      <option value="19:59">19:59</option>
      <option value="20:59">20:59</option>
      <option value="21:59">21:59</option>
      <option value="22:59">22:59</option>
      <option value="23:59" selected>23:59</option>
    </select>

    <button class="fakeSelectBtn" onclick="openDropdown('timeStart')">
  <span id="timeStartText">00:00</span>
  <span class="arrow">â–¾</span>
</button>
    ï½
    <button class="fakeSelectBtn" onclick="openDropdown('timeEnd')">
  <span id="timeEndText">23:59</span>
  <span class="arrow">â–¾</span>
</button>
  </div>

  <!-- é¡å‹ -->
  <div style="margin-bottom:12px;">
    <label>é¡å‹ï¼š</label>

    <select id="adminTypeSelect" style="display:none;">
      <option value="å…¨éƒ¨">å…¨éƒ¨</option>
      <option value="å¹³æ™‚">å¹³æ™‚</option>
      <option value="ç½ä¸­">ç½ä¸­</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>

    <button class="fakeSelectBtn" onclick="openDropdown('type')">
  <span id="typeText">å…¨éƒ¨</span>
  <span class="arrow">â–¾</span>
</button>
  </div>


  <!-- æœå°‹ -->
  <div style="text-align:center; margin-top:20px;">
    <button id="adminSearchBtn" class="searchBtn">æœå°‹</button>
</div>

</div>

<!-- å…¨è¢å¹•å½ä¸‹æ‹‰é¸å–®ï¼ˆé€™æ®µè²¼é€™è£¡ï¼‰ -->
<div id="fullDropdownMask">
  <div id="fullDropdownPanel">
    <div class="panel-title" id="panelTitle"></div>
    <div class="panel-options" id="panelOptions"></div>
  </div>
</div>

<div id="centerSpinner" style="
  display:none;
  width:100%;
  padding:40px 0;
  justify-content:center;
  align-items:center;
  flex-direction:column;
">
  <div class="spinner"></div>
  <div style="font-size:22px; color:#666; margin-top:10px;">è¼‰å…¥ä¸­...</div>
</div>

<!-- æ¸…å–®çœŸæ­£å‘ˆç¾çš„åœ°æ–¹ï¼Œä¸€é–‹å§‹å…ˆéš±è— -->
<div id="listContainer" style="display: none;"></div>

</div>

<!-- == DetailView è¦†è“‹å±¤ == -->
<div id="detailView" style="
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:#fff;
  z-index:9998;
  overflow:hidden;   /* ä¿è­‰ä¸å‡ºç¾ç™½é‚Š */
  padding:0;
  margin:0;
">

  <!-- == ç„¡é‚Šè· iframe == -->
  <iframe id="detailFrame"
    sandbox="allow-scripts allow-same-origin allow-top-navigation-by-user-activation"
    style="
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:calc(100% - 70px);
      border:0;
      padding:0;
      margin:0;
      display:block;
      background:#fff;
">
</iframe>
</div>

<div style="height:15px"></div>

</div>   <!-- pageWrapper çµæŸ -->

<div id="globalFooter">
  <button class="gray-btn" onclick="backToList()">å›ä¸Šä¸€é </button>
  <button class="red-btn" onclick="handleClosePage()">é—œé–‰é é¢</button>
</div>

<script>

  const VOLUNTEER_API_URL = "https://script.google.com/macros/s/AKfycbxiGSG5hSMO6We-C6cyEJZLgf4Rnbjp-6w9Tmb0qfF9VM6JB4YGEMqj3QRfTzg7Czpc/exec"; 
const REPORT_GAS_URL = "https://script.google.com/macros/s/AKfycbxQzZ6rTNi93dl--WhTB_iPQ_UalC5V4Jhng7ZGXwLGITLAN4prAVpA9JYRlstfqPW28w/exec";

let globalAdminRecords = [];   // ç®¡ç†å“¡ä¸€æ¬¡æŠ“å…¨éƒ¨å¾Œå­˜åœ¨é€™é‚Š
let adminViewDays = 3;        // é è¨­æŠ“æœ€è¿‘å…©é€±ï¼Œå¯æ”¹ 30
let globalNickname = "";
let globalRole = "";
let globalTeam = "";
let globalName = "";  // â˜… å¿…é ˆè£œé€™è¡Œ
let viewMode = "team";  // self = çœ‹è‡ªå·±, team = çœ‹å¤§éšŠ
let shouldKeepMask = false;
let restoredOnce = false;
let isInitialLoad = true;
let globalRecords = [];

// === é˜²æ­¢å›ä¸Šä¸€é é‡æ–°åˆå§‹åŒ–ï¼ˆBFCache æ”¯æ´ï¼‰ ===
window.addEventListener("pageshow", function (event) {
  if (event.persisted) {
    console.log("BFCache restore â†’ ä¸åŸ·è¡Œ main()");
    return;
  }
});

// === åªåœ¨æœ¬é ç¬¬ä¸€æ¬¡é–‹å•Ÿæ™‚åŸ·è¡Œ main() ===
if (!sessionStorage.getItem("initialized")) {
  main();
  sessionStorage.setItem("initialized", "1");
} else {
  console.log("å·²åˆå§‹åŒ–é â†’ ä¸å†åŸ·è¡Œ main()");
}

function debug(msg) {
  try {
    const box = document.getElementById("debug");
    if (box) box.textContent += msg + "\n";
  } catch (e) {}
}

  /* ------------------------------------------
      1. åˆå§‹åŒ–ï¼šç™»å…¥ LIFF ä¸¦å–å¾—è³‡æ–™
  -------------------------------------------*/
  async function main() {

  globalNickname = localStorage.getItem("nickname") || "";
  globalName     = localStorage.getItem("name") || "";
  globalTeam     = localStorage.getItem("team") || "";
  globalRole     = localStorage.getItem("role") || "å¿—å·¥";

  if (!globalName) globalName = globalNickname;

  if (globalRole === "ç®¡ç†å“¡") {
    viewMode = "admin";
    loadAdminRecords();
    return;
  }

  if (globalRole === "å¤§éšŠé•·") {
    viewMode = "team";
    loadRecordList("team");
    return;
  }

  viewMode = "self";
  loadRecordList("self");
}

function openDetail(url) {

  // åˆ‡æ›ç•«é¢
  document.getElementById("listView").style.display = "none";
  document.getElementById("detailView").style.display = "block";

  const iframe = document.getElementById("detailFrame");
  iframe.src = url;

  // ç­‰ Display çš„å…§å®¹è¼‰å…¥å¾Œï¼Œæ¥ç®¡è¿”å›æŒ‰éˆ•
  iframe.onload = () => {
    try {
      const backBtn = iframe.contentDocument.querySelector("#backBtn");
      if (backBtn) {
        backBtn.onclick = () => window.parent.backToList();
      }
    } catch(e) {
      console.warn("ç„¡æ³•åƒè¨ª iframeï¼ˆå¯èƒ½è·¨åŸŸï¼‰", e);
    }
  };
}

function backToList() {
  document.getElementById("detailView").style.display = "none";
  document.getElementById("listView").style.display = "block";

  // å›åˆ—è¡¨ä½ç½®å®Œå…¨ä¸è®Šï¼Œä¸ç”¨ä½ ç®¡
}

async function loadAdminRecords() {

  const url = `${REPORT_GAS_URL}?action=listAdminFull&days=30`;

  let json;
  try {
    const res = await fetch(url);
    const text = await res.text();
    json = JSON.parse(text);
  } catch (e) {
    document.getElementById("listContainer").innerHTML = "ç®¡ç†å“¡è³‡æ–™è¼‰å…¥å¤±æ•—";
    shouldKeepMask = false;
    document.getElementById("loadingMask").style.display = "none";
    return;
  }

  globalAdminRecords = json.records || [];

  const filtered = filterAdminRecords();
  renderList(filtered);

  // â˜… renderList çµæŸå¾Œï¼Œé—œæ‰å¤§ loading
  if (shouldKeepMask) {
    shouldKeepMask = false;
    document.getElementById("loadingMask").style.display = "none";
  }

  isInitialLoad = false;   // â˜… ç¬¬ä¸€æ¬¡è¼‰å…¥çµæŸ
}

  /* ------------------------------------------
      3. å¾ GAS å–å¾—å›å ±è¨˜éŒ„ï¼ˆæœªä¾†ä¸² APIï¼‰
  -------------------------------------------*/
  async function loadRecordList(mode = "self") {
  let url = "";

  if (mode === "self") {
    url = `${REPORT_GAS_URL}?action=listMyReports&nickname=${globalNickname}`;
  } else if (mode === "team") {
    url = `${REPORT_GAS_URL}?action=listTeamReports&nickname=${globalNickname}`;
  }

  let res = await fetch(url);
  let text = await res.text();

  if (text.startsWith("callback")) {
    text = text.replace(/^callback\(/, "").replace(/\);$/, "");
  }

  const json = JSON.parse(text);

  globalRecords = json.records || [];

  // â­ æ¸²æŸ“å®Œæˆå¾Œæ‰å…è¨±é—œé–‰ LoadingMask
  renderList(globalRecords);

  if (shouldKeepMask) {
    shouldKeepMask = false;
    document.getElementById("loadingMask").style.display = "none";
  }

  updateSwitchUI();
}

  /* ------------------------------------------
      4. æ¸²æŸ“ã€Œå¹´åº¦ â†’ æœˆä»½ â†’ æ—¥æœŸ â†’ ç´€éŒ„ã€
  -------------------------------------------*/
  function normalizeDate(dateStr) {
  // è‹¥æ˜¯ ISO æ ¼å¼ï¼š2025-11-11T16:00:00.000Z
  if (dateStr.includes("T")) {
    const d = new Date(dateStr);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}/${mm}/${dd}`;
  }
  return dateStr; // è‹¥æœ¬ä¾†å°±æ˜¯ yyyy/mm/dd
}

function filterAdminRecords() {
  let records = [...globalAdminRecords];

  // 1. ç¯©é¸å¤§éšŠ
let targetTeam = document.getElementById("adminTeamSelect")?.value;

// iOS hidden select = "" â†’ å¿…é ˆè£œæ•‘
if (!targetTeam) {
  targetTeam = document.getElementById("teamText").innerText || "å…¨éƒ¨";
}

if (targetTeam !== "å…¨éƒ¨") {
  records = records.filter(r => (r.æ‰€å±¬å¤§éšŠ + "") === targetTeam);
}

  // 2. ç¯„åœç¯©é¸ï¼ˆé‡è¦ï¼šå¾ä¸‹æ‹‰é¸å–®è®€å–ï¼‰
  const dayRangeSelect = document.getElementById("adminDayRange");
  let selectedDays = dayRangeSelect?.value;
if (!selectedDays) selectedDays = document.getElementById("rangeText").innerText.replace("æœ€è¿‘ ", "").replace(" å¤©", "");
  adminViewDays = Number(selectedDays);
  
  console.log("ç¯©é¸å¤©æ•¸:", adminViewDays); // é™¤éŒ¯ç”¨
  
  const now = new Date();
  const cutoff = new Date(now.getTime() - adminViewDays * 24 * 60 * 60 * 1000);

  records = records.filter(r => {
    let ds = normalizeDate(r.æ—¥æœŸ);
    const recordDate = new Date(ds);
    return recordDate >= cutoff;
  });

  // 3. ç¯©é¸é€šå ±é¡å‹
  let targetType = document.getElementById("adminTypeSelect")?.value || "å…¨éƒ¨";
  if (targetType !== "å…¨éƒ¨") {
    records = records.filter(r => {
      const type = (r.é€šå ±é¡å‹ || "").trim();
      return type === targetType;
    });
  }

  // 4. æ™‚é–“ç¯©é¸
  const start = document.getElementById("timeStart")?.value || "00:00";
const end   = document.getElementById("timeEnd")?.value || "23:59";

const [startHour, startMinute] = start.split(":").map(Number);
const [endHour, endMinute] = end.split(":").map(Number);

const startTotal = startHour * 60 + startMinute;
const endTotal = endHour * 60 + endMinute;

records = records.filter(r => {
  const link = r.è©³ç´°ç´€éŒ„ || "";
  const match = link.match(/report_(\d+)/);
  if (!match) return false;

  const t = parseInt(match[1], 10);
  const d = new Date(t);
  const h = d.getHours();
  const m = d.getMinutes();
  
  const recordTotal = h * 60 + m;

  if (startTotal <= endTotal) {
    return recordTotal >= startTotal && recordTotal <= endTotal;
  } else {
    return recordTotal >= startTotal || recordTotal <= endTotal;
  }
});

  console.log("ç¯©é¸å¾Œç­†æ•¸:", records.length); // é™¤éŒ¯ç”¨
  return records;
}

function renderList(records) {
  const container = document.getElementById("listContainer");
  const spinner = document.getElementById("centerSpinner");
  const mask = document.getElementById("loadingMask");

  // åˆå§‹åŒ–æ™‚éš±è—åˆ—è¡¨å’Œ spinnerï¼Œä¿æŒè¼‰å…¥ä¸­é®ç½©
  container.style.display = "none";
  spinner.style.display = "none";

  // ç®¡ç†å“¡æ¨¡å¼ï¼šç¢ºä¿ç¯©é¸å€åŸŸé¡¯ç¤º
  if (globalRole === "ç®¡ç†å“¡" && viewMode === "admin") {
    document.getElementById("adminFilterArea").style.display = "block";
  } else {
    document.getElementById("adminFilterArea").style.display = "none";
  }

  // åªæœ‰åœ¨åˆ‡æ›æ¨¡å¼æ™‚æ‰é¡¯ç¤ºå° spinner
  if (!isInitialLoad) {
    spinner.style.display = "flex";
    container.style.display = "none";
  } else {
    spinner.style.display = "none";
  }

  // â­â­â­ ç®¡ç†å“¡å‰ç«¯å¿«ç¯©ï¼šåªåœ¨ admin æ¨¡å¼ä¸‹åŸ·è¡Œ â­â­â­
  if (globalRole === "ç®¡ç†å“¡" && viewMode === "admin") {
    if (globalAdminRecords.length > 0) {
      let targetTeam = document.getElementById("adminTeamSelect")?.value || "å…¨éƒ¨";
      if (targetTeam !== "å…¨éƒ¨") {
        records = records.filter(r => (r.æ‰€å±¬å¤§éšŠ + "") === targetTeam);
      }

      const now = new Date();
      const cutoff = new Date(now.getTime() - adminViewDays * 24 * 60 * 60 * 1000);

      records = records.filter(r => {
        let ds = normalizeDate(r.æ—¥æœŸ);
        return new Date(ds) >= cutoff;
      });
    }
  } else {
    document.getElementById("adminFilterArea").style.display = "none";
  }

  let finalRecords = records;

  if (viewMode === "self") {
    finalRecords = records.filter(r => {
      return (r.å›å ±è€… || "").trim() === globalName;
    });
  }

  globalRecords = records;

  debug("STEP3: é€²å…¥ renderListï¼Œé¡¯ç¤ºç­†æ•¸=" + finalRecords.length);

  container.innerHTML = "";

  const now2 = new Date();
  const currentYear = now2.getFullYear() - 1911;
  const currentMonth = now2.getMonth() + 1;

  const grouped = {};
  for (let m = 1; m <= 12; m++) grouped[m] = {};

  finalRecords.forEach(r => {
    const normalized = normalizeDate(r.æ—¥æœŸ);
    debug("STEP3-æ—¥æœŸä¿®æ­£ï¼š" + r.æ—¥æœŸ + " â†’ " + normalized);

    const dateParts = normalized.split("/");
    const m = parseInt(dateParts[1], 10);
    const d = parseInt(dateParts[2], 10);

    if (!grouped[m][d]) grouped[m][d] = [];
    grouped[m][d].push(r);
  });

  debug("STEP3-1: æ—¥æœŸåˆ†çµ„å®Œæˆ");

  const yearBlock = createBlock(`${currentYear} å¹´`, "year");
  const yearContent = yearBlock.querySelector(".content");

  const months = Object.keys(grouped)
    .map(m => parseInt(m, 10))
    .filter(m => Object.keys(grouped[m]).length > 0)
    .filter(m => m <= currentMonth)
    .sort((a, b) => b - a);

  debug("STEP3-2 é¡¯ç¤ºæœˆä»½æ’åˆ— = " + months.join(", "));

  months.forEach(month => {
    const monthBlock = createBlock(`${month} æœˆ`, "month");
    const monthContent = monthBlock.querySelector(".content");

    const days = Object.keys(grouped[month]).sort((a, b) => b - a);

    if (days.length === 0) {
      const emptyDiv = document.createElement("div");
      emptyDiv.className = "record";
      emptyDiv.textContent = "æœ¬æœˆç„¡å·¡è¦–ç´€éŒ„";
      monthContent.appendChild(emptyDiv);
    } else {
      days.forEach(day => {
        const dayBlock = createBlock(`${day} æ—¥`, "day");
        const dayContent = dayBlock.querySelector(".content");

        grouped[month][day].forEach(record => {
          const div = document.createElement("div");
          div.className = "record";

          let hh = "--", mm = "--";

          try {
            const match = record.è©³ç´°ç´€éŒ„.match(/report_(\d+)/);
            if (match) {
              const t = parseInt(match[1], 10);
              const dateObj = new Date(t);

              hh = String(dateObj.getHours()).padStart(2, "0");
              mm = String(dateObj.getMinutes()).padStart(2, "0");
            }
          } catch (e) {
            console.warn("ç„¡æ³•è§£ææ™‚é–“ï¼š", record.è©³ç´°ç´€éŒ„);
          }

          const status = (record.ç‹€æ…‹ || "").trim();
          const isAbnormal = status === "ç•°å¸¸";

          const timeText = document.createElement("span");
          timeText.textContent = `${hh}:${mm}ï½œ${status}`;
          div.appendChild(timeText);

          if ((viewMode === "team" || viewMode === "admin") && record.å›å ±è€… && record.å›å ±è€….trim()) {
            const nameSpan = document.createElement("span");
            nameSpan.textContent = `ï½œ${record.å›å ±è€…}`;
            div.appendChild(nameSpan);
          }

          if (isAbnormal) {
            const dot = document.createElement("span");
            dot.className = "status-dot";
            div.appendChild(dot);
          }

          div.onclick = () => {
            openDetail(record.è©³ç´°ç´€éŒ„);
          };

          dayContent.appendChild(div);
        });

        monthContent.appendChild(dayBlock);
      });
    }

    yearContent.appendChild(monthBlock);
  });

  container.appendChild(yearBlock);

  // --- æ¸²æŸ“å®Œæˆ ---
  document.getElementById("loadingMask").style.display = "none";
  container.style.display = "block";

  if (spinner) spinner.style.display = "none";

  if (globalRole === "å¤§éšŠé•·" || globalRole === "ç®¡ç†å“¡") {
    document.getElementById("switchArea").style.display = "block";
  }

  updateSwitchUI();
  document.getElementById("pageTitle").style.display = "block";

  // â˜…â˜…â˜… é—œéµä¿®æ”¹ï¼šç¢ºä¿ç‹€æ…‹æ¢å¾©åªåœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“æ™‚åŸ·è¡Œï¼Œä¸”æ™‚æ©Ÿæ­£ç¢º
  setTimeout(() => {
    if (!restoredOnce) {
      restoreListState();
      restoredOnce = true;
    } else {
      // éç¬¬ä¸€æ¬¡æ¸²æŸ“æ™‚ï¼Œè‡ªå‹•å±•é–‹å¹´ä»½å€å¡Š
      const yearHeader = document.querySelector('.year-block .header');
      if (yearHeader && yearHeader.nextElementSibling.style.display !== 'block') {
        yearHeader.click();
      }
    }
  }, 50); // ç¨å¾®å»¶é²ç¢ºä¿ DOM å®Œå…¨æ¸²æŸ“

  isInitialLoad = false;

  debug("STEP3 å®Œæˆï¼šåˆ—è¡¨æ¸²æŸ“æˆåŠŸ");
}

function saveListState() {
  // å–å¾—æ‰€æœ‰å±•é–‹çš„å€å¡Š
  const opened = [];

  document.querySelectorAll(".year-block, .month-block, .day-block").forEach(block => {
    const content = block.querySelector(".content");
    if (content && content.style.display === "block") {
      opened.push(block.querySelector(".header span").textContent.trim());
    }
  });

  const state = {
    openedBlocks: opened,
    scroll: window.scrollY
  };

  localStorage.setItem("cleanListState", JSON.stringify(state));
}

function restoreListState() {
  const cache = localStorage.getItem("cleanRestore");
  if (!cache) return;

  const state = JSON.parse(cache);
  const opened = state.openedBlocks || [];

  // æ¢å¾©å±•é–‹
  opened.forEach(text => {
    const headers = document.querySelectorAll(".header span");
    headers.forEach(h => {
      if (h.textContent.trim() === text) {
        const block = h.closest(".year-block, .month-block, .day-block");
        const content = block.querySelector(".content");
        const icon = block.querySelector(".toggle-icon");

        content.style.display = "block";
        icon.innerHTML = `
          <svg width="40" height="40" viewBox="0 0 24 24">
            <path fill="#666" d="M5 16l7-8 7 8z"/>
          </svg>`;
      }
    });
  });

  // æ¢å¾©æ²å‹•ä½ç½®
  setTimeout(() => {
    window.scrollTo(0, state.scroll || 0);
  }, 10);
}

  /* ------------------------------------------
      5. å·¥å…·ï¼šå»ºç«‹å¯æ”¶åˆå€å¡Š
  -------------------------------------------*/
  function createBlock(title, level) {
  const block = document.createElement("div");
  block.className = level + "-block";

  const header = document.createElement("div");
  header.className = "header";

  const titleSpan = document.createElement("span");
  titleSpan.textContent = title;

  // â–¼ï¼ˆé è¨­æ”¶èµ·ç”¨ï¼‰
  const icon = document.createElement("span");
  icon.className = "toggle-icon";
  icon.innerHTML = `
  <svg width="40" height="40" viewBox="0 0 24 24">
    <path fill="#666" d="M5 8l7 8 7-8z"/>
  </svg>
`;

  const content = document.createElement("div");
  content.className = "content";
  content.style.display = "none";

  header.appendChild(titleSpan);
  header.appendChild(icon);

  header.onclick = () => {
  const willOpen = content.style.display !== "block";

  content.style.display = willOpen ? "block" : "none";

  icon.innerHTML = willOpen
    ? `<svg width="40" height="40" viewBox="0 0 24 24">
         <path fill="#666" d="M5 16l7-8 7 8z"/>  <!-- å‘ä¸Š -->
       </svg>`
    : `<svg width="40" height="40" viewBox="0 0 24 24">
         <path fill="#666" d="M5 8l7 8 7-8z"/>  <!-- å‘ä¸‹ -->
       </svg>`;
};

  block.appendChild(header);
  block.appendChild(content);

  return block;
}

document.getElementById("btnSelf").onclick = function () {
  viewMode = "self";
  
  // ç«‹å³æ›´æ–°æŒ‰éˆ•æ¨£å¼
  updateSwitchUI();
  
  // éš±è—ç®¡ç†å“¡ç¯©é¸å€åŸŸ
  document.getElementById("adminFilterArea").style.display = "none";

  // é¡¯ç¤ºè¼‰å…¥ä¸­
  renderLoadingInList();
  
  // è¼‰å…¥å€‹äººç´€éŒ„
  loadRecordList("self");
};

document.getElementById("btnTeam").onclick = async function () {
  // å¤§éšŠé•· â†’ è®€è‡ªå·±çš„å¤§éšŠ
  if (globalRole === "å¤§éšŠé•·") {
    viewMode = "team";
    updateSwitchUI(); // ç«‹å³æ›´æ–°æŒ‰éˆ•æ¨£å¼
    document.getElementById("adminFilterArea").style.display = "none";
    renderLoadingInList();
    loadRecordList("team");
    return;
  }

  // ç®¡ç†å“¡ â†’ Admin æ¨¡å¼
  if (globalRole === "ç®¡ç†å“¡") {
    viewMode = "admin";
    updateSwitchUI(); // ç«‹å³æ›´æ–°æŒ‰éˆ•æ¨£å¼
    renderLoadingInList();

    // å¦‚æœé‚„æ²’æœ‰ç®¡ç†å“¡è³‡æ–™ï¼Œå…ˆè¼‰å…¥
    if (globalAdminRecords.length === 0) {
      await loadAdminRecords();
    } else {
      // å¦‚æœå·²ç¶“æœ‰è³‡æ–™ï¼Œç›´æ¥é¡¯ç¤ºç¯©é¸å’Œæ¸²æŸ“
      document.getElementById("adminFilterArea").style.display = "block";
      const filtered = filterAdminRecords();
      renderList(filtered);
    }
  }
};

document.getElementById("adminSearchBtn").onclick = () => {
  if (viewMode !== "admin") return;

  // é¡¯ç¤ºè¼‰å…¥ä¸­
  renderLoadingInList();

  // ä½¿ç”¨ç¾æœ‰è³‡æ–™é€²è¡Œå‰ç«¯ç¯©é¸
  setTimeout(() => {
    const filtered = filterAdminRecords();
    renderList(filtered);
  }, 100); // ç¨å¾®å»¶é²è®“è¼‰å…¥å‹•ç•«é¡¯ç¤º
};

// æŒ‰éˆ•è¦–è¦ºåˆ‡æ›
function updateSwitchUI() {
  const btnSelf = document.getElementById("btnSelf");
  const btnTeam = document.getElementById("btnTeam");

  // é‡ç½®æ‰€æœ‰æŒ‰éˆ•æ¨£å¼
  btnSelf.style.background = "white";
  btnSelf.style.color = "#0b5ed7";
  btnTeam.style.background = "white";
  btnTeam.style.color = "#0b5ed7";

  // æ ¹æ“šç•¶å‰æ¨¡å¼è¨­å®šæ¿€æ´»ç‹€æ…‹
  if (viewMode === "self") {
    btnSelf.style.background = "#0b5ed7";
    btnSelf.style.color = "white";
  } else if (viewMode === "team" || viewMode === "admin") {
    btnTeam.style.background = "#0b5ed7";
    btnTeam.style.color = "white";
  }

  // â˜…â˜…â˜… åœ¨é€™è£¡åŠ å…¥å³å¯ â˜…â˜…â˜…
  applyAdminButtonFix();
}

function applyAdminButtonFix() {
  const btnSelf = document.getElementById("btnSelf");

  // åªåœ¨ã€Œç®¡ç†å“¡ + admin æ¨¡å¼ã€ä¸‹å•Ÿå‹•
  if (globalRole === "ç®¡ç†å“¡" && viewMode === "admin") {

    // æŒ‰éˆ•æ–‡å­—
    btnSelf.textContent = "æ­·å²å ±è¡¨";

    // ----- æœªé¸ä¸­ç‹€æ…‹ï¼ˆç™½åº•ç¶ æ¡†ï¼‰ -----
    btnSelf.style.background = "white";
    btnSelf.style.color = "#28a745";
    btnSelf.style.border = "2px solid #28a745";

    // hoverï¼ˆé‚„æ˜¯ç™½åº•ï¼Œåªæ˜¯é¡è‰²å¾®è®Šï¼‰
    btnSelf.onmouseover = () => {
      btnSelf.style.background = "#f1fdf1";
    };
    btnSelf.onmouseout = () => {
      // è‹¥ç›®å‰ä»æœªé¸ä¸­ â†’ å›åˆ°ç™½åº•ç¶ å­—
      if (viewMode === "admin") {
        btnSelf.style.background = "white";
        btnSelf.style.color = "#28a745";
      }
    };

    // ----- é»æ“Šå¾Œè®Šæˆé¸ä¸­ç‹€æ…‹ï¼ˆç¶ åº•ç™½å­—ï¼‰ -----
    btnSelf.onclick = () => {
      // ç¶ åº•ç™½å­—
      btnSelf.style.background = "#28a745";
      btnSelf.style.color = "white";

      // ç«‹å³é–‹å•Ÿæ­·å²å ±è¡¨
      window.open(
        "https://docs.google.com/spreadsheets/d/1GEjlfTy73kgZnMYrM0AHjnYIs1EPLIOQLCqsEE8BMAw/edit?gid=0#gid=0",
        "_blank"
      );
    };
  }
}

function showLoadingMask() {
  document.getElementById("loadingMask").style.display = "flex";
}

function renderLoadingInList() {
  const container = document.getElementById("listContainer");
  const spinner = document.getElementById("centerSpinner");

  container.style.display = "none";
  spinner.style.display = "flex";

  // ä¸è¦é¡¯ç¤ºå¤§é®ç½©
  document.getElementById("loadingMask").style.display = "none";
}

// æŸ¥çœ‹å®Œæ•´ç´€éŒ„æŒ‰éˆ•äº‹ä»¶
/*document.getElementById("viewFullRecords").onclick = function() {
  window.open("https://docs.google.com/spreadsheets/d/1GEjlfTy73kgZnMYrM0AHjnYIs1EPLIOQLCqsEE8BMAw/edit?gid=0#gid=0", "_blank");
};*/

// å½ˆçª—è³‡æ–™è¡¨
const dropdownData = {
  team: {
    title: "é¸æ“‡å¤§éšŠ",
    target: "teamText",
    input: "adminTeamSelect",
    options: [
      {value:"å…¨éƒ¨", text:"å…¨éƒ¨"},
      {value:"1", text:"ç¬¬1å¤§éšŠ"},
      {value:"2", text:"ç¬¬2å¤§éšŠ"},
      {value:"3", text:"ç¬¬3å¤§éšŠ"},
      {value:"4", text:"ç¬¬4å¤§éšŠ"},
      {value:"5", text:"ç¬¬5å¤§éšŠ"},
      {value:"6", text:"ç¬¬6å¤§éšŠ"},
      {value:"7", text:"ç¬¬7å¤§éšŠ"},
      {value:"8", text:"ç¬¬8å¤§éšŠ"},
      {value:"9", text:"ç¬¬9å¤§éšŠ"},
      {value:"10", text:"ç¬¬10å¤§éšŠ"},
    ]
  },

  range: {
    title: "é¸æ“‡ç¯„åœ",
    target: "rangeText",
    input: "adminDayRange",
    options: [
      {value:"3", text:"æœ€è¿‘ 3 å¤©"},
      {value:"7", text:"æœ€è¿‘ 7 å¤©"},
      {value:"14", text:"æœ€è¿‘ 14 å¤©"}
    ]
  },

  type: {
    title: "é¸æ“‡é¡å‹",
    target: "typeText",
    input: "adminTypeSelect",
    options: [
      {value:"å…¨éƒ¨", text:"å…¨éƒ¨"},
      {value:"å¹³æ™‚", text:"å¹³æ™‚"},
      {value:"ç½ä¸­", text:"ç½ä¸­"},
      {value:"å…¶ä»–", text:"å…¶ä»–"}
    ]
  },

  timeStart: {
    title: "é–‹å§‹æ™‚é–“",
    target: "timeStartText",
    input: "timeStart",
    options: Array.from({length:24}).map((_,i)=>({
      value: `${String(i).padStart(2,'0')}:00`,
      text: `${String(i).padStart(2,'0')}:00`
    }))
  },

  timeEnd: {
    title: "çµæŸæ™‚é–“",
    target: "timeEndText",
    input: "timeEnd",
    options: Array.from({length:24}).map((_,i)=>({
      value: `${String(i).padStart(2,'0')}:59`,
      text: `${String(i).padStart(2,'0')}:59`
    }))
  }
};

// é–‹å•Ÿ
function openDropdown(type){
  const info = dropdownData[type];
  if (!info) return;

  document.getElementById("panelTitle").textContent = info.title;

  const box = document.getElementById("panelOptions");
  box.innerHTML = "";

  const currentSelectedValue = document.getElementById(info.input).value;

  info.options.forEach(opt => {
    const div = document.createElement("div");
    div.className = "option";
    div.textContent = opt.text;

    // è‹¥èˆ‡ select ç›®å‰çš„å€¼ç›¸åŒ â†’ å¥—ç”¨é¸å–æ¨£å¼
    if (opt.value == currentSelectedValue) {
      div.classList.add("selected");
    }

    div.onclick = () => {
  document.getElementById(info.target).textContent = opt.text;
  document.getElementById(info.input).value = opt.value;

  // æ¸…æ‰æ‰€æœ‰é¸å–ç‹€æ…‹
  document.querySelectorAll(".option").forEach(o => {
    o.classList.remove("selected");
  });

  // â˜†â˜†â˜† ä¸€æ¬¡åŠ  selected â†’ è—åº•ï¼‹è—é»åŒä¸€å€‹ frame ä¸€èµ·äº®
  div.classList.add("selected");

  // å¢åŠ äººçœ¼å¯è¾¨è­˜çš„å»¶é²ï¼ˆ150â€“180msï¼‰
  setTimeout(() => {
    closeDropdown();
  }, 180);
};

    box.appendChild(div);
  });

  document.getElementById("fullDropdownMask").style.display = "flex";
  lockBodyScroll();
}

function closeDropdown(){
  document.getElementById("fullDropdownMask").style.display = "none";
  unlockBodyScroll();
}

/* é»é»‘åº•é—œé–‰ */
document.getElementById("fullDropdownMask").addEventListener("click", function(e){
  if (e.target.id === "fullDropdownMask") closeDropdown();
});

let scrollTopCache = 0;

function lockBodyScroll() {
  scrollTopCache = window.scrollY || document.documentElement.scrollTop;
  document.body.style.position = "absolute";
  document.body.style.top = `-${scrollTopCache}px`;
  document.body.style.left = "0";
  document.body.style.right = "0";
  document.body.style.overflow = "hidden";
}

function unlockBodyScroll() {
  document.body.style.position = "";
  document.body.style.top = "";
  document.body.style.left = "";
  document.body.style.right = "";
  document.body.style.overflow = "";
  window.scrollTo(0, scrollTopCache);
}

  /*
alert("adminTeamSelect:", document.getElementById("adminTeamSelect"));
alert("viewFullRecords:", document.getElementById("viewFullRecords"));
alert("fullDropdownMask:", document.getElementById("fullDropdownMask"));
*/

function handleClosePage() {
  if (window.liff && window.liff.isInClient()) {
    liff.closeWindow(); // LINE å…§ â†’ æ­£ç¢ºé—œé–‰
  } else {
    window.location.href = "about:blank"; // å¤–éƒ¨ç€è¦½å™¨ â†’ å¼·åˆ¶é›¢é–‹
  }
}
</script>

</body>
</html>
