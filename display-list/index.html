<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>é˜²æ±›é€šå ±ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f8ff;
      padding: 16px;
    }

    h2 {
      text-align: center;
      margin-bottom: 24px;
    }

    .year-block, .month-block, .day-block {
      border: 1px solid #d0d7e2;
      border-radius: 8px;
      background: white;
      margin-bottom: 4px;
      overflow: hidden;
    }

    .header {
      padding: 12px 16px;
      background: #e8eef8;
      cursor: pointer;
      font-size: 22px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toggle-icon svg {
  width: 26px;
  height: 26px;
  color: #333;
}

/* å±•é–‹å¾Œ header çš„ä¸‹æ–¹è¦ç•™è·é›¢ */
.header + .content {
  margin-top: 4px;
}

    .content {
      display: none;
      padding: 0 16px 12px;
    }

    .record {
  display: flex;
  align-items: center;
  font-size: 18px;
  padding: 10px 0;
  border-bottom: 1px solid #eee;
  gap: 6px;
  cursor: pointer;
}

    .record:last-child {
      border-bottom: none;
    }

    /* è®“æ‰€æœ‰å€å¡Šä¹‹é–“ä¿æŒè·é›¢ */
.year-block, .month-block, .day-block {
  margin-bottom: 14px;
}

/* è®“å±•é–‹çš„å…§å®¹ä¸æœƒç·Šè²¼ header */
.content {
  margin-top: 6px;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: #E53935;
}

/* === ä¿®æ­£å±•é–‹å¾Œçš„å€å¡Šé–“è· === */
/* å±•é–‹å¾Œçš„å¤–æ¡†ä¿ç•™è¼ƒå¤§ç©ºéš™ */
.block-open {
  margin-bottom: 12px !important;
}

/* è®“å±•é–‹å¾Œçš„ content æœ‰å…§è·ï¼Œé¿å…é»ä½ */
.year-block > .content,
.month-block > .content,
.day-block > .content {
  padding-top: 10px;
}

/* æ—¥æœŸå±•é–‹å¾Œçš„ç´€éŒ„å­—é«”åŠ å¤§ */
.day-block .record {
  font-size: 20px;    /* ä½ å¯æ”¹æˆ 20 / 24 */
}

/* æœ¬æœˆç„¡å·¡è¦–ç´€éŒ„ å­—é«”èˆ‡ä¸€èˆ¬ç´€éŒ„ä¸€è‡´ */
.month-block .record {
  font-size: 20px;
}

#loadingMask {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.35);
  display: none;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  font-size: 28px;
  color: white;
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #eee;
  border-top: 4px solid #0b5ed7;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 14px;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to    { transform: rotate(360deg); }
}

.loadingText {
  display: none;
}

#listContainer {
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
}

#switchArea {
  display: flex;
  justify-content: space-between;  /* å·¦å³æ’åˆ— */
  text-align: center;
  margin-top:10px;
  margin-bottom:18px;
}

#adminFilterArea select {
  font-size: 20px;
  padding: 6px;
}
#adminFilterArea label {
  font-size: 20px;
}

#adminSearchBtn, #viewFullRecords {
  padding: 8px 14px; /* æ›´å° */
  font-size: 20px;    /* æ›´å° */
  border: none;
  color: white;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  flex: none !important;    /* ä¸è¦è¢«æ’å¤§ */
  width: auto !important;  /* è‡ªå‹•ç¸® */
  display: inline-block;    /* ä¸è¦ä½”æ»¿ */
}

#adminSearchBtn {
  background: #0b5ed7;
  width: 110px !important; /* â˜… å°ä¸€é» */
  margin: 0 auto !important;
  display: block !important;
}

#adminSearchBtn:hover {
  background: #0a58ca;
  transform: translateY(-1px);
}
/* ğŸ”¥ æ–°å¢ active ç‹€æ…‹ */
#adminSearchBtn:active {
  background: #0953c0;
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#viewFullRecords {
  background: #28a745;
}

#viewFullRecords:hover {
  background: #218838;
  transform: translateY(-1px);
}
/* ğŸ”¥ æ–°å¢ active ç‹€æ…‹ */
#viewFullRecords:active {
  background: #1e7e34;
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* å½ä¸‹æ‹‰æŒ‰éˆ• */
.fakeSelectBtn {
  font-size: 20px;
  padding: 4px 12px;
  border: 1px solid #888;
  border-radius: 4px;
  background: #fff;
  color: #333;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: space-between;
  min-width: 110px;
  box-sizing: border-box;
}
/* ğŸ”¥ æ–°å¢ active ç‹€æ…‹ */
.fakeSelectBtn:active {
  background: #f7f7f7 !important;
  /* ä¿æŒ translateY(0) é˜²æ­¢æ‰‹æ©Ÿä¸Šè¢« desktop çš„ transform å½±éŸ¿ */
  transform: translateY(0); 
}

/* å½ä¸‹æ‹‰é¸å–®å…§æ–‡å­—æ”¹æˆåŒè‰² */
.fakeSelectBtn span {
  font-weight: normal !important;
}

/* å›ºå®šç®­é ­ï¼Œä¸éš¨å­—é«”æ¯”ä¾‹è®Šå½¢ */
.fakeSelectBtn .arrow {
  display: inline-block;
  width: 18px;
  height: 18px;
  font-size: 18px;
  line-height: 18px;
  text-align: center;
  margin-left: 6px;
  flex-shrink: 0; /* â­ ä¸è¦è¢«æ“ å£“è®Šå½¢ */
}

.timeRow {
  display: flex;
  align-items: center;
  gap: 10px;
}

.timeRow .fakeSelectBtn {
  height: 42px;
  padding: 0 12px;
  display: flex;
  align-items: center;
}

.tilde {
  font-size: 20px;
  line-height: 1;
  padding: 0 2px;
}

/* â˜…â˜…â˜… iOS 100vh ä¿®æ­£ï¼šä½¿ç”¨ 100dvh + å¼·åˆ¶è¦†è“‹å…¨ç‰ˆ â˜…â˜…â˜… */
#fullDropdownMask {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100dvh;     /* ä½¿ç”¨å‹•æ…‹ viewport é«˜åº¦ï¼ŒiOS æ‰ä¸æœƒæ¼åº• */
  background: rgba(0,0,0,0.45);

  z-index: 100001;

  display: none;
  justify-content: center;
  align-items: center;

  padding: 30px;
  box-sizing: border-box;

  /* â˜… ä¿è­‰ä¸å—çˆ¶å®¹å™¨ overflow å½±éŸ¿ï¼Œä¸è¦è®“å®ƒè¢« clip */
  pointer-events: auto;
}

/* å½ˆå‡ºå¡ç‰‡ï¼ˆå‡ç´šç‰ˆï¼šæ›´é«˜ã€æ›´å¤§ï¼‰ */
#fullDropdownPanel {
  width: 92%;              /* å¡ç‰‡æ›´å¯¬ï¼Œä½†ä¸æ»¿ç‰ˆ */
  max-width: 520px;        /* å¤§è¢å¹•ä¸Šä»ç„¶ä¸æœƒå¤ªå¤§ */
  max-height: 95%;        /* ğŸ”¥ å¡ç‰‡å¯è®Šæ›´å¤§ï¼ˆåŸæœ¬ 60% â†’ 75%ï¼‰ */
  background: #fff;
  border-radius: 20px;
  padding: 14px 0;
  overflow-y: auto;
  box-shadow: 0 6px 26px rgba(0,0,0,0.3);
}
    
/* æ¨™é¡Œï¼ˆå¾®ç¸®ï¼‰ */
.panel-title {
  font-size: 20px;        /* åŸæœ¬ 22 â†’ ç¾åœ¨ 20 */
  font-weight: bold;
  padding: 0 20px 14px;
  margin-bottom: 6px;
  border-bottom: 1px solid #eee;
}

/* é¸é …ï¼ˆå¾®ç¸®ï¼‰ */
.panel-options .option {
  padding: 14px 20px;    /* åŸæœ¬ 18px â†’ 14px */
  font-size: 20px;        /* åŸæœ¬ 22px â†’ 20px */
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #f2f2f2;
  cursor: pointer;
  color: #222;
}

/* é»æ“Šå›é¥‹ï¼šå·²ç§»é™¤ä¸¦å„ªåŒ–ç‚º selected ç‹€æ…‹ï¼Œä¿æŒåŸæ¨£ */
.panel-options .option:active {
  background: white !important;
}

/* å–®é¸åœ“åœˆï¼ˆå¾®ç¸®ï¼‰ */
.radio-circle {
  width: 22px;             /* åŸ 24 â†’ 22 */
  height: 22px;
  border-radius: 50%;
  border: 2px solid #777;
  display: flex;
  justify-content: center;
  align-items: center;
}

.radio-circle.selected {
  border-color: #0b5ed7;
}

.radio-circle.selected::after {
  content: "";
  width: 10px;             /* åŸ 12 â†’ 10 */
  height: 10px;
  background: #0b5ed7;
  border-radius: 50%;
}

.searchBtn {
  padding: 10px 18px;
  font-size: 20px;
  background: #0b5ed7;
  color: white;
  border: none;
  border-radius: 8px;
  display: inline-block;      /* ğŸ”¥ è®“æŒ‰éˆ•å¯¬åº¦å›åˆ°æ­£å¸¸ */
  width: auto;            /* ğŸ”¥ å–æ¶ˆ flex çš„å½±éŸ¿ */
  margin: 0 auto;           /* ğŸ”¥ æ°´å¹³ç½®ä¸­ */
}

/* å®Œå…¨å»é™¤æ‰‹æ©Ÿè§¸æ§é«˜äº® */
.fakeSelectBtn,
.panel-options .option {
  -webkit-tap-highlight-color: transparent !important;
}

/* ç¦ç”¨æŒ‰ä¸‹æ™‚è®Šè‰² */
.panel-options .option:active {
  background: white !important;
}

/* è¢«é¸å–çš„é¸é …é«˜äº® */
.option.selected {
  background: #eef5ff !important;
}

.option.selected::after {
  content: "";
  width: 10px;
  height: 10px;
  background: #0b5ed7;
  border-radius: 50%;
  display: inline-block;
}

#globalFooter {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 70px;
  background: #f8f8f8;
  display: flex;
  gap: 12px;
  justify-content: center;
  align-items: center;
  padding: 0 16px;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.12);
  z-index: 9999;
}

.gray-btn, .blue-btn {
  flex: 1;
  height: 48px;
  font-size: 20px;
  border-radius: 10px;
  border: none;
}

.gray-btn {
  background: #e0e0e0;
  color: #333;
}

.blue-btn {
  background: #0b5ed7;
  color: #fff;
}

/* é›»è…¦ç‰ˆéš±è— Footer */
@media (min-width: 769px) {
  #globalFooter {
    display: none !important;
  }
}

#pageWrapper {
  padding-bottom: 0px; /* é ç•™ footer ç©ºé–“ */
}

#detailView {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;

  bottom: 70px;  /* â˜… åŒç† */
  overflow-y: auto;
}

#globalFooter {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 70px;
}

html, body {
  height: 100%;
  overflow: hidden;    /* é—œé–‰å…¨é æ»¾å‹• */
}

#listView {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;

  bottom: 70px;  /* â˜… ä¸ç”¨ calcï¼Œç›´æ¥è®“å®ƒæ’æ»¿åˆ° footer ä¸Šæ–¹ */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

#listView {
  padding: 0 16px 0 !important; /* å·¦å³å…§è·+åº•éƒ¨ç•™ç©º */
  box-sizing: border-box;
}

.fakeSelectBtn {
  height: 42px !important;
  display: inline-flex;
  align-items: center;
}

#globalFooter {
  padding-left: 16px !important;
  padding-right: 16px !important;
  box-sizing: border-box !important;
}

#desktopBackBtn,
  #desktopHomeBtn {
    display: none;
  }

/* ============================================================================
    é›»è…¦ç‰ˆï¼ˆâ‰¥769pxï¼‰
    å®Œæ•´é‡æ•´å¾Œç‰ˆæœ¬ï¼šå¡ç‰‡æ¨¡å¼ + detailView æ»¿ç‰ˆ + loadingMask + å°åœ“éˆ•è²¼å¡ç‰‡
    ============================================================================ */
@media (min-width: 769px) {

  /* ------------------------------------------------------------
      å…¨åŸŸè¨­å®šï¼ˆè§£é™¤æ‰‹æ©Ÿé™åˆ¶ï¼‰
      ------------------------------------------------------------ */
  html, body {
    height: auto !important;
    overflow: auto !important;
    background: #f1f1f1 !important;
    overflow-x: hidden !important;
  }


  /* ------------------------------------------------------------
      å¡ç‰‡æ¨¡å¼ï¼ˆpageWrapperï¼‰
      ------------------------------------------------------------ */
  body.desktop-card-mode {
    background: #f1f1f1 !important;
    display: flex !important;
    justify-content: center !important;
    padding: 40px 0 !important;
    position: relative !important;
  }

  /* å¡ç‰‡æœ¬é«” */
  #pageWrapper {
    max-width: 820px !important;
    width: 100%;
    background: #fff;
    border-radius: 12px;
    padding: 24px 30px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.10);
    position: relative !important; /* é‡è¦ï¼šåœ“éˆ•å®šä½éœ€è¦ */
    margin: 0 auto !important;
  }

  /* listView å›åˆ°æ­£å¸¸æµå‹• */
  #listView {
    position: static !important;
    height: auto !important;
    overflow: visible !important;
    padding: 0 !important;
  }


  /* ------------------------------------------------------------
      detailViewï¼šæ»¿ç‰ˆ iframe é¡¯ç¤º
      ------------------------------------------------------------ */
  #detailView {
    position: fixed !important;
    inset: 0 !important;
    z-index: 9995 !important;
    background: white !important;
    overflow: hidden !important;
    width: 100% !important;
    height: 100% !important;
  }

  #detailFrame {
    width: 100% !important;
    height: 100% !important;
    border: none !important;
    margin: 0 !important;
    padding: 0 !important;
  }


  /* ------------------------------------------------------------
      æ‰‹æ©Ÿç‰ˆ footer â†’ é›»è…¦ç‰ˆæ°¸é ä¸é¡¯ç¤º
      ------------------------------------------------------------ */
  #globalFooter {
    display: none !important;
  }


  /* ------------------------------------------------------------
      é›»è…¦ç‰ˆå›ä¸Šä¸€é  / å›é¦–é  æŒ‰éˆ• ï¼ˆåœ¨å¡ç‰‡ä¸Šæ–¹ï¼‰
      ------------------------------------------------------------ */
  #desktopBackBtn,
  #desktopHomeBtn {
    display: inline-block !important;
    position: fixed !important;
    top: 80px !important;
    z-index: 10050 !important; /* ä¿æŒé«˜æ–¼å¡ç‰‡ï¼Œä½æ–¼æµ®å‹•å…ƒç´  */

    padding: 10px 18px;
    font-size: 15px;
    border-radius: 8px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    transition: all 0.2s ease; /* ğŸ”¥ æ–°å¢éæ¸¡æ•ˆæœ */
  }

  /* å°é½Šå¡ç‰‡å·¦å³ */
  #desktopBackBtn  { left:  calc(50% - 410px); }
  #desktopHomeBtn  { right: calc(50% - 410px); }

  /* ğŸ”¥ æ–°å¢ hover/active æ•ˆæœ */
  #desktopBackBtn:hover,
  #desktopHomeBtn:hover {
    background: #f5f5f5;
    transform: translateY(-1px); 
    box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
  }

  #desktopBackBtn:active,
  #desktopHomeBtn:active {
    background: #eee;
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }


  /* ------------------------------------------------------------
      ã€Œå°åœ“éˆ•ã€çµ±ä¸€ä½ç½®ï¼ˆdisplay-list + iframeï¼‰
      ç›®æ¨™ï¼šæ°¸é è²¼å¡ç‰‡å³å´ï¼Œå…©æ¨¡å¼å®Œå…¨ä¸€è‡´
      ------------------------------------------------------------ */

  #floatingButtons {
    position: fixed !important;

    top: 50px !important;

    /* â˜…â˜…â˜…â˜…â˜… é‡è¦ï¼šå¡ç‰‡åŠå¯¬ 410px + å¤–è· 60px */
    left: calc(50% + 410px + 60px) !important;

    display: flex !important;
    flex-direction: column !important;
    gap: 14px !important;

    z-index: 100000 !important;
  }

  .circle-btn {
    width: 54px;
    height: 54px;
    border-radius: 50%;
    border: 1px solid #ccc;
    background: rgba(255,255,255,0.92);
    backdrop-filter: blur(6px);
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.18);
    transition: all 0.2s ease;
  }

  .circle-btn:hover {
    background: #fff;
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.22);
  }

  .circle-btn svg {
    width: 26px;
    height: 26px;
    stroke: #333;
  }

  /* show-detail ä¹Ÿç”¨åŒä¸€ä½ç½®ï¼ˆç¦æ­¢è¦†è“‹ï¼‰ */
  body.show-detail #floatingButtons {
    position: fixed !important;
    top: 50px !important;
    left: calc(50% + 410px + 60px) !important;
    flex-direction: column !important;
  }

  /* ------------------------------------------------------------
      LoadingMaskï¼šç°å¹•ï¼Œä¸æ¨¡ç³Šã€ä¸å»¶é²
      ------------------------------------------------------------ */
  #loadingMask {
    position: fixed !important;
    inset: 0 !important;
    width: 100vw !important;
    height: 100vh !important;

    background: rgba(0,0,0,0.35) !important;

    z-index: 999999 !important;
    display: none !important;

    justify-content: center !important;
    align-items: center !important;
  }

  body.loading #loadingMask {
    display: flex !important;
  }

  /* 1. æœ€å¤–å±¤ï¼šè² è²¬å°‡æ•´å€‹å€å¡Šç½®ä¸­ */
  #adminFilterArea {
    display: none; 
    width: 100% !important;
    margin: 20px auto !important;
    text-align: center !important; /* è®“å…§å±¤ wrapper åƒæ–‡å­—ä¸€æ¨£ç½®ä¸­ */
  }

  /* é¡¯ç¤ºæ™‚å¼·åˆ¶æ”¹ç‚º block (å› ç‚ºæˆ‘å€‘ç”¨ text-align:center) */
  #adminFilterArea[style*="display: block"],
  #adminFilterArea[style*="display: flex"] {
    display: block !important;
  }

  /* 2. å…§éƒ¨é¢æ¿ï¼šåŒ…è£¹æ‰€æœ‰æ¢ä»¶ï¼Œéš¨å…§å®¹æ’é–‹å¯¬åº¦ */
  .admin-inner-wrapper {
    display: inline-block !important; 
    text-align: left !important;      /* å…§éƒ¨æ¢å¾©é å·¦ï¼Œé¿å…æ¨™ç±¤ä¹Ÿç½®ä¸­ */
    background: #ffffff;
    padding: 10px 20px;
    width: auto !important;           /* å¯¬åº¦éš¨å…§å®¹èµ°ï¼Œä¸æ»¿ç‰ˆ */
  }

  /* 3. æ¯ä¸€åˆ—ï¼šé”æˆã€Œæ¨™ç±¤+æ¡†æ¡†ä¸¦æ’ã€ä¸”ã€Œä¸åŒé …æ›è¡Œã€ */
  .admin-inner-wrapper > div {
    display: flex !important;         /* æ¨™ç±¤èˆ‡æ¡†æ¡†ä¸¦æ’ */
    flex-direction: row !important;
    align-items: center !important;
    margin-bottom: 15px !important;    /* æ¯ä¸€è¡Œä¹‹é–“çš„è·é›¢ (é”æˆæ›è¡Œæ•ˆæœ) */
    width: 100% !important;
    white-space: nowrap !important;   /* ç¢ºä¿å–®è¡Œå…§ä¸æŠ˜è¡Œ */
  }

  /* 4. æ¨™ç±¤å›ºå®šå¯¬åº¦ï¼šè®“å¾Œé¢çš„æ¡†æ¡†æ•´é½Šå°é½Š */
  #adminFilterArea label {
    min-width: 80px !important;       /* å›ºå®šå¯¬åº¦ï¼Œè®“ã€Œå¤§éšŠã€ç¯„åœã€æ™‚é–“ã€å°é½Š */
    font-weight: bold;
    font-size: 20px;
    margin-right: 10px;
    flex-shrink: 0;
  }

  /* 5. åº•éƒ¨æŒ‰éˆ•åˆ—ï¼šæœå°‹èˆ‡ç”¢å‡ºå ±è¡¨ */
  .admin-inner-wrapper > div:last-child {
    justify-content: center !important; 
    margin-top: 25px !important;
    gap: 15px !important;
  }
}

/* æ–°å¢ CSSï¼šç•¶ body æœ‰ photo-open-detail æ™‚ï¼Œéš±è—å°åœ“éˆ• */
body.photo-open-detail #floatingButtons {
  display: none !important;  
}

    /* -------------------------------------- */
/* å…±ç”¨æŒ‰éˆ•åŸºç¤æ¨£å¼ */
/* -------------------------------------- */
#btnTeam,
#btnSelf {
    padding: 6px 16px;
    font-size: 22px;
    border: 2px solid #0b5ed7;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease; /* æ–°å¢ï¼šè®“ hover æ•ˆæœæ›´å¹³æ»‘ */
}

/* -------------------------------------- */
/* è—è‰²æŒ‰éˆ• (å¤§éšŠç´€éŒ„) - é è¨­é¸ä¸­ */
/* -------------------------------------- */
#btnTeam {
    background: #0b5ed7;
    color: white;
    margin-right: 6px;
}

/* ğŸ”¥ è—è‰²æŒ‰éˆ•çš„ HOVER æ•ˆæœ */
#btnTeam:hover {
    background: #094aae; /* èƒŒæ™¯è®Šæ·±è— */
    border-color: #094aae; /* é‚Šæ¡†è®Šæ·±è— */
    transform: translateY(-1px); /* è¼•å¾®ä¸Šæµ® */
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); /* æ–°å¢é™°å½± */
}

/* -------------------------------------- */
/* ç™½è‰²æŒ‰éˆ• (æˆ‘çš„ç´€éŒ„) - é è¨­æœªé¸ä¸­ */
/* -------------------------------------- */
#btnSelf {
    background: white;
    color: #0b5ed7;
}

/* ğŸ”¥ ç™½è‰²æŒ‰éˆ•çš„ HOVER æ•ˆæœ */
#btnSelf:hover {
    background: #e6f0ff; /* èƒŒæ™¯è®Šæ·ºè— */
    transform: translateY(-1px); /* è¼•å¾®ä¸Šæµ® */
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); /* æ–°å¢é™°å½± */
}

    html {
  height: 100%;
  overflow: hidden;        /* html æ§åˆ¶æ»¾å‹• */
}

body {
  height: auto;            /* ä¸å¼·åˆ¶ */
  overflow: visible;       /* ä¸è¦è£åˆ‡ï¼Œå¦å‰‡ iOS reflow */
  position: static !important;  /* ä¸è¦è¢« scroll lock æ”¹è®Šå®šä½é» */
}

    /* å¼·åˆ¶ä¸‹æ‹‰é¸å–®å½ˆçª—ä½¿ç”¨èˆ‡ç¶²é ä¸€è‡´çš„å­—é«” */
#fullDropdownMask, 
#fullDropdownMask *,
.option,
#panelTitle {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Microsoft JhengHei", sans-serif !important;
  -webkit-font-smoothing: antialiased;
}

/* è®“é¸é …æ–‡å­—æ›´æ¸…æ™°ï¼Œä¸¦ä¿®æ­£è¡Œé«˜ */
.option {
  font-size: 18px; /* å¯æ ¹æ“šéœ€æ±‚èª¿æ•´ */
  padding: 15px 20px;
  line-height: 1.4;
  color: #333;
}

/* æ¨™é¡ŒåŠ ç²—ä¸€è‡´åŒ– */
#panelTitle {
  font-weight: 600;
  letter-spacing: 1px;
}

/* --- 1. å…¨åŸŸæŒ‰éˆ•åŸºç¤æ¨£å¼ (çµ±ä¸€æœå°‹ã€å ±è¡¨ã€ç´€éŒ„åˆ‡æ›æŒ‰éˆ•) --- */
.searchBtn, #btnTeam, #btnSelf {
  width: 140px !important;    /* ğŸ”¥ çµ±ä¸€æ‰€æœ‰æŒ‰éˆ•å¯¬åº¦ */
  height: 46px;
  font-size: 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer !important;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  flex: none !important;      /* ç¦æ­¢è¢« flex æ“ å£“è®Šå½¢ */
}

/* é¡è‰²è¨­å®š */
#adminSearchBtn { background-color: #0b5ed7 !important; color: white !important; }
#adminExportBtn { background-color: #198754 !important; color: white !important; }
#btnTeam { background-color: #0b5ed7 !important; color: white !important; margin: 0 !important; }
#btnSelf { background-color: white !important; color: #0b5ed7 !important; border: 2px solid #0b5ed7 !important; }

/* å®¹å™¨é–“è·èˆ‡ç½®ä¸­ (ç¢ºä¿ä¸Šä¸‹å…©çµ„å°é½Š) */
#switchArea, .admin-action-row {
  display: flex !important;
  justify-content: center !important;
  gap: 12px !important; /* ğŸ”¥ çµ±ä¸€é–“è· */
  margin: 15px 0 25px 0 !important;
  width: 100% !important;
}

/* --- 2. æŒ‰éˆ•é¡è‰²ç´°ç¯€ --- */

/* è—è‰²æŒ‰éˆ• (å¤§éšŠç´€éŒ„ & æœå°‹) */
#btnTeam, #adminSearchBtn {
  background-color: #0b5ed7 !important;
  color: white !important;
  border: none !important;
}

/* ç¶ è‰²æŒ‰éˆ• (ç”¢å‡ºå ±è¡¨) */
#adminExportBtn {
  background-color: #198754 !important;
  color: white !important;
  border: none !important;
}

/* ç™½è‰²åº•ç¶ æ¡†æŒ‰éˆ• (æˆ‘çš„ç´€éŒ„ & æ­·å²å ±è¡¨) */
#btnSelf, #btnHistory {
  background-color: white !important;
  color: #198754 !important;
  border: 2px solid #198754 !important;
}

/* ğŸ”¥ äº’å‹•æ•ˆæœï¼šæˆ‘çš„ç´€éŒ„ & æ­·å²å ±è¡¨ (æ¸¸æ¨™åœåœ¨ä¸Šé¢åŠæŒ‰ä¸‹æ™‚è®Šå…¨ç¶ ) */
#btnSelf:hover, #btnSelf:active,
#btnHistory:hover, #btnHistory:active {
  background-color: #198754 !important;
  color: white !important;
  border: 2px solid #198754 !important;
}

/* --- 3. æ‰‹æ©Ÿç‰ˆæ’ç‰ˆä¿®æ­£ (< 769px) --- */
@media (max-width: 768px) {
  /* ä¸€èˆ¬åˆ—ï¼šæ¨™ç±¤èˆ‡å–®ä¸€æ¡†æ¡†åŒè¡Œ */
  .admin-inner-wrapper > div {
    display: flex !important;
    align-items: center !important;
    margin-bottom: 15px !important;
  }

  /* ğŸ”¥ æ ¸å¿ƒä¿®æ­£ï¼šæ™‚é–“åˆ—åœ¨æ‰‹æ©Ÿç‰ˆæ”¹ç‚ºæ›è¡Œï¼Œå¥½è®“æ¡†æ¡†è®Šå¤§ */
  #timeWrapper.timeRow {
    display: flex !important;
    flex-wrap: wrap !important; /* å…è¨±æŠ˜è¡Œ */
    gap: 10px !important;
    margin-top: 5px;
  }

  /* æ‰€æœ‰çš„å½ä¸‹æ‹‰æ¡† (å¤§éšŠã€ç¯„åœã€é¡å‹ã€åŠæ™‚é–“çš„å…©å€‹æ¡†) å¯¬åº¦å…¨éƒ¨çµ±ä¸€ */
  .fakeSelectBtn {
    width: 100% !important;     /* è®“æ¡†æ¡†å»æ’æ»¿è©²è¡Œå‰©é¤˜ç©ºé–“ */
    max-width: 100% !important;
    height: 42px !important;
    flex: 1;
  }

  /* æ™‚é–“åˆ—çš„æ³¢æµªè™Ÿï¼šåœ¨æ‰‹æ©Ÿç‰ˆæ›è¡Œæ™‚æœƒä½”æ»¿å¯¬åº¦æˆ–ç½®ä¸­ */
  .tilde {
    width: 100%;
    text-align: center;
    margin: -5px 0;
    font-weight: bold;
  }

  /* æ¨™ç±¤æ¨£å¼ */
  #adminFilterArea label {
    min-width: 65px !important;
    font-weight: bold !important;
    font-size: 20px;
    flex-shrink: 0;
  }

  /* åº•éƒ¨æŒ‰éˆ•åˆ—ï¼šç½®ä¸­ä¸¦æ’ */
  .admin-inner-wrapper > div:last-child {
    display: flex !important;
    justify-content: center !important;
    gap: 15px !important;
    margin-top: 30px !important;
  }

/* --- 4. å½ˆçª—èˆ‡æ¨™ç±¤å¼·åŒ– --- */
#panelTitle, .panel-title {
  font-weight: bold !important;
  font-size: 22px !important;
}
</style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>

  <div id="pageWrapper">

    <!-- é›»è…¦ç‰ˆå¡ç‰‡é‚Šé‚Šåœ“éˆ• -->
<div id="floatingButtons" style="display:none;">
  <button class="circle-btn" onclick="handleClosePage()">
    <!-- æˆ¿å­ icon -->
    <svg fill="none" viewBox="0 0 24 24" stroke-width="2">
      <path d="M3 9.5L12 3l9 6.5V21a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1V9.5z"/>
    </svg>
  </button>

  <button class="circle-btn" onclick="backToList()">
    <!-- å·¦ç®­é ­ icon -->
    <svg fill="none" viewBox="0 0 24 24" stroke-width="2">
      <path d="M15 6l-6 6 6 6" />
    </svg>
  </button>
</div>

<div id="listView" style="display:block;">


    <!-- é€™å€‹ div ç”¨ä¾†é¡¯ç¤ºæ‰€æœ‰çš„æ—¥èªŒ -->
<!--
  <div id="debugLog" style="position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(0, 0, 0, 0.7); color: white; font-size: 14px; padding: 10px; overflow-y: auto; max-height: 200px;"></div>
-->

<div id="loadingMask">
  <div class="spinner"></div>

  <div id="text-loading" class="loadingText">è¼‰å…¥ä¸­â€¦</div>
  <div id="text-update" class="loadingText">è³‡æ–™æ›´æ–°ä¸­ï¼Œè«‹è€å¿ƒç­‰å€™â€¦</div>
  <div id="text-init" class="loadingText">è³‡æ–™åˆå§‹åŒ–ä¸­ï¼Œè«‹è€å¿ƒç­‰å€™â€¦</div>

  <!-- éŒ¯èª¤è¨Šæ¯é ç•™ï¼ˆå¯é¸ï¼‰ -->
  <div id="text-error" class="loadingText">ç„¡æ³•é€£ç·šåˆ°è³‡æ–™ä¾†æº</div>
  <div id="text-error-format" class="loadingText">è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡</div>
  <div id="text-error-notfound" class="loadingText">æ‰¾ä¸åˆ°æ‚¨çš„å¿—å·¥è³‡æ–™</div>
</div>

<h2 id="pageTitle" style="display:block;">å›å ±ç´€éŒ„</h2>

<div id="switchArea" style="
  display:none;
  text-align:center;
  margin-top:10px;
  margin-bottom:18px;
">
  <button id="btnTeam" style="
  padding:6px 16px;
  font-size:22px;
  border:2px solid #0b5ed7;
  background:#0b5ed7;
  color:white;
  border-radius:6px;
  margin-right:6px;
">å¤§éšŠç´€éŒ„</button>

<button id="btnSelf" style="
  padding:6px 16px;
  font-size:22px;
  border:2px solid #0b5ed7;
  background:white;
  color:#0b5ed7;
  border-radius:6px;
">æˆ‘çš„ç´€éŒ„</button>
</div>

<div id="adminFilterArea" style="display:none; padding:12px;">
  <div class="admin-inner-wrapper">
  
  <!-- å¤§éšŠ -->
  <div style="margin-bottom:12px;">
    <label>å¤§éšŠï¼š</label>

    <!-- åŸç”Ÿ selectï¼šä¿ç•™çµ¦ JS ç”¨ï¼ˆhidden ä¸æœƒè¢«çœ‹åˆ°ï¼‰ -->
    <select id="adminTeamSelect" style="display:none;">
      <option value="å…¨éƒ¨">å…¨éƒ¨</option>
      <option value="1">ç¬¬1å¤§éšŠ</option>
      <option value="2">ç¬¬2å¤§éšŠ</option>
      <option value="3">ç¬¬3å¤§éšŠ</option>
      <option value="4">ç¬¬4å¤§éšŠ</option>
      <option value="5">ç¬¬5å¤§éšŠ</option>
      <option value="6">ç¬¬6å¤§éšŠ</option>
      <option value="7">ç¬¬7å¤§éšŠ</option>
      <option value="8">ç¬¬8å¤§éšŠ</option>
      <option value="9">ç¬¬9å¤§éšŠ</option>
      <option value="10">ç¬¬10å¤§éšŠ</option>
    </select>

    <!-- å½ä¸‹æ‹‰ UI -->
    <button class="fakeSelectBtn" onclick="openDropdown('team')">
  <span id="teamText">å…¨éƒ¨</span>
  <span class="arrow">â–¾</span>
</button>
  </div>

  <!-- ç¯„åœ -->
  <div style="margin-bottom:12px;">
    <label>ç¯„åœï¼š</label>

    <select id="adminDayRange" style="display:none;">
      <option value="3" selected>æœ€è¿‘ 3 å¤©</option>
      <option value="7">æœ€è¿‘ 7 å¤©</option>
      <option value="14">æœ€è¿‘ 14 å¤©</option>
    </select>

    <button class="fakeSelectBtn" onclick="openDropdown('range')">
  <span id="rangeText">æœ€è¿‘ 3 å¤©</span>
  <span class="arrow">â–¾</span>
</button>
  </div>

  <!-- æ™‚é–“ -->
  <div style="margin-bottom:12px;">
    <label>æ™‚é–“ï¼š</label>

    <select id="timeStart" style="display:none;">
      <option value="00:00">00:00</option>
      <option value="01:00">01:00</option>
      <option value="02:00">02:00</option>
      <option value="03:00">03:00</option>
      <option value="04:00">04:00</option>
      <option value="05:00">05:00</option>
      <option value="06:00">06:00</option>
      <option value="07:00">07:00</option>
      <option value="08:00">08:00</option>
      <option value="09:00">09:00</option>
      <option value="10:00">10:00</option>
      <option value="11:00">11:00</option>
      <option value="12:00">12:00</option>
      <option value="13:00">13:00</option>
      <option value="14:00">14:00</option>
      <option value="15:00">15:00</option>
      <option value="16:00">16:00</option>
      <option value="17:00">17:00</option>
      <option value="18:00">18:00</option>
      <option value="19:00">19:00</option>
      <option value="20:00">20:00</option>
      <option value="21:00">21:00</option>
      <option value="22:00">22:00</option>
      <option value="23:00">23:00</option>
    </select>

    <select id="timeEnd" style="display:none;">
      <option value="00:59">00:59</option>
      <option value="01:59">01:59</option>
      <option value="02:59">02:59</option>
      <option value="03:59">03:59</option>
      <option value="04:59">04:59</option>
      <option value="05:59">05:59</option>
      <option value="06:59">06:59</option>
      <option value="07:59">07:59</option>
      <option value="08:59">08:59</option>
      <option value="09:59">09:59</option>
      <option value="10:59">10:59</option>
      <option value="11:59">11:59</option>
      <option value="12:59">12:59</option>
      <option value="13:59">13:59</option>
      <option value="14:59">14:59</option>
      <option value="15:59">15:59</option>
      <option value="16:59">16:59</option>
      <option value="17:59">17:59</option>
      <option value="18:59">18:59</option>
      <option value="19:59">19:59</option>
      <option value="20:59">20:59</option>
      <option value="21:59">21:59</option>
      <option value="22:59">22:59</option>
      <option value="23:59" selected>23:59</option>
    </select>

    <div id="timeWrapper" class="timeRow">
  <button class="fakeSelectBtn timeBtn" onclick="openDropdown('timeStart')">
    <span id="timeStartText">00:00</span>
    <span class="arrow">â–¾</span>
  </button>

  <span class="tilde">ï½</span>

  <button class="fakeSelectBtn timeBtn" onclick="openDropdown('timeEnd')">
    <span id="timeEndText">23:59</span>
    <span class="arrow">â–¾</span>
  </button>
</div>
  </div>

  <!-- é¡å‹ -->
  <div style="margin-bottom:12px;">
    <label>é¡å‹ï¼š</label>

    <select id="adminTypeSelect" style="display:none;">
      <option value="å…¨éƒ¨">å…¨éƒ¨</option>
      <option value="å¹³æ™‚">å¹³æ™‚</option>
      <option value="ç½ä¸­">ç½ä¸­</option>
      <option value="å…¶ä»–">å…¶ä»–</option>
    </select>

    <button class="fakeSelectBtn" onclick="openDropdown('type')">
  <span id="typeText">å…¨éƒ¨</span>
  <span class="arrow">â–¾</span>
</button>
  </div>


  <!-- æœå°‹ -->
  <div style="text-align:center; margin-top:20px; display: flex; justify-content: center; gap: 10px;">
    <button id="adminSearchBtn" class="searchBtn">æœå°‹</button>
    <button id="adminExportBtn" class="searchBtn" style="background-color: #198754; border-color: #198754;">ç”¢å‡ºå ±è¡¨</button>
</div>
</div>
</div>

<!-- å…¨è¢å¹•å½ä¸‹æ‹‰é¸å–®ï¼ˆé€™æ®µè²¼é€™è£¡ï¼‰ -->
<div id="fullDropdownMask">
  <div id="fullDropdownPanel">
    <div class="panel-title" id="panelTitle"></div>
    <div class="panel-options" id="panelOptions"></div>
  </div>
</div>

<div id="centerSpinner" style="
  display:none;
  width:100%;
  padding:40px 0;
  justify-content:center;
  align-items:center;
  flex-direction:column;
">
  <div class="spinner"></div>
  <div style="font-size:22px; color:#666; margin-top:10px;">è¼‰å…¥ä¸­...</div>
</div>

<!-- æ¸…å–®çœŸæ­£å‘ˆç¾çš„åœ°æ–¹ï¼Œä¸€é–‹å§‹å…ˆéš±è— -->
<div id="listContainer" style="display: none;"></div>

</div>

<!-- == DetailView è¦†è“‹å±¤ == -->
<div id="detailView" style="
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:#fff;
  z-index:9998;
  overflow:hidden;   /* ä¿è­‰ä¸å‡ºç¾ç™½é‚Š */
  padding:0;
  margin:0;
">

  <!-- == ç„¡é‚Šè· iframe == -->
  <iframe id="detailFrame"
    sandbox="allow-scripts allow-same-origin allow-top-navigation-by-user-activation"
    style="
      position:absolute;
      top:0;
      left:0;
      width:100%;
      height:calc(100% - 70px);
      border:0;
      padding:0;
      margin:0;
      display:block;
      background:#fff;
">
</iframe>
</div>

</div>   <!-- pageWrapper çµæŸ -->


  <!-- é›»è…¦ç‰ˆå°åœ“éˆ• -->
<!--
  <div id="floatingButtons" style="display:none;">
  <button class="circle-btn" onclick="backToList()">è¿”</button>
  <button class="circle-btn" onclick="handleClosePage()">ä¸»</button>
</div>
-->
  
<div id="globalFooter">
  <button class="gray-btn" onclick="backToList()">å›ä¸Šä¸€é </button>
  <button class="gray-btn" onclick="handleClosePage()">å›ä¸»é¸å–®</button>
</div>

<script>

  const VOLUNTEER_API_URL = "https://script.google.com/macros/s/AKfycbxiGSG5hSMO6We-C6cyEJZLgf4Rnbjp-6w9Tmb0qfF9VM6JB4YGEMqj3QRfTzg7Czpc/exec"; 
const REPORT_GAS_URL = "https://script.google.com/macros/s/AKfycbw_zWtC5douqiQkviNskaaRihnk3d63kJf8eAzvphNxw4rpN43hbbnz5weST-p4UrO0Xw/exec";

let globalAdminRecords = [];   // ç®¡ç†å“¡ä¸€æ¬¡æŠ“å…¨éƒ¨å¾Œå­˜åœ¨é€™é‚Š
let adminViewDays = 3;        // é è¨­æŠ“æœ€è¿‘å…©é€±ï¼Œå¯æ”¹ 30
let globalNickname = "";
let globalRole = "";
let globalTeam = "";
let globalName = "";  // â˜… å¿…é ˆè£œé€™è¡Œ
let viewMode = "team";  // self = çœ‹è‡ªå·±, team = çœ‹å¤§éšŠ
let shouldKeepMask = false;
let restoredOnce = false;
let isInitialLoad = true;
let globalRecords = [];

// ------------------------------------------
// â˜…â˜…â˜… Session Storage é å¿«å–è¼”åŠ©å‡½å¼ â˜…â˜…â˜…
// ------------------------------------------

// ç”¨æ–¼å„²å­˜åˆ—è¡¨æ•¸æ“šåˆ° Session Storage çš„ key
const LIST_CACHE_KEY = 'reportListCache';

  document.addEventListener("DOMContentLoaded", () => {
  const mask = document.getElementById("fullDropdownMask");

  // â˜…â˜…â˜… é å…ˆæŠŠé®ç½©ç§»åˆ° <html> å±¤ç´šï¼Œé¿å…ä¹‹å¾Œç§»å‹•é€ æˆ layout shift
  if (mask && mask.parentElement !== document.documentElement) {
    document.documentElement.appendChild(mask);
  }
});

/**
 * å°‡åˆ—è¡¨æ•¸æ“šè½‰æ›ç‚ºä»¥ Report ID ç‚ºéµçš„ Map/Objectï¼Œä¸¦å­˜å…¥ Session Storageã€‚
 * @param {Array} records - GAS è¿”å›çš„ç´€éŒ„é™£åˆ—ã€‚
 */
function saveLocalReportsCache(records) {
    try {
        const recordsMap = new Map();
        
        records.forEach(record => {
            // å¾ 'è©³ç´°ç´€éŒ„' é€£çµä¸­è§£æ reportId (ä¾‹å¦‚ report_170245...)
            const detailLink = record['è©³ç´°ç´€éŒ„'] || '';
            const match = detailLink.match(/id=(report_[0-9]+)/);

            if (match) {
                // å­˜å…¥ Mapï¼Œéµæ˜¯ reportIdï¼Œå€¼æ˜¯å®Œæ•´çš„ç´€éŒ„ç‰©ä»¶
                recordsMap.set(match[1], record); 
            }
        });
        
        // å°‡ Map è½‰ç‚º Object æ‰èƒ½ JSON åºåˆ—åŒ–ï¼Œä¸¦å­˜å…¥ Session Storage
        sessionStorage.setItem(LIST_CACHE_KEY, JSON.stringify(Object.fromEntries(recordsMap)));
        console.log(`âœ… ${recordsMap.size} ç­†ç´€éŒ„å·²å­˜å…¥ Session Storageã€‚`);

    } catch (e) {
        console.error("ç„¡æ³•å¯«å…¥ Session Storage:", e);
    }
}

/**
 * å¾ Session Storage è®€å–ä»¥ Report ID ç‚ºéµçš„ Map/Objectã€‚
 * @returns {Object|null}
 */
function getLocalReportsCacheMap() {
    try {
        const cachedData = sessionStorage.getItem(LIST_CACHE_KEY);
        return cachedData ? JSON.parse(cachedData) : null;
    } catch (e) {
        console.error("ç„¡æ³•è®€å– Session Storage", e);
        return null;
    }
}

// === é˜²æ­¢å›ä¸Šä¸€é é‡æ–°åˆå§‹åŒ–ï¼ˆBFCache æ”¯æ´ï¼‰ ===
window.addEventListener("pageshow", function (event) {
  if (event.persisted) {
    console.log("BFCache restore â†’ ä¸åŸ·è¡Œ main()");
    return;
  }
});

main();

function debug(msg) {
  try {
    const box = document.getElementById("debugLog");
    if (box) {
      // é€™è£¡æ·»åŠ æ–°çš„æ—¥èªŒ
      box.textContent += msg + "\n";
      box.scrollTop = box.scrollHeight;  // æ»¾å‹•åˆ°æœ€æ–°çš„æ—¥èªŒä½ç½®
    }
    console.log(msg);  // ä¾ç„¶åœ¨æ§åˆ¶å°æ‰“å°
  } catch (e) {
    console.error("Debug log error: ", e);
  }
}

  /* ------------------------------------------
      1. åˆå§‹åŒ–ï¼šç™»å…¥ LIFF ä¸¦å–å¾—è³‡æ–™
  -------------------------------------------*/
  function showLoading() {
  document.body.classList.add("loading");  // â˜… é›»è…¦ç‰ˆå¡ç‰‡éš±è—ç”¨

  document.getElementById("loadingMask").style.display = "flex";

  document.getElementById("text-loading").style.display = "block";
  document.getElementById("text-update").style.display = "none";
  document.getElementById("text-init").style.display = "none";
  document.getElementById("text-error").style.display = "none";
  document.getElementById("text-error-format").style.display = "none";
  document.getElementById("text-error-notfound").style.display = "none";
}

async function main() {
  showLoading();  // â˜… é€™è£¡é¡¯ç¤ºè¼‰å…¥ä¸­...

  globalVid      = localStorage.getItem("vid") || "";
globalName     = localStorage.getItem("name") || "";
globalTeam     = localStorage.getItem("team") || "";
globalRole     = localStorage.getItem("role") || "å¿—å·¥";

if (!globalVid) {
  debug("éŒ¯èª¤ï¼šlocalStorage å…§æ²’æœ‰ vidï¼Œç„¡æ³•æŸ¥è©¢è³‡æ–™");
}

  if (globalRole === "ç®¡ç†å“¡") {
    viewMode = "admin";
    await loadAdminRecords();
    return;
  }

  if (globalRole === "å¤§éšŠé•·") {
    viewMode = "team";
    await loadRecordList("team");
    return;
  }

  viewMode = "self";
  await loadRecordList("self");
}

window.addEventListener("message", (e) => {
  const footer = document.getElementById("globalFooter");
  const iframe = document.getElementById("detailFrame");

  if (e.data.action === "PHOTO_OPEN") {
    footer.style.display = "none";
    iframe.style.height = "100%";   // â˜… æ»¿ç‰ˆ
  }

  if (e.data.action === "PHOTO_CLOSE") {
    footer.style.display = "flex";
    iframe.style.height = "calc(100% - 70px)"; // â˜… æ¢å¾©
  }

  // main() å®Œæˆæœ€å¾Œä¸€è¡ŒåŠ ä¸Šï¼š
document.body.classList.add("loaded");
});

// [æ–°å¢] è¼”åŠ©å‡½å¼ï¼šå¾ URL è§£æ Report ID
function getReportIdFromUrl(url) {
    try {
        const urlObj = new URL(url);
        // å‡è¨­ ID ç¸½æ˜¯åœ¨ URL åƒæ•¸ä¸­ï¼Œä¾‹å¦‚ ...?id=report_12345
        return urlObj.searchParams.get('id'); 
    } catch (e) {
        console.error("ç„¡æ³•è§£æ URL ä»¥ç²å– ID:", e);
        return null;
    }
}

// å‡è¨­æ‚¨å·²ç¶“åœ¨å…¶ä»–åœ°æ–¹å®šç¾©äº† getLocalReportsCacheMap() è¼”åŠ©å‡½å¼
// å‡è¨­æ‚¨å·²ç¶“å®šç¾©äº†ä¸€å€‹æ–°çš„æ¸²æŸ“å‡½å¼ä¾†è™•ç†æœ¬åœ°æ•¸æ“šï¼š
// function renderDetailInline(data) { ... } 

function openDetail(url) {
    const list     = document.getElementById("listView");
    const detail = document.getElementById("detailView");
    const iframe = document.getElementById("detailFrame");
    const footer = document.getElementById("globalFooter");
    const fb     = document.getElementById("floatingButtons");

    const reportId = getReportIdFromUrl(url); 

    if (!reportId) {
        console.error("ç„¡æ³•å¾ URL è§£æå ±å‘Š IDï¼Œç„¡æ³•é–‹å•Ÿè©³ç´°é é¢ã€‚");
        return; 
    }
    
    const localDetailUrl = `/display/index.html?id=${reportId}`;

    // 1. ğŸ”¥ é—œéµæ­¥é©Ÿï¼šå…ˆéš±è— iFrameï¼Œé˜²æ­¢çœ‹åˆ°ã€ŒèˆŠå…§å®¹è¢«æ¸…ç©ºã€æ™‚çš„é–ƒçˆã€‚
    iframe.style.display = 'none'; 
    
    // 2. åŸ·è¡Œ UI åˆ‡æ› (åˆ‡æ› detailView/listView)
    list.style.display = "none";
    detail.style.display = "block";
    
    // 3. è¨­å®š srcï¼Œé–‹å§‹è¼‰å…¥æ–°é é¢ã€‚
    iframe.src = localDetailUrl; 
    console.log(`â–¶ï¸ é–‹å§‹è¼‰å…¥æœ¬åœ° iFrame: ${localDetailUrl}`);

    // 4. ğŸ”¥ ç«‹å³é¡¯ç¤º iFrameã€‚
    // é€™æ¨£åœ¨ detailView é¡¯ç¤ºæ™‚ï¼ŒiFrame å®¹å™¨å°±å­˜åœ¨ï¼Œä¸æœƒæœ‰ç™½è‰²èƒŒæ™¯é–ƒçˆã€‚
    iframe.style.display = 'block'; 

    // 5. æ‰‹æ©Ÿ vs é›»è…¦çš„ footer/åœ“éˆ•è¨­å®š (ä¿æŒä¸è®Š)
    if (window.innerWidth < 769) {
        footer.style.display = "flex";
        fb.style.display = "none";
    } else {
        footer.style.display = "none";
        fb.style.display = "flex";
        document.body.classList.add("show-detail");
    }

    // 6. iframe è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ (ä¿æŒåŸæœ‰çš„åª’é«”ç›£è½é‚è¼¯)
    // æ³¨æ„ï¼šonload åƒ…ç”¨æ–¼å…§éƒ¨é‚è¼¯è™•ç†ï¼Œä¸å†æ§åˆ¶ iframe çš„ display å±¬æ€§ã€‚
    iframe.onload = () => {
        // ğŸ”¥ é—œéµä¿®æ­£ï¼šç§»é™¤ iframe.style.display = 'block';
        // ç¢ºä¿ onload åƒ…ç”¨æ–¼å…§éƒ¨é‚è¼¯ï¼Œä¸å»¶é² iFrame å®¹å™¨çš„é¡¯ç¤ºã€‚

        try {
            const doc = iframe.contentDocument;
            const modal = doc.querySelector('#image-modal'); // ç…§ç‰‡æŸ¥çœ‹è¦–çª—

            if (!modal) return;

            // ç›£æ§æŸ¥çœ‹ç…§ç‰‡çš„é¡¯ç¤ºç‹€æ…‹ (åŸæœ‰çš„ MutationObserver é‚è¼¯)
            const observer = new MutationObserver(() => {
                const isOpen = modal.style.display === "block";

                if (window.innerWidth < 769) {
                    footer.style.display = isOpen ? "none" : "flex";
                } else {
                    fb.style.display = isOpen ? "none" : "flex";
                }
            });

            observer.observe(modal, {
                attributes: true,
                attributeFilter: ["style"]
            });

        } catch (err) {
            console.warn("iFrame onload è™•ç†éŒ¯èª¤:", err); 
        }
    };
}
  
// â˜…â˜…â˜… çµ±ä¸€ç…§ç‰‡é åµæ¸¬é‚è¼¯
function isPhotoPage(url) {
  return /photo|image|img|picture|gallery/i.test(url);
}

function backToList() {
    // å¦‚æœå ±è¡¨å±¤é–‹è‘—ï¼Œå„ªå…ˆåŸ·è¡Œé—œé–‰å ±è¡¨
    const reportOverlay = document.getElementById("reportOverlay");
    if (reportOverlay) {
        closeReportLayer(); // ä½¿ç”¨æˆ‘å€‘æ–°åšçš„å°ˆå±¬é—œé–‰å‡½å¼
        return;
    }

    const detail = document.getElementById("detailView");
    const list = document.getElementById("listView");
    const fb = document.getElementById("floatingButtons");
    const iframe = document.getElementById("detailFrame");

    if (detail.style.display === "block") {
        iframe.src = 'about:blank';
        iframe.style.display = 'none';
        detail.style.display = "none";
        list.style.display = "block";
        document.body.classList.remove("show-detail");
        if (window.innerWidth >= 769) {
            fb.style.display = "flex";
        }
        return;
    }

    window.location.href = "/home";
}
  
async function loadAdminRecords() {

  const url = `${REPORT_GAS_URL}?action=listAdminFull&days=30`;

  let json;
  try {
    const res = await fetch(url);
    const text = await res.text();
    json = JSON.parse(text);
  } catch (e) {
    document.getElementById("listContainer").innerHTML = "ç®¡ç†å“¡è³‡æ–™è¼‰å…¥å¤±æ•—";
    shouldKeepMask = false;
    document.getElementById("loadingMask").style.display = "none";
    return;
  }

  globalAdminRecords = json.records || [];

  // â˜…â˜…â˜… [æ–°å¢] å°‡ç®¡ç†å“¡åˆ—è¡¨æ•¸æ“šå­˜å…¥ Session Storage â˜…â˜…â˜…
    saveLocalReportsCache(globalAdminRecords);

  const filtered = filterAdminRecords();
  renderList(filtered);

  // â˜… renderList çµæŸå¾Œï¼Œé—œæ‰å¤§ loading
  if (shouldKeepMask) {
    shouldKeepMask = false;
    document.getElementById("loadingMask").style.display = "none";
  }

  isInitialLoad = false;   // â˜… ç¬¬ä¸€æ¬¡è¼‰å…¥çµæŸ
}

  /* ------------------------------------------
      3. å¾ GAS å–å¾—å›å ±è¨˜éŒ„ï¼ˆæœªä¾†ä¸² APIï¼‰
  -------------------------------------------*/
  async function loadRecordList(mode = "self") {
  if (!globalVid) {
    debug("éŒ¯èª¤ï¼šæ²’æœ‰ vid ç„¡æ³•æŸ¥è©¢");
    document.getElementById("loadingMask").style.display = "none";
    return;
  }

  let url = "";

  if (mode === "self") {
    url = `${REPORT_GAS_URL}?action=listMyReports&vid=${encodeURIComponent(globalVid)}`;
  } else if (mode === "team") {
    url = `${REPORT_GAS_URL}?action=listTeamReports&team=${encodeURIComponent(globalTeam)}`;
  }

  debug("ç™¼é€ API è«‹æ±‚ï¼ŒURL: " + url); // æ‰“å° API è«‹æ±‚çš„ URL

  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text);

  debug("è¿”å›çš„è³‡æ–™: " + JSON.stringify(json)); // æ‰“å° API è¿”å›çš„è³‡æ–™

  globalRecords = json.records || [];

  // â˜…â˜…â˜… [æ–°å¢] å°‡å¿—å·¥/å¤§éšŠåˆ—è¡¨æ•¸æ“šå­˜å…¥ Session Storage â˜…â˜…â˜…
    saveLocalReportsCache(globalRecords);

  renderList(globalRecords);
}

  if (shouldKeepMask) {
    shouldKeepMask = false;
    document.getElementById("loadingMask").style.display = "none";
  }

  updateSwitchUI();

  /* ------------------------------------------
      4. æ¸²æŸ“ã€Œå¹´åº¦ â†’ æœˆä»½ â†’ æ—¥æœŸ â†’ ç´€éŒ„ã€
  -------------------------------------------*/
  function normalizeDate(dateStr) {
  // è‹¥æ˜¯ ISO æ ¼å¼ï¼š2025-11-11T16:00:00.000Z
  if (dateStr.includes("T")) {
    const d = new Date(dateStr);
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}/${mm}/${dd}`;
  }
  return dateStr; // è‹¥æœ¬ä¾†å°±æ˜¯ yyyy/mm/dd
}

function filterAdminRecords() {
  let records = [...globalAdminRecords];

  // 1. ç¯©é¸å¤§éšŠ
let targetTeam = document.getElementById("adminTeamSelect")?.value;

// iOS hidden select = "" â†’ å¿…é ˆè£œæ•‘
if (!targetTeam) {
  targetTeam = document.getElementById("teamText").innerText || "å…¨éƒ¨";
}

if (targetTeam !== "å…¨éƒ¨") {
  records = records.filter(r => (r.æ‰€å±¬å¤§éšŠ + "") === targetTeam);
}

  // 2. ç¯„åœç¯©é¸ï¼ˆé‡è¦ï¼šå¾ä¸‹æ‹‰é¸å–®è®€å–ï¼‰
  const dayRangeSelect = document.getElementById("adminDayRange");
  let selectedDays = dayRangeSelect?.value;
if (!selectedDays) selectedDays = document.getElementById("rangeText").innerText.replace("æœ€è¿‘ ", "").replace(" å¤©", "");
  adminViewDays = Number(selectedDays);
  
  console.log("ç¯©é¸å¤©æ•¸:", adminViewDays); // é™¤éŒ¯ç”¨
  
  const now = new Date();
  const cutoff = new Date(now.getTime() - adminViewDays * 24 * 60 * 60 * 1000);

  records = records.filter(r => {
    let ds = normalizeDate(r.æ—¥æœŸ);
    const recordDate = new Date(ds);
    return recordDate >= cutoff;
  });

  // 3. ç¯©é¸é€šå ±é¡å‹
  let targetType = document.getElementById("adminTypeSelect")?.value || "å…¨éƒ¨";
  if (targetType !== "å…¨éƒ¨") {
    records = records.filter(r => {
      const type = (r.é€šå ±é¡å‹ || "").trim();
      return type === targetType;
    });
  }

  // 4. æ™‚é–“ç¯©é¸
  const start = document.getElementById("timeStart")?.value || "00:00";
const end   = document.getElementById("timeEnd")?.value || "23:59";

const [startHour, startMinute] = start.split(":").map(Number);
const [endHour, endMinute] = end.split(":").map(Number);

const startTotal = startHour * 60 + startMinute;
const endTotal = endHour * 60 + endMinute;

records = records.filter(r => {
  const link = r.è©³ç´°ç´€éŒ„ || "";
  const match = link.match(/report_(\d+)/);
  if (!match) return false;

  const t = parseInt(match[1], 10);
  const d = new Date(t);
  const h = d.getHours();
  const m = d.getMinutes();
  
  const recordTotal = h * 60 + m;

  if (startTotal <= endTotal) {
    return recordTotal >= startTotal && recordTotal <= endTotal;
  } else {
    return recordTotal >= startTotal || recordTotal <= endTotal;
  }
});

  console.log("ç¯©é¸å¾Œç­†æ•¸:", records.length); // é™¤éŒ¯ç”¨
  return records;
}

function renderList(records) {
  const container = document.getElementById("listContainer");
  const spinner = document.getElementById("centerSpinner");
  const mask = document.getElementById("loadingMask");

  // 1. åˆå§‹åŒ–éš±è—èˆ‡é¡¯ç¤ºè™•ç†
  container.style.display = "none";
  if (!isInitialLoad && spinner) spinner.style.display = "flex";

  // ç®¡ç†å“¡æ¨¡å¼ï¼šç¢ºä¿ç¯©é¸å€åŸŸé¡¯ç¤º
  if (globalRole === "ç®¡ç†å“¡" && viewMode === "admin") {
    document.getElementById("adminFilterArea").style.display = "block";
  } else {
    document.getElementById("adminFilterArea").style.display = "none";
  }

  // ç®¡ç†å“¡å‰ç«¯å¿«ç¯© (ä¿ç•™æ‚¨çš„éæ¿¾é‚è¼¯)
  if (globalRole === "ç®¡ç†å“¡" && viewMode === "admin") {
    if (globalAdminRecords.length > 0) {
      let targetTeam = document.getElementById("adminTeamSelect")?.value || "å…¨éƒ¨";
      if (!targetTeam) targetTeam = document.getElementById("teamText")?.innerText || "å…¨éƒ¨";
      if (targetTeam !== "å…¨éƒ¨") {
        records = records.filter(r => (r.æ‰€å±¬å¤§éšŠ + "") === targetTeam);
      }
      const now = new Date();
      const cutoff = new Date(now.getTime() - adminViewDays * 24 * 60 * 60 * 1000);
      records = records.filter(r => new Date(normalizeDate(r.æ—¥æœŸ)) >= cutoff);
    }
  }

  globalRecords = records;
  container.innerHTML = "";

  // 2. è·¨å¹´ä»½åˆ†çµ„
  const grouped = {};
  records.forEach(r => {
    const normalized = normalizeDate(r.æ—¥æœŸ);
    const dateParts = normalized.split("/");
    const yyyy = parseInt(dateParts[0], 10);
    const m = parseInt(dateParts[1], 10);
    const d = parseInt(dateParts[2], 10);
    const twYear = yyyy - 1911;

    if (!grouped[twYear]) grouped[twYear] = {};
    if (!grouped[twYear][m]) grouped[twYear][m] = {};
    if (!grouped[twYear][m][d]) grouped[twYear][m][d] = [];
    grouped[twYear][m][d].push(r);
  });

  // 3. æ¸²æŸ“èˆ‡å¼·åˆ¶å±•é–‹
  const years = Object.keys(grouped).sort((a, b) => b - a);
  years.forEach(twYear => {
    const yearBlock = createBlock(`${twYear} å¹´`, "year");
    const yearContent = yearBlock.querySelector(".content");
    
    // â˜… å¼·åˆ¶å±•é–‹ã€Œå¹´ã€
    yearContent.style.display = "block";
    const yearIcon = yearBlock.querySelector(".toggle-icon");
    if(yearIcon) yearIcon.innerHTML = `<svg width="40" height="40" viewBox="0 0 24 24"><path fill="#666" d="M5 16l7-8 7 8z"/></svg>`;

    const months = Object.keys(grouped[twYear]).map(Number).sort((a, b) => b - a);
    months.forEach(month => {
      const monthBlock = createBlock(`${month} æœˆ`, "month");
      const monthContent = monthBlock.querySelector(".content");

      const days = Object.keys(grouped[twYear][month]).map(Number).sort((a, b) => b - a);
      days.forEach(day => {
        const dayBlock = createBlock(`${day} æ—¥`, "day");
        const dayContent = dayBlock.querySelector(".content");

        // â˜… ã€Œæ—¥ã€ä¸å±•é–‹ï¼Œä¿æŒæ”¶åˆ (é è¨­ createBlock å°±æ˜¯æ”¶åˆçš„)

        grouped[twYear][month][day].forEach(record => {
          const div = document.createElement("div");
          div.className = "record";
          
          let hh = "--", mm = "--";
          try {
            const match = (record.è©³ç´°ç´€éŒ„ || "").match(/report_(\d+)/);
            if (match) {
              const dObj = new Date(parseInt(match[1], 10));
              hh = String(dObj.getHours()).padStart(2, "0");
              mm = String(dObj.getMinutes()).padStart(2, "0");
            }
          } catch (e) {}

          const status = (record.ç‹€æ…‹ || "").trim();
          const isAbnormal = status === "ç•°å¸¸";
          
          const timeText = document.createElement("span");
          timeText.textContent = status ? `${hh}:${mm}ï½œ${status}` : `${hh}:${mm}`;
          div.appendChild(timeText);

          if ((viewMode === "team" || viewMode === "admin") && record.å›å ±è€…) {
            const nameSpan = document.createElement("span");
            nameSpan.textContent = `ï½œ${record.å›å ±è€…}`;
            div.appendChild(nameSpan);
          }

          if (isAbnormal) {
            const dot = document.createElement("span");
            dot.className = "status-dot";
            div.appendChild(dot);
          }

          div.onclick = () => openDetail(record.è©³ç´°ç´€éŒ„);
          dayContent.appendChild(div);
        });
        monthContent.appendChild(dayBlock);
      });
      yearContent.appendChild(monthBlock);
    });
    container.appendChild(yearBlock);
  });

  // 4. é¡¯ç¤ºçµæœä¸¦æ”¶å°¾
  if (mask) mask.style.display = "none";
  if (spinner) spinner.style.display = "none";
  container.style.display = "block";

  updateSwitchUI();
  document.getElementById("pageTitle").style.display = "block";

  // ç¬¬ä¸€æ¬¡é€²å…¥æ™‚æ‰æ¢å¾©æ²å‹•ä½ç½®
  if (!restoredOnce) {
    setTimeout(() => {
      restoreListState();
      restoredOnce = true;
    }, 50);
  }

  isInitialLoad = false;
  document.body.classList.remove("loading");
  debug("STEP3 å®Œæˆï¼šåˆ—è¡¨æ¸²æŸ“æˆåŠŸï¼Œå·²è‡ªå‹•å±•é–‹æœ€è¿‘3å¤©è³‡æ–™");
}

function saveListState() {
  // å–å¾—æ‰€æœ‰å±•é–‹çš„å€å¡Š
  const opened = [];

  document.querySelectorAll(".year-block, .month-block, .day-block").forEach(block => {
    const content = block.querySelector(".content");
    if (content && content.style.display === "block") {
      opened.push(block.querySelector(".header span").textContent.trim());
    }
  });

  const state = {
    openedBlocks: opened,
    scroll: window.scrollY
  };

  localStorage.setItem("cleanListState", JSON.stringify(state));
}

function restoreListState() {
  const cache = localStorage.getItem("cleanListState");
  if (!cache) return;

  const state = JSON.parse(cache);
  const opened = state.openedBlocks || [];

  // æ¢å¾©å±•é–‹
  opened.forEach(text => {
    const headers = document.querySelectorAll(".header span");
    headers.forEach(h => {
      if (h.textContent.trim() === text) {
        const block = h.closest(".year-block, .month-block, .day-block");
        const content = block.querySelector(".content");
        const icon = block.querySelector(".toggle-icon");

        content.style.display = "block";
        icon.innerHTML = `
          <svg width="40" height="40" viewBox="0 0 24 24">
            <path fill="#666" d="M5 16l7-8 7 8z"/>
          </svg>`;
      }
    });
  });

  // æ¢å¾©æ²å‹•ä½ç½®
  setTimeout(() => {
    window.scrollTo(0, state.scroll || 0);
  }, 10);
}

  /* ------------------------------------------
      5. å·¥å…·ï¼šå»ºç«‹å¯æ”¶åˆå€å¡Š
  -------------------------------------------*/
  function createBlock(title, level) {
  const block = document.createElement("div");
  block.className = level + "-block";

  const header = document.createElement("div");
  header.className = "header";

  const titleSpan = document.createElement("span");
  titleSpan.textContent = title;

  // â–¼ï¼ˆé è¨­æ”¶èµ·ç”¨ï¼‰
  const icon = document.createElement("span");
  icon.className = "toggle-icon";
  icon.innerHTML = `
  <svg width="40" height="40" viewBox="0 0 24 24">
    <path fill="#666" d="M5 8l7 8 7-8z"/>
  </svg>
`;

  const content = document.createElement("div");
  content.className = "content";
  content.style.display = "none";

  header.appendChild(titleSpan);
  header.appendChild(icon);

  header.onclick = () => {
  const willOpen = content.style.display !== "block";

  content.style.display = willOpen ? "block" : "none";

  icon.innerHTML = willOpen
    ? `<svg width="40" height="40" viewBox="0 0 24 24">
         <path fill="#666" d="M5 16l7-8 7 8z"/>  <!-- å‘ä¸Š -->
       </svg>`
    : `<svg width="40" height="40" viewBox="0 0 24 24">
         <path fill="#666" d="M5 8l7 8 7-8z"/>  <!-- å‘ä¸‹ -->
       </svg>`;
};

  block.appendChild(header);
  block.appendChild(content);

  return block;
}

document.getElementById("btnSelf").onclick = function () {
  viewMode = "self";
  
  // ç«‹å³æ›´æ–°æŒ‰éˆ•æ¨£å¼
  updateSwitchUI();
  
  // éš±è—ç®¡ç†å“¡ç¯©é¸å€åŸŸ
  document.getElementById("adminFilterArea").style.display = "none";

  // é¡¯ç¤ºè¼‰å…¥ä¸­
  renderLoadingInList();
  
  // è¼‰å…¥å€‹äººç´€éŒ„
  loadRecordList("self");
};

document.getElementById("btnTeam").onclick = async function () {
  // å¤§éšŠé•· â†’ è®€è‡ªå·±çš„å¤§éšŠ
  if (globalRole === "å¤§éšŠé•·") {
    viewMode = "team";
    updateSwitchUI(); // ç«‹å³æ›´æ–°æŒ‰éˆ•æ¨£å¼
    document.getElementById("adminFilterArea").style.display = "none";
    renderLoadingInList();
    loadRecordList("team");
    return;
  }

  // ç®¡ç†å“¡ â†’ Admin æ¨¡å¼
  if (globalRole === "ç®¡ç†å“¡") {
    viewMode = "admin";
    updateSwitchUI(); // ç«‹å³æ›´æ–°æŒ‰éˆ•æ¨£å¼
    renderLoadingInList();

    // å¦‚æœé‚„æ²’æœ‰ç®¡ç†å“¡è³‡æ–™ï¼Œå…ˆè¼‰å…¥
    if (globalAdminRecords.length === 0) {
      await loadAdminRecords();
    } else {
      // å¦‚æœå·²ç¶“æœ‰è³‡æ–™ï¼Œç›´æ¥é¡¯ç¤ºç¯©é¸å’Œæ¸²æŸ“
      document.getElementById("adminFilterArea").style.display = "block";
      const filtered = filterAdminRecords();
      renderList(filtered);
    }
  }
};

document.getElementById("adminSearchBtn").onclick = () => {
  if (viewMode !== "admin") return;

  // é¡¯ç¤ºè¼‰å…¥ä¸­
  renderLoadingInList();

  // ä½¿ç”¨ç¾æœ‰è³‡æ–™é€²è¡Œå‰ç«¯ç¯©é¸
  setTimeout(() => {
    const filtered = filterAdminRecords();
    renderList(filtered);
  }, 100); // ç¨å¾®å»¶é²è®“è¼‰å…¥å‹•ç•«é¡¯ç¤º
};

  document.getElementById("adminExportBtn").onclick = () => {
  // å‘¼å«æˆ‘å€‘å®šç¾©å¥½çš„å ±è¡¨ç”¢å‡ºå‡½å¼
  exportReport(); 
};

function exportReport() {
    const filteredData = filterAdminRecords();
    
    if (filteredData.length === 0) {
        showMessage("ç›®å‰ç¯©é¸æ¢ä»¶ä¸‹ç„¡è³‡æ–™å¯ç”¢å‡ºå ±è¡¨");
        return;
    }

    const isMobile = window.innerWidth < 769;
    
    // éš±è—å°åœ“éˆ•
    const fb = document.getElementById("floatingButtons");
    if (fb) fb.style.setProperty("display", "none", "important");

    // æ””æˆªè¿”å›éµ
    history.pushState({ action: "closeReport" }, "");
    window.onpopstate = function() {
        if (document.getElementById("reportOverlay")) closeReportLayer();
    };

    let tableRows = "";
    filteredData.forEach(r => {
        let hh = "--", mm = "--";
        try {
            const match = r.è©³ç´°ç´€éŒ„.match(/report_(\d+)/);
            if (match) {
                const dateObj = new Date(parseInt(match[1], 10));
                hh = String(dateObj.getHours()).padStart(2, "0");
                mm = String(dateObj.getMinutes()).padStart(2, "0");
            }
        } catch(e) {}

        const note = (r.èªªæ˜ || "").trim();
        const voice = (r.èªéŸ³è½‰æ–‡å­— || "").trim();
        let combinedNote = (note && voice) ? `${note} / ${voice}` : (note || voice);

        let reporterInfo = (r.å›å ±è€… || "").trim();
        if (r.åŒè¡Œè€… && r.åŒè¡Œè€….trim() !== "") {
            reporterInfo += `,${r.åŒè¡Œè€….trim()}`;
        }

        const detailLink = `<a href="${r.è©³ç´°ç´€éŒ„}" target="_blank" style="color: #0b5ed7; text-decoration: underline;">é€£çµ</a>`;

        tableRows += `
            <tr>
                <td>${normalizeDate(r.æ—¥æœŸ)}</td>
                <td>${hh}:${mm}</td>
                <td>${r.é€šå ±é¡å‹ || ''}</td>
                <td style="color: ${r.ç‹€æ…‹ === 'ç•°å¸¸' ? 'red' : 'black'}; font-weight: ${r.ç‹€æ…‹ === 'ç•°å¸¸' ? 'bold' : 'normal'}">${r.ç‹€æ…‹ || ''}</td>
                <td>${r.ç•°å¸¸åˆ†é¡ || ''}</td>
                <td style="text-align:center;">${detailLink}</td>
                <td>${combinedNote}</td>
                <td>${reporterInfo}</td>
                <td>${r.æ‰€å±¬å¤§éšŠ || ''}</td>
            </tr>
        `;
    });

    const reportHtml = `
        <div id="reportOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background: ${isMobile ? 'white' : 'rgba(0,0,0,0.6)'}; z-index: 9995; display: flex; justify-content: center; align-items: flex-start; font-family:sans-serif;">
            <div id="reportContent" style="background: white; width: ${isMobile ? '100%' : '95%'}; height: ${isMobile ? 'calc(100% - 70px)' : '90vh'}; margin-top: ${isMobile ? '0' : '3vh'}; padding: ${isMobile ? '15px' : '30px'}; box-sizing: border-box; overflow-y: auto; box-shadow: ${isMobile ? 'none' : '0 10px 40px rgba(0,0,0,0.4)'}; border-radius: ${isMobile ? '0' : '10px'}; position: relative;">
                
                <div class="no-print" style="display: ${isMobile ? 'none' : 'flex'}; justify-content: space-between; margin-bottom: 20px;">
                    <button onclick="downloadExcelWithMsg()" style="padding: 10px 20px; background: #198754; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ“Š åŒ¯å‡ºç‚º Excel æª”</button>
                    <button onclick="closeReportLayer()" style="padding: 10px 20px; background: #f8f9fa; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; font-weight: bold;">âœ• é—œé–‰è¦–çª—</button>
                </div>
                
                <h2 style="text-align:center; margin-bottom:10px; font-size: 24px;">å·¡è¦–ç´€éŒ„æ˜ç´°å ±è¡¨</h2>
                
                <table id="targetTable" style="width:100%; border-collapse:collapse; font-size:13px; line-height: 1.5;">
                    <thead>
                        <tr style="background:#f2f2f2;">
                            <th style="border:1px solid #ccc; padding:10px; text-align: left;">æ—¥æœŸ</th>
                            <th style="border:1px solid #ccc; padding:10px; text-align: left;">æ™‚é–“</th>
                            <th style="border:1px solid #ccc; padding:10px; text-align: left;">é€šå ±é¡å‹</th>
                            <th style="border:1px solid #ccc; padding:10px; text-align: left;">ç‹€æ…‹</th>
                            <th style="border:1px solid #ccc; padding:10px; text-align: left;">ç•°å¸¸åˆ†é¡</th>
                            <th style="border:1px solid #ccc; padding:10px; text-align: left;">è©³ç´°ç´€éŒ„</th>
                            <th style="border:1px solid #ccc; padding:10px; text-align: left;">èªªæ˜ / èªéŸ³è½‰æ–‡å­—</th>
                            <th style="border:1px solid #ccc; padding:10px; text-align: left;">å›å ±è€…</th>
                            <th style="border:1px solid #ccc; padding:10px; text-align: left;">å¤§éšŠ</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
                <div style="margin-top:20px; text-align:right; font-weight:bold; font-size: 15px;">è³‡æ–™ç¸½è¨ˆï¼š${filteredData.length} ç­†</div>
            </div>
            <style>
                tr:nth-child(even) { background-color: #fafafa; }
                td { border:1px solid #ccc; padding:10px; text-align: left; word-break: break-all; }
            </style>
        </div>
    `;

    const div = document.createElement('div');
    div.innerHTML = reportHtml;
    document.body.appendChild(div.firstElementChild);
}

  function downloadExcelWithMsg() {
    downloadExcelFinal();
}

function downloadExcelFinal() {
  if (typeof XLSX === 'undefined') {
    const script = document.createElement('script');
    script.src = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js";
    script.onload = () => executeDownload();
    document.head.appendChild(script);
  } else {
    executeDownload();
  }

  function executeDownload() {
    const table = document.getElementById("targetTable");
    if (!table) return;

    const rows = Array.from(table.querySelectorAll("tr"));
    const allHeaders = Array.from(rows[0].querySelectorAll("th")).map(th => th.innerText.trim());
    
    // æ’é™¤ã€Œè©³ç´°ç´€éŒ„ã€
    const targetHeaderIndices = [];
    const finalHeaders = [];
    allHeaders.forEach((h, idx) => {
      if (h !== "è©³ç´°ç´€éŒ„") {
        targetHeaderIndices.push(idx);
        finalHeaders.push(h);
      }
    });

    const excelData = [];
    for (let i = 1; i < rows.length; i++) {
      const cells = Array.from(rows[i].querySelectorAll("td"));
      const rowData = {};
      targetHeaderIndices.forEach((colIdx, headerIdx) => {
        const headerName = finalHeaders[headerIdx];
        rowData[headerName] = cells[colIdx] ? cells[colIdx].innerText.trim() : "";
      });
      excelData.push(rowData);
    }

    const worksheet = XLSX.utils.json_to_sheet(excelData);

    // --- [é—œéµ] æ¬„å¯¬æ§åˆ¶é‚è¼¯ ---
    const colWidths = finalHeaders.map(header => {
      // 1. éœ€è¦ã€è‡ªå‹•å¾®èª¿ã€‘çš„æ¬„ä½
      if (header === "æ—¥æœŸ" || header === "é€šå ±é¡å‹" || header === "ç•°å¸¸åˆ†é¡") {
        const maxLength = excelData.reduce((max, row) => {
          const val = row[header] ? row[header].toString() : "";
          // è¨ˆç®—ä¸­æ–‡å­—é•·åº¦ (ä¸­æ–‡å­—ç®— 2 å–®ä½)
          const len = val.split('').reduce((acc, char) => acc + (char.charCodeAt(0) > 255 ? 2 : 1), 0);
          return Math.max(max, len);
        }, header.length * 2);
        return { wch: maxLength + 2 }; 
      } 
      // 2. ç¶­æŒã€é è¨­æ¬„å¯¬ã€‘çš„æ¬„ä½ (æ™‚é–“ã€ç‹€æ…‹ã€èªªæ˜ã€å›å ±è€…ã€å¤§éšŠ)
      else {
        return { wch: 10 }; // Excel çš„æ¨™æº–é è¨­å¯¬åº¦ç´„ç‚º 8.43 åˆ° 10
      }
    });
    worksheet['!cols'] = colWidths;

    // --- [é—œéµ] æ ¼å¼åŒ–èˆ‡æ™‚é–“é–å®š ---
    Object.keys(worksheet).forEach(key => {
      if (key[0] === '!') return;
      
      // å¼·åˆ¶æ‰€æœ‰å„²å­˜æ ¼ç‚ºå­—ä¸² (é¿å…æ™‚é–“åç§»ã€é¿å…æ—¥æœŸè¢«æ”¹æ ¼å¼)
      worksheet[key].t = 's'; 
      worksheet[key].z = '@'; 

      // å˜—è©¦é€éå±¬æ€§ç¾åŒ– (éƒ¨åˆ† Excel ç‰ˆæœ¬æœƒç¹¼æ‰¿æ ¼å¼)
      if (!worksheet[key].s) worksheet[key].s = {};
      worksheet[key].s = {
        font: { name: "å¾®è»Ÿæ­£é»‘é«”", sz: 11 },
        alignment: { vertical: "center", horizontal: "left" }
      };
    });

    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "å·¡è¦–ç´€éŒ„");
    XLSX.writeFile(workbook, `å·¡è¦–ç´€éŒ„_${new Date().toISOString().slice(0, 10)}.xlsx`);
  }
}
  
function showMessage(text, onConfirm) {
  document.getElementById("customModal")?.remove();
  const overlay = document.createElement("div");
  overlay.id = "customModal";
  Object.assign(overlay.style, {
    position: "fixed",
    inset: "0",
    background: "rgba(0,0,0,0.6)",
    display: "flex",
    alignItems: "center",
    justifyContent: "center",
    zIndex: "9999",
  });
  const box = document.createElement("div");
  Object.assign(box.style, {
    background: "#fff",
    color: "#000",
    borderRadius: "12px",
    padding: "30px 40px",
    fontSize: "22px",
    textAlign: "center",
    maxWidth: "80%",
    boxShadow: "0 4px 20px rgba(0,0,0,0.3)",
  });
  box.innerHTML = text;

  const btn = document.createElement("button");
  btn.textContent = "ç¢ºå®š";
  Object.assign(btn.style, {
    marginTop: "24px",
    fontSize: "20px",
    padding: "10px 28px",
    borderRadius: "8px",
    border: "none",
    background: "#0b5ed7",
    color: "#fff",
  });

  // â† åªæ”¹é€™æ®µï¼šå…ˆç§»é™¤è¦–çª—ï¼Œé€£çºŒå…©æ¬¡ rAF ç¢ºä¿å®Œæˆé‡ç¹ªï¼Œå†åŸ·è¡Œ onConfirmï¼ˆé–‹ç›¸ç°¿ï¼‰
  btn.onclick = () => {
    overlay.remove();
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        if (typeof onConfirm === "function") onConfirm();
      });
    });
  };

  box.appendChild(document.createElement("br"));
  box.appendChild(btn);
  overlay.appendChild(box);
  document.body.appendChild(overlay);
}

// å°ˆå±¬é—œé–‰å‡½å¼
function closeReportLayer() {
    const overlay = document.getElementById("reportOverlay");
    if (overlay) {
        overlay.remove();
        const fb = document.getElementById("floatingButtons");
        if (fb && window.innerWidth >= 769) {
            fb.style.setProperty("display", "flex", "important");
        }
        if (history.state && history.state.action === "closeReport") {
            history.back();
        }
    }
}

// å°ˆç”¨çš„è§¸ç™¼åˆ—å°å‡½å¼
function triggerPrint() {
    try {
        window.print();
    } catch (e) {
        alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç›´æ¥åˆ—å°ï¼Œè«‹é»é¸ç€è¦½å™¨é¸å–®ä¸­çš„ã€Œåˆ—å°/åˆ†äº«ã€æŒ‰éˆ•ã€‚");
    }
}
  
// æŒ‰éˆ•è¦–è¦ºåˆ‡æ›
function updateSwitchUI() {
  const btnSelf = document.getElementById("btnSelf");
  const btnTeam = document.getElementById("btnTeam");

  // é‡ç½®æ‰€æœ‰æŒ‰éˆ•æ¨£å¼
  btnSelf.style.background = "white";
  btnSelf.style.color = "#0b5ed7";
  btnTeam.style.background = "white";
  btnTeam.style.color = "#0b5ed7";

  // æ ¹æ“šç•¶å‰æ¨¡å¼è¨­å®šæ¿€æ´»ç‹€æ…‹
  if (viewMode === "self") {
    btnSelf.style.background = "#0b5ed7";
    btnSelf.style.color = "white";
  } else if (viewMode === "team" || viewMode === "admin") {
    btnTeam.style.background = "#0b5ed7";
    btnTeam.style.color = "white";
  }

  // â˜…â˜…â˜… åœ¨é€™è£¡åŠ å…¥å³å¯ â˜…â˜…â˜…
  applyAdminButtonFix();
}

function applyAdminButtonFix() {
  const btnSelf = document.getElementById("btnSelf");

  // åªåœ¨ã€Œç®¡ç†å“¡ + admin æ¨¡å¼ã€ä¸‹å•Ÿå‹•
  if (globalRole === "ç®¡ç†å“¡" && viewMode === "admin") {

    // æŒ‰éˆ•æ–‡å­—
    btnSelf.textContent = "æ­·å²å ±è¡¨";

    // ----- æœªé¸ä¸­ç‹€æ…‹ï¼ˆç™½åº•ç¶ æ¡†ï¼‰ -----
    btnSelf.style.background = "white";
    btnSelf.style.color = "#28a745";
    btnSelf.style.border = "2px solid #28a745";

    // hoverï¼ˆé‚„æ˜¯ç™½åº•ï¼Œåªæ˜¯é¡è‰²å¾®è®Šï¼‰
    btnSelf.onmouseover = () => {
      btnSelf.style.background = "#f1fdf1";
    };
    btnSelf.onmouseout = () => {
      // è‹¥ç›®å‰ä»æœªé¸ä¸­ â†’ å›åˆ°ç™½åº•ç¶ å­—
      if (viewMode === "admin") {
        btnSelf.style.background = "white";
        btnSelf.style.color = "#28a745";
      }
    };

    // ----- é»æ“Šå¾Œè®Šæˆé¸ä¸­ç‹€æ…‹ï¼ˆç¶ åº•ç™½å­—ï¼‰ -----
    btnSelf.onclick = () => {
      // ç¶ åº•ç™½å­—
      btnSelf.style.background = "#28a745";
      btnSelf.style.color = "white";

      // ç«‹å³é–‹å•Ÿæ­·å²å ±è¡¨
      window.open(
        "https://docs.google.com/spreadsheets/d/1GEjlfTy73kgZnMYrM0AHjnYIs1EPLIOQLCqsEE8BMAw/edit?gid=0#gid=0",
        "_blank"
      );
    };
  }
}

function showLoadingMask() {
  document.getElementById("loadingMask").style.display = "flex";
}

function renderLoadingInList() {
  const container = document.getElementById("listContainer");
  const spinner = document.getElementById("centerSpinner");

  container.style.display = "none";
  spinner.style.display = "flex";

  // ä¸è¦é¡¯ç¤ºå¤§é®ç½©
  document.getElementById("loadingMask").style.display = "none";
}

// æŸ¥çœ‹å®Œæ•´ç´€éŒ„æŒ‰éˆ•äº‹ä»¶
/*document.getElementById("viewFullRecords").onclick = function() {
  window.open("https://docs.google.com/spreadsheets/d/1GEjlfTy73kgZnMYrM0AHjnYIs1EPLIOQLCqsEE8BMAw/edit?gid=0#gid=0", "_blank");
};*/

// å½ˆçª—è³‡æ–™è¡¨
const dropdownData = {
  team: {
    title: "é¸æ“‡å¤§éšŠ",
    target: "teamText",
    input: "adminTeamSelect",
    options: [
      {value:"å…¨éƒ¨", text:"å…¨éƒ¨"},
      {value:"1", text:"ç¬¬1å¤§éšŠ"},
      {value:"2", text:"ç¬¬2å¤§éšŠ"},
      {value:"3", text:"ç¬¬3å¤§éšŠ"},
      {value:"4", text:"ç¬¬4å¤§éšŠ"},
      {value:"5", text:"ç¬¬5å¤§éšŠ"},
      {value:"6", text:"ç¬¬6å¤§éšŠ"},
      {value:"7", text:"ç¬¬7å¤§éšŠ"},
      {value:"8", text:"ç¬¬8å¤§éšŠ"},
      {value:"9", text:"ç¬¬9å¤§éšŠ"},
      {value:"10", text:"ç¬¬10å¤§éšŠ"},
    ]
  },

  range: {
    title: "é¸æ“‡ç¯„åœ",
    target: "rangeText",
    input: "adminDayRange",
    options: [
      {value:"3", text:"æœ€è¿‘ 3 å¤©"},
      {value:"7", text:"æœ€è¿‘ 7 å¤©"},
      {value:"14", text:"æœ€è¿‘ 14 å¤©"}
    ]
  },

  type: {
    title: "é¸æ“‡é¡å‹",
    target: "typeText",
    input: "adminTypeSelect",
    options: [
      {value:"å…¨éƒ¨", text:"å…¨éƒ¨"},
      {value:"å¹³æ™‚", text:"å¹³æ™‚"},
      {value:"ç½ä¸­", text:"ç½ä¸­"},
      {value:"å…¶ä»–", text:"å…¶ä»–"}
    ]
  },

  timeStart: {
    title: "é–‹å§‹æ™‚é–“",
    target: "timeStartText",
    input: "timeStart",
    options: Array.from({length:24}).map((_,i)=>({
      value: `${String(i).padStart(2,'0')}:00`,
      text: `${String(i).padStart(2,'0')}:00`
    }))
  },

  timeEnd: {
    title: "çµæŸæ™‚é–“",
    target: "timeEndText",
    input: "timeEnd",
    options: Array.from({length:24}).map((_,i)=>({
      value: `${String(i).padStart(2,'0')}:59`,
      text: `${String(i).padStart(2,'0')}:59`
    }))
  }
};

const mask = document.getElementById("fullDropdownMask");
let maskOriginalParent = null;

function openDropdown(type){
  //document.getElementById("globalFooter").style.visibility = "hidden";

  const info = dropdownData[type];
  if (!info) return;

  document.getElementById("panelTitle").textContent = info.title;

  const box = document.getElementById("panelOptions");
  box.innerHTML = "";

  const currentSelected = document.getElementById(info.input).value;

  info.options.forEach(opt => {
    const div = document.createElement("div");
    div.className = "option";
    div.textContent = opt.text;

    if (opt.value == currentSelected) div.classList.add("selected");

    div.onclick = () => {
      document.getElementById(info.target).textContent = opt.text;
      document.getElementById(info.input).value = opt.value;

      document.querySelectorAll(".option").forEach(o => o.classList.remove("selected"));
      div.classList.add("selected");

      setTimeout(() => closeDropdown(), 180);
    };

    box.appendChild(div);
  });

  // â˜… é®ç½©ä¸è¦ç§»å‹•ï¼Œåªè¦é¡¯ç¤ºå³å¯
  document.getElementById("fullDropdownMask").style.display = "flex";

  lockBodyScroll();
}


function closeDropdown(){
  document.getElementById("fullDropdownMask").style.display = "none";

  unlockBodyScroll();

  //document.getElementById("globalFooter").style.visibility = "visible";
}

/* é»é»‘åº•é—œé–‰ */
document.getElementById("fullDropdownMask").addEventListener("click", function(e){
  if (e.target.id === "fullDropdownMask") closeDropdown();
});

let scrollTopCache = 0;

function lockBodyScroll() {
  // è¨˜éŒ„ç•¶å‰æ²å‹•ä½ç½®
  scrollTopCache = window.scrollY || document.documentElement.scrollTop;

  // ç›´æ¥é–ä½ htmlï¼Œä¸å‹• bodyï¼ˆé¿å…æ•´é«”ä½ç§»ï¼‰
  document.documentElement.style.overflow = "hidden";
  document.documentElement.style.height = "100%";
}

function unlockBodyScroll() {
  // è§£é– html
  document.documentElement.style.overflow = "";
  document.documentElement.style.height = "";

  // å›åˆ°åŸæœ¬æ²å‹•ä½ç½®
  window.scrollTo(0, scrollTopCache);
}

  /*
alert("adminTeamSelect:", document.getElementById("adminTeamSelect"));
alert("viewFullRecords:", document.getElementById("viewFullRecords"));
alert("fullDropdownMask:", document.getElementById("fullDropdownMask"));
*/

function handleClosePage() {
  window.location.href = "/home";  // æ›¿æ›æˆä½ çš„ä¸»é¸å–®é 
}

/* ===== é›»è…¦ç‰ˆè‡ªå‹•é€²å…¥å¡ç‰‡æ¨¡å¼ ===== */
document.addEventListener("DOMContentLoaded", () => {
  if (window.innerWidth >= 769) {
    document.body.classList.add("desktop-card-mode");
  }
});

  // å•Ÿå‹• floating åœ“éˆ•ï¼ˆåªåœ¨é›»è…¦ç‰ˆï¼‰
document.addEventListener("DOMContentLoaded", () => {
  if (window.innerWidth >= 769) {
    document.getElementById("floatingButtons").style.display = "flex";
  }
});

// é›»è…¦ / æ‰‹æ©Ÿ æŸ¥çœ‹ç…§ç‰‡ â†’ éš±è—åœ“éˆ• ï¼‹ éš±è— footer
window.addEventListener("message", (e) => {
    const isDesktop = window.innerWidth >= 769;

    // === æŸ¥çœ‹ç…§ç‰‡ (PHOTO_OPEN) ===
    if (e.data.action === "PHOTO_OPEN") {
        if (!isDesktop) { /* è™•ç†æ‰‹æ©Ÿæ¿ Footer å’Œ iFrame */ }

        // è™•ç†é›»è…¦åœ“éˆ•ï¼šç›´æ¥åœ¨ body ä¸ŠåŠ  Class
        if (isDesktop) {
            document.body.classList.add("photo-open-detail");
        }
    }

    // === é—œé–‰ç…§ç‰‡ (PHOTO_CLOSE) ===
    if (e.data.action === "PHOTO_CLOSE") {
        if (!isDesktop) { /* è™•ç†æ‰‹æ©Ÿæ¿ Footer å’Œ iFrame */ }

        // è™•ç†é›»è…¦åœ“éˆ•ï¼šç§»é™¤ Class
        if (isDesktop) {
            document.body.classList.remove("photo-open-detail");
        }
    }
});

  // å•Ÿå‹•åœ“éˆ•ï¼ˆé›»è…¦ç‰ˆï¼‰
document.addEventListener("DOMContentLoaded", () => {
  if (window.innerWidth >= 769) {
    document.getElementById("floatingButtons").style.display = "flex";
  }
});
  
</script>

</body>
</html> 
